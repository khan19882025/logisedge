{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block title %}{{ title|default:"Invoice" }} - LogisEdge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invoice/invoice.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-receipt"></i> {{ title|default:"Invoice" }}
                    </h4>
                    <a href="{% url 'invoice:invoice_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to List
                    </a>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information
                                </h5>
                                <div class="row">
                                    <!-- Left Column -->
                                    <div class="col-md-6">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.invoice_number.id_for_label }}" class="form-label mb-0">
                                                            Invoice No <span class="text-danger">*</span>
                                                        </label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.invoice_number }}
                                                        <small class="form-text text-muted">Auto-generated: INV-2025-0001</small>
                                                        {% if form.invoice_number.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.invoice_number.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12" id="customer-field-container">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.customer.id_for_label }}" class="form-label mb-0">
                                                            Customer Name <span class="text-danger">*</span>
                                                        </label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.customer }}
                                                        {% if form.customer.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.customer.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.bill_to.id_for_label }}" class="form-label mb-0">Bill To</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.bill_to }}
                                                        {% if form.bill_to.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.bill_to.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-start">
                                                    <div class="col-4">
                                                        <label for="{{ form.bill_to_address.id_for_label }}" class="form-label mb-0">Bill to Address</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.bill_to_address }}
                                                        {% if form.bill_to_address.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.bill_to_address.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-start">
                                                    <div class="col-4">
                                                        <label class="form-label mb-0">Job No (Multiple)</label>
                                                    </div>
                                                    <div class="col-8">
                                                        <div id="jobs-container" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                                            <p class="text-muted">Please select a customer to see available jobs.</p>
                                                        </div>
                                                        <!-- Hidden input to store selected job IDs -->
                                                        <input type="hidden" name="jobs" id="selected-jobs-input" value="">
                                                        <small class="text-muted">Select multiple jobs by checking the boxes. BL, ED, CNTR, Items (names), Origin, Destination, Shipper, and Consignee will be auto-populated.</small>
                                                        {% if form.jobs.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.jobs.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.shipper.id_for_label }}" class="form-label mb-0">Shipper</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.shipper }}
                                                        {% if form.shipper.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.shipper.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.consignee.id_for_label }}" class="form-label mb-0">Consignee</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.consignee }}
                                                        {% if form.consignee.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.consignee.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Column -->
                                    <div class="col-md-6">
                                        <div class="row g-3">
                                            <!-- Date, Origin, Destination on same line -->
                                            <div class="col-12">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <div class="row align-items-center">
                                                            <div class="col-4">
                                                                <label for="{{ form.invoice_date.id_for_label }}" class="form-label mb-0">
                                                                    Date <span class="text-danger">*</span>
                                                                </label>
                                                            </div>
                                                            <div class="col-8">
                                                                {{ form.invoice_date }}
                                                                {% if form.invoice_date.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {{ form.invoice_date.errors.0 }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="row align-items-center">
                                                            <div class="col-4">
                                                                <label for="{{ form.origin.id_for_label }}" class="form-label mb-0">Origin</label>
                                                            </div>
                                                            <div class="col-8">
                                                                {{ form.origin }}
                                                                {% if form.origin.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {{ form.origin.errors.0 }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="row align-items-center">
                                                            <div class="col-4">
                                                                <label for="{{ form.destination.id_for_label }}" class="form-label mb-0">Destination</label>
                                                            </div>
                                                            <div class="col-8">
                                                                {{ form.destination }}
                                                                {% if form.destination.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {{ form.destination.errors.0 }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.bl_number.id_for_label }}" class="form-label mb-0">BL</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.bl_number }}
                                                        {% if form.bl_number.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.bl_number.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.ed_number.id_for_label }}" class="form-label mb-0">ED</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.ed_number }}
                                                        {% if form.ed_number.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.ed_number.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.container_number.id_for_label }}" class="form-label mb-0">CNTR</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.container_number }}
                                                        {% if form.container_number.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.container_number.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.items_count.id_for_label }}" class="form-label mb-0">Items</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.items_count }}
                                                        {% if form.items_count.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.items_count.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.total_qty.id_for_label }}" class="form-label mb-0">Total Qty</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.total_qty }}
                                                        <small class="form-text text-muted">Auto-calculated from selected jobs</small>
                                                        {% if form.total_qty.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.total_qty.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <label for="{{ form.delivery_order.id_for_label }}" class="form-label mb-0">Delivery Order</label>
                                    </div>
                                    <div class="col-8">
                                        {{ form.delivery_order }}
                                        {% if form.delivery_order.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.delivery_order.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-center">
                                                    <div class="col-4">
                                                        <label for="{{ form.status.id_for_label }}" class="form-label mb-0">Status</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.status }}
                                                        {% if form.status.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.status.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="row align-items-start">
                                                    <div class="col-4">
                                                        <label for="{{ form.notes.id_for_label }}" class="form-label mb-0">Remark</label>
                                                    </div>
                                                    <div class="col-8">
                                                        {{ form.notes }}
                                                        {% if form.notes.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {{ form.notes.errors.0 }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Items Table -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-list-ul me-2"></i>Invoice Items
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="invoice-items-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">Sr No</th>
                                                <th width="15%">Description</th>
                                                <th colspan="6" class="text-center">Cost</th>
                                                <th colspan="5" class="text-center">Sale</th>
                                                <th width="10%">Remark</th>
                                                <th width="5%">Action</th>
                                            </tr>
                                            <tr>
                                                <th></th>
                                                <th></th>
                                                <th width="8%">Qty</th>
                                                <th width="8%">Rate</th>
                                                <th width="8%">Amount</th>
                                                <th width="8%">VAT</th>
                                                <th width="8%">T-Amount</th>
                                                <th width="8%">Payable</th>
                                                <th width="8%">Qty</th>
                                                <th width="8%">Rate</th>
                                                <th width="8%">Amount</th>
                                                <th width="8%">VAT</th>
                                                <th width="8%">T-Amount</th>
                                                <th></th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoice-items-tbody">
                                            <!-- Items will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <button type="button" class="btn btn-success" id="add-item-btn">
                                        <i class="bi bi-plus-circle me-2"></i>Add Item
                                    </button>
                                    <div class="d-flex gap-3">
                                        <div class="text-end">
                                            <strong>Total Cost: <span id="total-cost">AED 0.00</span></strong>
                                        </div>
                                        <div class="text-end">
                                            <strong>Total Sale: <span id="total-sale">AED 0.00</span></strong>
                                        </div>
                                        <div class="text-end">
                                            <strong>Profit: <span id="total-profit">AED 0.00</span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <!-- Hidden field for invoice items data -->
                                {{ form.invoice_items }}
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{% url 'invoice:invoice_list' %}" class="btn btn-secondary">
                                        <i class="bi bi-x-circle me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-2"></i>Save Invoice
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/invoice/invoice.js' %}?v=1.4"></script>
<script>
// Simple job loading integration with existing invoice.js
document.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.querySelector('select[name="customer"]');
    const jobsContainer = document.getElementById('jobs-container');
    
    function loadJobsForCustomer(customerId) {
        if (!customerId) {
            jobsContainer.innerHTML = '<p class="text-muted">Please select a customer to see available jobs.</p>';
            return;
        }
        
        // Fetch jobs for the selected customer that don't have invoices
        fetch(`/invoicing/invoice/ajax/get-customer-jobs/?customer_id=${customerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.jobs && data.jobs.length > 0) {
                    // Create job checkboxes
                    let jobsHTML = '';
                    data.jobs.forEach(job => {
                        jobsHTML += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="jobs" value="${job.id}" id="job_${job.id}">
                                <label class="form-check-label" for="job_${job.id}">
                                    ${job.job_code} - ${job.description || 'No description'}
                                </label>
                            </div>
                        `;
                    });
                    jobsContainer.innerHTML = jobsHTML;
                    
                    // Add event listeners to new checkboxes
                    const jobCheckboxes = jobsContainer.querySelectorAll('input[name="jobs"]');
                    jobCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            // Auto-populate fields when jobs are selected
                            if (this.checked) {
                                populateFieldsFromJob(this.value);
                            }
                            
                            // Update the hidden input with selected job IDs
                            updateSelectedJobsInput();
                        });
                    });
                } else {
                    jobsContainer.innerHTML = '<p class="text-muted">No available jobs found for this customer.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading jobs:', error);
                jobsContainer.innerHTML = '<p class="text-danger">Error loading jobs. Please try again.</p>';
            });
    }
    
    function populateFieldsFromJob(jobId) {
        // Fetch job details and auto-populate fields
        fetch(`/invoicing/invoice/ajax/get-job-details/?job_id=${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.bl_number) document.querySelector('input[name="bl_number"]').value = data.bl_number;
                if (data.shipper) document.querySelector('input[name="shipper"]').value = data.shipper;
                if (data.consignee) document.querySelector('input[name="consignee"]').value = data.consignee;
                if (data.origin) document.querySelector('input[name="origin"]').value = data.origin;
                if (data.destination) document.querySelector('input[name="destination"]').value = data.destination;
                if (data.ed_number) document.querySelector('input[name="ed_number"]').value = data.ed_number;
                if (data.container_number) document.querySelector('input[name="container_number"]').value = data.container_number;
                if (data.items) document.querySelector('input[name="items_count"]').value = data.items;
                if (data.total_qty) document.querySelector('input[name="total_qty"]').value = data.total_qty;
            })
            .catch(error => {
                console.error('Error loading job details:', error);
            });
    }
    
    function updateSelectedJobsInput() {
        // Get all selected job checkboxes
        const selectedJobs = jobsContainer.querySelectorAll('input[name="jobs"]:checked');
        const selectedJobIds = Array.from(selectedJobs).map(cb => cb.value);
        
        // Update the hidden input field
        const hiddenInput = document.getElementById('selected-jobs-input');
        if (hiddenInput) {
            hiddenInput.value = selectedJobIds.join(',');
            console.log('Updated selected jobs:', selectedJobIds);
        }
    }
    
    // Add event listener to customer select
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            loadJobsForCustomer(this.value);
        });
        
        // Load jobs if customer is pre-selected (for edit mode)
        if (customerSelect.value) {
            loadJobsForCustomer(customerSelect.value);
            
            // Check if we're editing an existing invoice and pre-select jobs
            const hiddenInput = document.getElementById('selected-jobs-input');
            if (hiddenInput && hiddenInput.value) {
                // Wait a bit for jobs to load, then pre-select them
                setTimeout(() => {
                    preSelectJobs(hiddenInput.value);
                }, 500);
            }
        }
    }
    
    function preSelectJobs(selectedJobIds) {
        if (!selectedJobIds) return;
        
        const jobIds = selectedJobIds.split(',').map(id => id.trim());
        jobIds.forEach(jobId => {
            const checkbox = document.querySelector(`input[name="jobs"][value="${jobId}"]`);
            if (checkbox) {
                checkbox.checked = true;
                // Trigger change event to populate fields
                populateFieldsFromJob(jobId);
            }
        });
        
        // Update the hidden input
        updateSelectedJobsInput();
    }
});
</script>
{% endblock %}