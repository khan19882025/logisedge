{% extends 'base.html' %}
{% load static %}

{% block title %}Profit & Loss Statement - logisEdge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profit_loss_statement/profit_loss_statement.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-primary">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        Profit & Loss Statement
                    </h1>
                    <p class="text-muted mb-0">Generate comprehensive profit and loss reports with detailed analysis</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'profit_loss_statement:report_list' %}" class="btn btn-outline-info">
                        <i class="bi bi-list-ul me-1"></i>View Saved Reports
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-funnel me-2"></i>Report Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="reportForm" action="{% url 'profit_loss_statement:profit_loss_report' %}">
                        {% csrf_token %}
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <h6>Form Errors:</h6>
                                {{ form.errors }}
                            </div>
                        {% endif %}
                        <div class="row g-3">
                            <!-- Date Range -->
                            <div class="col-md-3">
                                <label for="{{ form.from_date.id_for_label }}" class="form-label">From Date</label>
                                {{ form.from_date }}
                                {% if form.from_date.errors %}
                                    <div class="text-danger">{{ form.from_date.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.to_date.id_for_label }}" class="form-label">To Date</label>
                                {{ form.to_date }}
                                {% if form.to_date.errors %}
                                    <div class="text-danger">{{ form.to_date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Company Selection -->
                            <div class="col-md-3">
                                <label for="{{ form.company.id_for_label }}" class="form-label">Company</label>
                                {{ form.company }}
                            </div>
                            
                            <!-- Report Period -->
                            <div class="col-md-3">
                                <label for="{{ form.report_period.id_for_label }}" class="form-label">Report Period</label>
                                {{ form.report_period }}
                            </div>
                            
                            <!-- Comparison Type -->
                            <div class="col-md-3">
                                <label for="{{ form.comparison_type.id_for_label }}" class="form-label">Comparison</label>
                                {{ form.comparison_type }}
                            </div>
                            
                            <!-- Display Options -->
                            <div class="col-md-9">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.include_zero_balances }}
                                            <label class="form-check-label" for="{{ form.include_zero_balances.id_for_label }}">
                                                Include Zero Balances
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.show_percentages }}
                                            <label class="form-check-label" for="{{ form.show_percentages.id_for_label }}">
                                                Show Percentages
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.group_by_department }}
                                            <label class="form-check-label" for="{{ form.group_by_department.id_for_label }}">
                                                Group by Department
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Generate Button -->
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="submit" class="btn btn-primary" id="generateBtn">
                                        <span class="btn-text">
                                            <i class="bi bi-search me-1"></i>Generate Report
                                        </span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                            Generating...
                                        </span>
                                    </button>
                                    <button type="button" class="btn btn-success" id="directPdfExport" onclick="directExport('pdf')">
                                        <i class="bi bi-file-earmark-pdf me-1"></i>Export PDF
                                    </button>
                                    <button type="button" class="btn btn-info" id="directExcelExport" onclick="directExport('excel')">
                                        <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Results -->
    {% if report_data and report_data.revenue %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0" id="profitLossReport">
                <!-- Professional Header -->
                <div class="card-header bg-white border-bottom-0 p-4">
                    <div class="text-center mb-4">
                        {% if company %}
                        <h2 class="fw-bold text-dark mb-1">{{ company.name|upper }}</h2>
                        {% if company.address %}
                        <p class="text-muted mb-1">{{ company.address }}</p>
                        {% endif %}
                        {% if company.phone or company.email %}
                        <p class="text-muted mb-3">
                            {% if company.phone %}Tel: {{ company.phone }}{% endif %}
                            {% if company.phone and company.email %} | {% endif %}
                            {% if company.email %}Email: {{ company.email }}{% endif %}
                        </p>
                        {% endif %}
                        {% else %}
                        <h2 class="fw-bold text-dark mb-3">COMPANY NAME</h2>
                        {% endif %}
                        
                        <h3 class="fw-bold text-primary mb-2">PROFIT AND LOSS STATEMENT</h3>
                        <h4 class="text-dark mb-0">For the Period Ended {{ to_date|date:"F d, Y" }}</h4>
                        <p class="text-muted mb-0">From {{ from_date|date:"F d, Y" }} to {{ to_date|date:"F d, Y" }}</p>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table mb-0" id="profitLossTable" style="border-collapse: collapse;">
                            <thead>
                                <tr style="border-top: 2px solid #000; border-bottom: 1px solid #000;">
                                    <th class="fw-bold text-dark py-3" style="width: 60%; border: none; font-size: 14px;">PARTICULARS</th>
                                    <th class="fw-bold text-dark text-end py-3" style="width: 20%; border: none; font-size: 14px;">AMOUNT (AED)</th>
                                    {% if show_percentages %}
                                    <th class="fw-bold text-dark text-end py-3" style="width: 20%; border: none; font-size: 14px;">%</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Revenue Section -->
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" class="fw-bold text-dark py-2" style="font-size: 13px; background-color: #f8f9fa;">
                                        REVENUE
                                    </td>
                                </tr>
                                {% for account in report_data.revenue.accounts %}
                                <tr style="border: none;">
                                    <td class="ps-4 py-2" style="font-size: 12px; border: none;">{{ account.account__name }}</td>
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">{{ account.total|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">{{ account.percentage|floatformat:2|default:"0.00" }}%</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                <tr style="border-top: 1px solid #000; border-bottom: 1px solid #000;">
                                    <td class="fw-bold py-2" style="font-size: 13px; border: none;">Total Revenue</td>
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">{{ report_data.revenue.total|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">100.00%</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>

                                <!-- COGS Section -->
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" class="fw-bold text-dark py-2" style="font-size: 13px; background-color: #f8f9fa;">
                                        COST OF GOODS SOLD
                                    </td>
                                </tr>
                                {% for account in report_data.cogs.accounts %}
                                <tr style="border: none;">
                                    <td class="ps-4 py-2" style="font-size: 12px; border: none;">{{ account.account__name }}</td>
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.percentage|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                <tr style="border-top: 1px solid #000; border-bottom: 1px solid #000;">
                                    <td class="fw-bold py-2" style="font-size: 13px; border: none;">Total Cost of Goods Sold</td>
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.cogs.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.cogs.pct_of_revenue|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>

                                <!-- Gross Profit -->
                                <tr style="border-top: 2px solid #000; border-bottom: 1px solid #000; background-color: #e8f5e8;">
                                    <td class="fw-bold py-3" style="font-size: 14px; border: none;">GROSS PROFIT</td>
                                    <td class="text-end fw-bold py-3" style="font-size: 14px; border: none;">{{ report_data.gross_profit|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-3" style="font-size: 14px; border: none;">{{ report_data.gross_profit_pct|floatformat:2|default:"0.00" }}%</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>

                                <!-- Operating Expenses -->
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" class="fw-bold text-dark py-2" style="font-size: 13px; background-color: #f8f9fa;">
                                        OPERATING EXPENSES
                                    </td>
                                </tr>
                                {% for account in report_data.expenses.accounts %}
                                <tr style="border: none;">
                                    <td class="ps-4 py-2" style="font-size: 12px; border: none;">{{ account.account__name }}</td>
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.percentage|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                <tr style="border-top: 1px solid #000; border-bottom: 1px solid #000;">
                                    <td class="fw-bold py-2" style="font-size: 13px; border: none;">Total Operating Expenses</td>
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.expenses.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.expenses.pct_of_revenue|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>

                                <!-- Operating Profit -->
                                <tr style="border-top: 2px solid #000; border-bottom: 1px solid #000; background-color: #e3f2fd;">
                                    <td class="fw-bold py-3" style="font-size: 14px; border: none;">OPERATING PROFIT</td>
                                    <td class="text-end fw-bold py-3" style="font-size: 14px; border: none;">{{ report_data.operating_profit|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-3" style="font-size: 14px; border: none;">{{ report_data.operating_profit_pct|floatformat:2|default:"0.00" }}%</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>

                                <!-- Other Income -->
                                {% if report_data.other_income.accounts %}
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" class="fw-bold text-dark py-2" style="font-size: 13px; background-color: #f8f9fa;">
                                        OTHER INCOME
                                    </td>
                                </tr>
                                {% for account in report_data.other_income.accounts %}
                                <tr style="border: none;">
                                    <td class="ps-4 py-2" style="font-size: 12px; border: none;">{{ account.account__name }}</td>
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">{{ account.total|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">{{ account.percentage|floatformat:2|default:"0.00" }}%</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                <tr style="border-top: 1px solid #000; border-bottom: 1px solid #000;">
                                    <td class="fw-bold py-2" style="font-size: 13px; border: none;">Total Other Income</td>
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">{{ report_data.other_income.total|floatformat:2|default:"0.00" }}</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">{{ report_data.other_income.pct_of_revenue|floatformat:2|default:"0.00" }}%</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>
                                {% endif %}

                                <!-- Other Expenses -->
                                {% if report_data.other_expenses.accounts %}
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" class="fw-bold text-dark py-2" style="font-size: 13px; background-color: #f8f9fa;">
                                        OTHER EXPENSES
                                    </td>
                                </tr>
                                {% for account in report_data.other_expenses.accounts %}
                                <tr style="border: none;">
                                    <td class="ps-4 py-2" style="font-size: 12px; border: none;">{{ account.account__name }}</td>
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end py-2" style="font-size: 12px; border: none;">({{ account.percentage|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                <tr style="border-top: 1px solid #000; border-bottom: 1px solid #000;">
                                    <td class="fw-bold py-2" style="font-size: 13px; border: none;">Total Other Expenses</td>
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.other_expenses.total|floatformat:2|default:"0.00" }})</td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-2" style="font-size: 13px; border: none;">({{ report_data.other_expenses.pct_of_revenue|floatformat:2|default:"0.00" }}%)</td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 15px; border: none;"></td>
                                </tr>
                                {% endif %}

                                <!-- Net Profit -->
                                <tr style="border-top: 3px double #000; border-bottom: 3px double #000;" class="{% if report_data.net_profit >= 0 %}table-success{% else %}table-danger{% endif %}">
                                    <td class="fw-bold py-4" style="font-size: 16px; border: none;">NET PROFIT</td>
                                    <td class="text-end fw-bold py-4" style="font-size: 16px; border: none;">
                                        {{ report_data.net_profit|floatformat:2|default:"0.00" }}
                                    </td>
                                    {% if show_percentages %}
                                    <td class="text-end fw-bold py-4" style="font-size: 16px; border: none;">
                                        {{ report_data.net_profit_pct|floatformat:2|default:"0.00" }}%
                                    </td>
                                    {% endif %}
                                </tr>
                                
                                <!-- Final Spacing Row -->
                                <tr style="border: none;">
                                    <td colspan="{% if show_percentages %}3{% else %}2{% endif %}" style="height: 20px; border: none;"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not report_data %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-graph-up-arrow text-muted" style="font-size: 4rem;"></i>
                    {% if no_data_message %}
                        <h4 class="text-muted mt-3">No Data Found</h4>
                        <p class="text-muted">No financial data was found for the selected period{% if from_date and to_date %} ({{ from_date|date:"M d, Y" }} to {{ to_date|date:"M d, Y" }}){% endif %}.</p>
                        <p class="text-muted">Please try a different date range or ensure ledger entries exist for this period.</p>
                    {% else %}
                        <h4 class="text-muted mt-3">No Report Generated</h4>
                        <p class="text-muted">Fill in the filters above and click "Generate Report" to view your Profit & Loss statement.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="bi bi-download me-2"></i>Export Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'profit_loss_statement:export_profit_loss' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="export-format" class="form-label">Export Format</label>
                        <select class="form-select" id="export-format" name="export_format" required>
                            <option value="pdf">PDF Document</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="csv">CSV File</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-headers" name="include_headers" checked>
                            <label class="form-check-label" for="include-headers">
                                Include Headers
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-totals" name="include_totals" checked>
                            <label class="form-check-label" for="include-totals">
                                Include Totals
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-comparison" name="include_comparison">
                            <label class="form-check-label" for="include-comparison">
                                Include Comparison Data
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-percentages" name="include_percentages" checked>
                            <label class="form-check-label" for="include-percentages">
                                Include Percentages
                            </label>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for report data -->
                    {% if report_data %}
                    <input type="hidden" name="from_date" value="{{ from_date|date:'Y-m-d' }}">
                    <input type="hidden" name="to_date" value="{{ to_date|date:'Y-m-d' }}">
                    {% if company %}
                    <input type="hidden" name="company" value="{{ company.id }}">
                    {% endif %}
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/profit_loss_statement/profit_loss_statement.js' %}"></script>
<script>
// Debug script to test form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    if (form) {
        console.log('Form found:', form);
        
        // Check what IDs the date fields actually have
        const fromDateField = document.getElementById('id_from_date');
        const toDateField = document.getElementById('id_to_date');
        console.log('From date field:', fromDateField);
        console.log('To date field:', toDateField);
        
        // List all form inputs
        const inputs = form.querySelectorAll('input, select');
        console.log('All form inputs:');
        inputs.forEach(input => {
            console.log('- ID:', input.id, 'Name:', input.name, 'Type:', input.type);
        });
        
        form.addEventListener('submit', function(e) {
            console.log('Form submit event detected!');
            const formData = new FormData(form);
            console.log('Form data:');
            for (let [key, value] of formData.entries()) {
                console.log(key + ': ' + value);
            }
        });
    } else {
        console.log('Form not found!');
    }
});
</script>
{% endblock %}