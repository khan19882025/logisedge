{% extends 'base.html' %}
{% load static %}

{% block title %}{{ document.title }} - PDF Preview{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-file-pdf text-primary"></i>
                            {{ document.title }}
                        </h1>
                        <p class="page-subtitle">
                            {{ document.document_type.get_category_display }} - {{ document.document_type.name }}
                        </p>
                    </div>
                    <div class="header-actions">
                        <a href="{% url 'pdf_preview_tool:document_detail' document.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-info-circle"></i> Document Details
                        </a>
                        <a href="#" class="btn btn-success" onclick="downloadDocument()">
                            <i class="fas fa-download"></i> Download
                        </a>
                        <a href="#" class="btn btn-info" onclick="printDocument()">
                            <i class="fas fa-print"></i> Print
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Interface -->
    <div class="row">
        <!-- Main Preview Area -->
        <div class="col-xl-9 col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-eye"></i> Document Preview
                    </h6>
                    <div class="preview-controls">
                        <div class="btn-group btn-group-sm me-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <span class="btn btn-outline-secondary disabled" id="zoomLevel">100%</span>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm me-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="previousPage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="btn btn-outline-secondary disabled">
                                Page <span id="currentPage">1</span> of <span id="totalPages">{{ document.page_count }}</span>
                            </span>
                            <button type="button" class="btn btn-outline-secondary" onclick="nextPage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="pdfViewer" class="pdf-viewer-container">
                        <div class="pdf-loading text-center py-5">
                            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                            <h5>Loading PDF Preview...</h5>
                            <p class="text-muted">Please wait while we prepare your document</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <!-- Search Panel -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-search"></i> Search Document
                    </h6>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search text...">
                        <button class="btn btn-primary" type="button" onclick="searchDocument()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="search-results">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>

            <!-- Thumbnails Panel -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-th"></i> Page Thumbnails
                    </h6>
                </div>
                <div class="card-body">
                    <div id="thumbnailsContainer" class="thumbnails-container">
                        <!-- Thumbnails will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Document Info -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle"></i> Document Info
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Type:</strong>
                        <span class="badge badge-info">{{ document.document_type.get_category_display }}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Pages:</strong> {{ document.page_count }}
                    </div>
                    <div class="mb-2">
                        <strong>Size:</strong> {{ document.file_size|filesizeformat }}
                    </div>
                    <div class="mb-2">
                        <strong>Created:</strong> {{ document.created_at|date:"M d, Y" }}
                    </div>
                    {% if document.description %}
                    <div class="mb-2">
                        <strong>Description:</strong>
                        <p class="text-muted small">{{ document.description|truncatechars:100 }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>




</div>

<!-- PDF Preview Modal -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfPreviewModalLabel">PDF Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="pdfPreviewContainer" class="text-center">
                    <p class="text-muted">Loading PDF preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadPdf">
                    <i class="fas fa-download"></i> Download
                </button>
                <button type="button" class="btn btn-success" id="printPdf">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
}

.page-title {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.page-subtitle {
    margin: 0.5rem 0 0 0;
    font-size: 1.1rem;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.pdf-viewer-container {
    min-height: 600px;
    background-color: #f8f9fc;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pdf-loading {
    color: #6c757d;
}

.preview-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.thumbnails-container {
    max-height: 300px;
    overflow-y: auto;
}

.thumbnail-item {
    cursor: pointer;
}

.thumbnail-page {
    width: 60px;
    height: 80px;
    background-color: #f8f9fc;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.2s ease;
}

.thumbnail-page:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
}

.search-results {
    max-height: 200px;
    overflow-y: auto;
}

.search-result-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-result-item:hover {
    background-color: #f8f9fc;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.document-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fc;
    border-radius: 50%;
}

.session-item {
    transition: all 0.3s ease;
}

.session-item:hover {
    background-color: #f8f9fc;
    transform: translateY(-2px);
}

.activity-item {
    transition: all 0.3s ease;
}

.activity-item:hover {
    background-color: #f8f9fc;
}

.border-start {
    border-left-width: 3px !important;
}

.border-primary {
    border-color: #4e73df !important;
}

.btn-block {
    display: block;
    width: 100%;
}

.me-3 {
    margin-right: 1rem !important;
}

.mb-3 {
    margin-bottom: 1rem !important;
}

.mt-2 {
    margin-top: 0.5rem !important;
}

.mt-1 {
    margin-top: 0.25rem !important;
}

.py-4 {
    padding-top: 1.5rem !important;
    padding-bottom: 1.5rem !important;
}

.py-3 {
    padding-top: 1rem !important;
    padding-bottom: 1rem !important;
}

.py-2 {
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.p-3 {
    padding: 1rem !important;
}

.p-2 {
    padding: 0.5rem !important;
}

.px-3 {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
}

.badge-sm {
    font-size: 0.75em;
    padding: 0.25em 0.6em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // PDF Preview functionality
    let currentZoom = 1.0;
    let currentPage = 1;
    let totalPages = {{ document.page_count }};
    let pdfDoc = null;

    // Initialize PDF viewer
    function initializePdfViewer() {
        // Load PDF.js library if not already loaded
        if (typeof pdfjsLib === 'undefined') {
            loadPdfJsLibrary();
        } else {
            loadDocument();
        }
    }

    function loadPdfJsLibrary() {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        script.onload = function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            loadDocument();
        };
        document.head.appendChild(script);
    }

    function loadDocument() {
        const container = document.getElementById('pdfViewer');
        container.innerHTML = '<div class="pdf-loading text-center py-5"><i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i><h5>Loading PDF...</h5></div>';
        
        // Load the PDF document
        const loadingTask = pdfjsLib.getDocument('{{ document.file_path }}');
        loadingTask.promise.then(function(pdf) {
            pdfDoc = pdf;
            totalPages = pdf.numPages;
            document.getElementById('totalPages').textContent = totalPages;
            renderPage(1);
            generateThumbnails();
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            container.innerHTML = '<div class="text-center py-5"><i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5>Error Loading PDF</h5><p class="text-muted">Could not load the document</p></div>';
        });
    }

    function renderPage(pageNum) {
        if (!pdfDoc) return;
        
        currentPage = pageNum;
        document.getElementById('currentPage').textContent = pageNum;
        
        pdfDoc.getPage(pageNum).then(function(page) {
            const container = document.getElementById('pdfViewer');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            const viewport = page.getViewport({ scale: currentZoom });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            container.innerHTML = '';
            container.appendChild(canvas);
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            page.render(renderContext);
        });
    }

    function generateThumbnails() {
        const container = document.getElementById('thumbnailsContainer');
        container.innerHTML = '';
        
        for (let i = 1; i <= Math.min(totalPages, 10); i++) {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'thumbnail-item mb-2';
            thumbDiv.innerHTML = `
                <div class="thumbnail-page" onclick="goToPage(${i})">
                    <span class="page-number">${i}</span>
                </div>
            `;
            container.appendChild(thumbDiv);
        }
    }

    // Navigation functions
    function previousPage() {
        if (currentPage > 1) {
            renderPage(currentPage - 1);
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            renderPage(currentPage + 1);
        }
    }

    function goToPage(pageNum) {
        if (pageNum >= 1 && pageNum <= totalPages) {
            renderPage(pageNum);
        }
    }

    // Zoom functions
    function zoomIn() {
        currentZoom = Math.min(currentZoom * 1.2, 3.0);
        document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        renderPage(currentPage);
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom / 1.2, 0.5);
        document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        renderPage(currentPage);
    }

    // Search functionality
    function searchDocument() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;
        
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '<div class="text-muted">Searching...</div>';
        
        // Implement search functionality here
        // For now, show a placeholder
        setTimeout(() => {
            resultsContainer.innerHTML = `
                <div class="search-result-item p-2 border rounded mb-2">
                    <strong>Page 1:</strong> Found "${query}" in document content
                </div>
            `;
        }, 1000);
    }

    // Document actions
    function downloadDocument() {
        // Implement download functionality
        alert('Download functionality will be implemented here');
    }

    function printDocument() {
        // Implement print functionality
        alert('Print functionality will be implemented here');
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializePdfViewer();
    });

    // Download PDF functionality
    document.getElementById('downloadPdf').addEventListener('click', function() {
        // Implement download logic
        alert('Download functionality will be implemented here');
    });

    // Print PDF functionality
    document.getElementById('printPdf').addEventListener('click', function() {
        // Implement print logic
        alert('Print functionality will be implemented here');
    });

    // Add click handlers for preview buttons
    document.querySelectorAll('.btn-outline-success').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const documentId = this.closest('tr').querySelector('a[href*="/documents/"]').href.split('/').slice(-2)[0];
            openPdfPreview(documentId);
        });
    });
});
</script>
{% endblock %}
