{% extends 'stock_transfer/base.html' %}
{% load static %}

{% block stock_transfer_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-plus-circle me-2"></i>{{ title }}
                </h1>
                <p class="text-muted">Create a new stock transfer between warehouses</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'stock_transfer:stock_transfer_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Stock Transfer Form -->
    <form method="post" id="stock-transfer-form">
        {% csrf_token %}
        
        <!-- Basic Information Section -->
        <div class="transfer-form-section">
            <h5><i class="bi bi-info-circle me-2"></i>Transfer Information</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="{{ form.transfer_date.id_for_label }}" class="form-label">Transfer Date</label>
                    {{ form.transfer_date }}
                    {% if form.transfer_date.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.transfer_date.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.transfer_type.id_for_label }}" class="form-label">Transfer Type</label>
                    {{ form.transfer_type }}
                    {% if form.transfer_type.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.transfer_type.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.source_facility.id_for_label }}" class="form-label">Source Facility</label>
                    {{ form.source_facility }}
                    {% if form.source_facility.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.source_facility.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.destination_facility.id_for_label }}" class="form-label">Destination Facility</label>
                    {{ form.destination_facility }}
                    {% if form.destination_facility.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.destination_facility.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.reference_number.id_for_label }}" class="form-label">Reference Number</label>
                    {{ form.reference_number }}
                    {% if form.reference_number.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.reference_number.errors.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="transfer-form-section">
            <h5><i class="bi bi-boxes me-2"></i>Transfer Items</h5>
            
            {{ formset.management_form }}
            
            <div class="table-responsive">
                <table class="table table-bordered items-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 25%;">Item</th>
                            <th style="width: 10%;">Quantity</th>
                            <th style="width: 10%;">Available</th>
                            <th style="width: 8%;">Unit</th>
                            <th style="width: 12%;">Batch/Serial</th>
                            <th style="width: 10%;">Source Location</th>
                            <th style="width: 10%;">Dest. Location</th>
                            <th style="width: 8%;">Unit Cost</th>
                            <th style="width: 7%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody">
                        {% for form in formset %}
                        <tr class="item-row">
                            <td>
                                {{ form.id }}
                                <select name="{{ form.item.name }}" class="form-select" required>
                                    <option value="">Select Item</option>
                                    {% for choice in form.item.field.choices %}
                                        {% if choice.0 %}
                                            <option value="{{ choice.0 }}" {% if form.item.value == choice.0 %}selected{% endif %}>
                                                {{ choice.1 }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                {% if form.item.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.item.errors.0 }}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.quantity.errors.0 }}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.available_quantity }}
                            </td>
                            <td>
                                {{ form.unit_of_measure }}
                            </td>
                            <td>
                                <div class="row g-1">
                                    <div class="col-12">
                                        {{ form.batch_number }}
                                        <small class="text-muted">Batch</small>
                                    </div>
                                    <div class="col-12">
                                        {{ form.serial_number }}
                                        <small class="text-muted">Serial</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {{ form.source_location }}
                            </td>
                            <td>
                                {{ form.destination_location }}
                            </td>
                            <td>
                                {{ form.unit_cost }}
                            </td>
                            <td>
                                {% if formset.can_delete %}
                                    <div class="form-check">
                                        {{ form.DELETE }}
                                        <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                            Delete
                                        </label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-item-btn">
                    <i class="bi bi-plus-circle me-1"></i>Add Item
                </button>
            </div>
        </div>

        <!-- Additional Information Section -->
        <div class="transfer-form-section">
            <h5><i class="bi bi-chat-text me-2"></i>Additional Information</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.notes.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.special_instructions.id_for_label }}" class="form-label">Special Instructions</label>
                    {{ form.special_instructions }}
                    {% if form.special_instructions.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.special_instructions.errors.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between">
            <a href="{% url 'stock_transfer:stock_transfer_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>Cancel
            </a>
            <div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>{{ submit_text }}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Item Template for JavaScript -->
<template id="item-template">
    <tr class="item-row">
        <td>
            <select name="items-__prefix__-item" class="form-select" required>
                <option value="">Select Item</option>
                {% for choice in formset.empty_form.item.field.choices %}
                    {% if choice.0 %}
                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="items-__prefix__-quantity" class="form-control" step="0.01" min="0.01" required>
        </td>
        <td>
            <input type="number" name="items-__prefix__-available_quantity" class="form-control" step="0.01" min="0" readonly>
        </td>
        <td>
            <input type="text" name="items-__prefix__-unit_of_measure" class="form-control" readonly>
        </td>
        <td>
            <div class="row g-1">
                <div class="col-12">
                    <input type="text" name="items-__prefix__-batch_number" class="form-control" placeholder="Batch">
                    <small class="text-muted">Batch</small>
                </div>
                <div class="col-12">
                    <input type="text" name="items-__prefix__-serial_number" class="form-control" placeholder="Serial">
                    <small class="text-muted">Serial</small>
                </div>
            </div>
        </td>
        <td>
            <input type="text" name="items-__prefix__-source_location" class="form-control" placeholder="Source location">
        </td>
        <td>
            <input type="text" name="items-__prefix__-destination_location" class="form-control" placeholder="Destination location">
        </td>
        <td>
            <input type="number" name="items-__prefix__-unit_cost" class="form-control" step="0.01" min="0">
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeStockTransferForm();
});

function initializeStockTransferForm() {
    const addItemBtn = document.getElementById('add-item-btn');
    const itemsTbody = document.getElementById('items-tbody');
    const itemTemplate = document.getElementById('item-template');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    
    if (addItemBtn && itemsTbody && itemTemplate) {
        addItemBtn.addEventListener('click', function() {
            addItemRow();
        });
    }
    
    // Handle remove item buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            e.target.closest('tr').remove();
            updateFormIndexes();
        }
    });
    
    function addItemRow() {
        const totalForms = parseInt(totalFormsInput.value);
        const newRow = itemTemplate.content.cloneNode(true);
        
        // Update form index
        newRow.querySelectorAll('[name]').forEach(input => {
            input.name = input.name.replace('__prefix__', totalForms);
            input.id = input.id.replace('__prefix__', totalForms);
        });
        
        itemsTbody.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
    }
    
    function updateFormIndexes() {
        const rows = itemsTbody.querySelectorAll('.item-row');
        rows.forEach((row, index) => {
            row.querySelectorAll('[name]').forEach(input => {
                const name = input.name;
                const newName = name.replace(/items-\d+/, `items-${index}`);
                input.name = newName;
                
                const id = input.id;
                if (id) {
                    const newId = id.replace(/items-\d+/, `items-${index}`);
                    input.id = newId;
                }
            });
        });
        totalFormsInput.value = rows.length;
    }
}
</script>
{% endblock %} 