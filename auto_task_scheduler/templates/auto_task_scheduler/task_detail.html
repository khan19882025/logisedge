{% extends 'base.html' %}
{% load static %}

{% block title %}{{ task.name }} - Task Details - LogisEdge ERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'auto_task_scheduler/css/task_scheduler.css' %}">
{% endblock %}

{% block content %}
<div class="task-detail-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-info-circle"></i>
                Task Details
            </h1>
            <p class="page-subtitle">{{ task.name }}</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="runTaskNow('{{ task.id }}')">
                <i class="fas fa-play"></i>
                Run Now
            </button>
            <button class="btn btn-secondary" onclick="toggleTaskStatus('{{ task.id }}', '{{ task.status }}')">
                {% if task.status == 'active' %}
                    <i class="fas fa-pause"></i>
                    Deactivate
                {% else %}
                    <i class="fas fa-play"></i>
                    Activate
                {% endif %}
            </button>
            <a href="{% url 'auto_task_scheduler:task_scheduler_list' %}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                Back to List
            </a>
        </div>
    </div>

    <!-- Task Information Grid -->
    <div class="task-detail-grid">
        <!-- Main Task Information -->
        <div class="detail-card main-info">
            <div class="card-header">
                <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
            </div>
            <div class="card-content">
                <div class="info-grid">
                    <div class="info-item">
                        <label>Task Name:</label>
                        <span>{{ task.name }}</span>
                    </div>
                    <div class="info-item">
                        <label>Description:</label>
                        <span>{{ task.description|default:"No description provided" }}</span>
                    </div>
                    <div class="info-item">
                        <label>Task Type:</label>
                        <span class="task-type-badge type-{{ task.task_type }}">
                            {{ task.get_task_type_display }}
                        </span>
                    </div>
                    <div class="info-item">
                        <label>Status:</label>
                        <span class="status-badge status-{{ task.status }}">
                            {{ task.get_status_display }}
                        </span>
                    </div>
                    <div class="info-item">
                        <label>Created By:</label>
                        <span>{{ task.user.get_full_name|default:task.user.username }}</span>
                    </div>
                    <div class="info-item">
                        <label>Created Date:</label>
                        <span>{{ task.created_at|date:"F d, Y \a\t H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <label>Last Updated:</label>
                        <span>{{ task.updated_at|date:"F d, Y \a\t H:i" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Information -->
        <div class="detail-card schedule-info">
            <div class="card-header">
                <h3><i class="fas fa-clock"></i> Schedule Configuration</h3>
            </div>
            <div class="card-content">
                <div class="info-grid">
                    <div class="info-item">
                        <label>Schedule Type:</label>
                        <span>{{ task.get_schedule_type_display }}</span>
                    </div>
                    <div class="info-item">
                        <label>Time:</label>
                        <span>{{ task.schedule_time|time:"H:i" }}</span>
                    </div>
                    {% if task.schedule_type == 'weekly' %}
                        <div class="info-item">
                            <label>Days:</label>
                            <span>
                                {% if task.monday %}Mon{% endif %}
                                {% if task.tuesday %}{% if task.monday %}, {% endif %}Tue{% endif %}
                                {% if task.wednesday %}{% if task.monday or task.tuesday %}, {% endif %}Wed{% endif %}
                                {% if task.thursday %}{% if task.monday or task.tuesday or task.wednesday %}, {% endif %}Thu{% endif %}
                                {% if task.friday %}{% if task.monday or task.tuesday or task.wednesday or task.thursday %}, {% endif %}Fri{% endif %}
                                {% if task.saturday %}{% if task.monday or task.tuesday or task.wednesday or task.thursday or task.friday %}, {% endif %}Sat{% endif %}
                                {% if task.sunday %}{% if task.monday or task.tuesday or task.wednesday or task.thursday or task.friday or task.saturday %}, {% endif %}Sun{% endif %}
                            </span>
                        </div>
                    {% endif %}
                    {% if task.schedule_type == 'monthly' %}
                        <div class="info-item">
                            <label>Day of Month:</label>
                            <span>{{ task.day_of_month }}</span>
                        </div>
                    {% endif %}
                    {% if task.schedule_type == 'specific_datetime' %}
                        <div class="info-item">
                            <label>Specific Date:</label>
                            <span>{{ task.schedule_date|date:"F d, Y" }}</span>
                        </div>
                    {% endif %}
                    <div class="info-item">
                        <label>Next Run:</label>
                        <span class="next-run-time">
                            {% if task.next_run_at %}
                                {{ task.next_run_at|date:"F d, Y \a\t H:i" }}
                            {% else %}
                                <span class="text-muted">Not scheduled</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <label>Last Run:</label>
                        <span class="last-run-time">
                            {% if task.last_run_at %}
                                {{ task.last_run_at|date:"F d, Y \a\t H:i" }} ({{ task.last_run_at|timesince }} ago)
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Statistics -->
        <div class="detail-card execution-stats">
            <div class="card-header">
                <h3><i class="fas fa-chart-bar"></i> Execution Statistics</h3>
            </div>
            <div class="card-content">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">{{ task.execution_count|default:0 }}</div>
                        <div class="stat-label">Total Executions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number success">{{ task.success_count|default:0 }}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number failure">{{ task.failure_count|default:0 }}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">
                            {% if task.execution_count > 0 %}
                                {{ task.success_count|default:0|floatformat:1|div:task.execution_count|mul:100|floatformat:1 }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                
                {% if task.max_execution_time %}
                <div class="execution-settings">
                    <h4>Execution Settings</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Max Execution Time:</label>
                            <span>{{ task.max_execution_time }} minutes</span>
                        </div>
                        {% if task.retry_on_failure %}
                        <div class="info-item">
                            <label>Max Retries:</label>
                            <span>{{ task.max_retries|default:3 }}</span>
                        </div>
                        <div class="info-item">
                            <label>Retry Delay:</label>
                            <span>{{ task.retry_delay|default:5 }} minutes</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Task Parameters -->
        {% if task.task_parameters %}
        <div class="detail-card task-params">
            <div class="card-header">
                <h3><i class="fas fa-cog"></i> Task Parameters</h3>
            </div>
            <div class="card-content">
                <div class="json-viewer">
                    <pre><code>{{ task.task_parameters|pprint }}</code></pre>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Recent Execution Logs -->
    <div class="logs-section">
        <div class="section-header">
            <h3><i class="fas fa-history"></i> Recent Execution Logs</h3>
            <a href="{% url 'auto_task_scheduler:task_scheduler_logs' task.id %}" class="btn btn-outline">
                View All Logs
            </a>
        </div>
        
        <div class="logs-container">
            {% if logs %}
                <div class="logs-table">
                    <div class="table-header">
                        <div class="table-cell">Execution Time</div>
                        <div class="table-cell">Status</div>
                        <div class="table-cell">Duration</div>
                        <div class="table-cell">Output</div>
                        <div class="table-cell">Actions</div>
                    </div>
                    
                    {% for log in logs %}
                    <div class="table-row status-{{ log.status }}">
                        <div class="table-cell">
                            <div class="execution-time">
                                <div class="date">{{ log.started_at|date:"M d, Y" }}</div>
                                <div class="time">{{ log.started_at|time:"H:i:s" }}</div>
                            </div>
                        </div>
                        <div class="table-cell">
                            <span class="status-badge status-{{ log.status }}">
                                {{ log.get_status_display }}
                            </span>
                        </div>
                        <div class="table-cell">
                            {% if log.execution_time %}
                                <span class="duration">{{ log.execution_time|floatformat:2 }}s</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <div class="table-cell">
                            <div class="output-preview">
                                {% if log.output_message %}
                                    <div class="output-text">{{ log.output_message|truncatechars:100 }}</div>
                                {% endif %}
                                {% if log.error_message %}
                                    <div class="error-text">{{ log.error_message|truncatechars:100 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="table-cell">
                            <button class="btn btn-sm btn-icon" onclick="viewLogDetails('{{ log.id }}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No execution logs found for this task</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Task Actions -->
    <div class="task-actions-section">
        <div class="actions-grid">
            <button class="btn btn-primary btn-large" onclick="runTaskNow('{{ task.id }}')">
                <i class="fas fa-play"></i>
                Run Task Now
            </button>
            
            <button class="btn btn-secondary btn-large" onclick="toggleTaskStatus('{{ task.id }}', '{{ task.status }}')">
                {% if task.status == 'active' %}
                    <i class="fas fa-pause"></i>
                    Deactivate Task
                {% else %}
                    <i class="fas fa-play"></i>
                    Activate Task
                {% endif %}
            </button>
            
            <a href="{% url 'auto_task_scheduler:task_scheduler_create' %}" class="btn btn-outline btn-large">
                <i class="fas fa-copy"></i>
                Duplicate Task
            </a>
            
            <button class="btn btn-danger btn-large" onclick="deleteTask('{{ task.id }}')">
                <i class="fas fa-trash"></i>
                Delete Task
            </button>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div id="logDetailsModal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Execution Log Details</h3>
            <span class="close" onclick="closeLogDetailsModal()">&times;</span>
        </div>
        <div class="modal-body" id="logDetailsContent">
            <!-- Log details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeLogDetailsModal()">Close</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure you want to perform this action?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Processing...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'auto_task_scheduler/js/task_scheduler.js' %}"></script>
<script>
    // Initialize page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeTaskDetail();
    });
    
    function initializeTaskDetail() {
        // Set up any page-specific functionality
        console.log('Task detail page initialized');
    }
    
    function runTaskNow(taskId) {
        showLoading();
        
        fetch(`/utilities/auto-task-scheduler/api/scheduled-tasks/${taskId}/run_manually/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                showNotification('Task started successfully!', 'success');
                // Refresh the page after a short delay
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || 'Failed to start task', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Error starting task: ' + error.message, 'error');
        });
    }
    
    function toggleTaskStatus(taskId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const action = newStatus === 'active' ? 'activate' : 'deactivate';
        
        showConfirmModal(
            `Are you sure you want to ${action} this task?`,
            () => updateTaskStatus(taskId, newStatus)
        );
    }
    
    function updateTaskStatus(taskId, newStatus) {
        showLoading();
        
        fetch(`/utilities/auto-task-scheduler/api/scheduled-tasks/${taskId}/update_status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus }),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                showNotification(`Task ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message || 'Failed to update task status', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Error updating task status: ' + error.message, 'error');
        });
    }
    
    function deleteTask(taskId) {
        showConfirmModal(
            'Are you sure you want to delete this task? This action cannot be undone.',
            () => performDeleteTask(taskId)
        );
    }
    
    function performDeleteTask(taskId) {
        showLoading();
        
        fetch(`/utilities/auto-task-scheduler/api/scheduled-tasks/${taskId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                showNotification('Task deleted successfully!', 'success');
                setTimeout(() => window.location.href = '{% url "auto_task_scheduler:task_scheduler_list" %}', 1000);
            } else {
                showNotification('Failed to delete task', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Error deleting task: ' + error.message, 'error');
        });
    }
    
    function viewLogDetails(logId) {
        // Load log details via AJAX and show in modal
        fetch(`/utilities/auto-task-scheduler/api/task-logs/${logId}/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('logDetailsContent');
            content.innerHTML = `
                <div class="log-details">
                    <div class="detail-section">
                        <h4>Execution Information</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Started:</label>
                                <span>${data.started_at}</span>
                            </div>
                            <div class="info-item">
                                <label>Ended:</label>
                                <span>${data.ended_at || 'Still running'}</span>
                            </div>
                            <div class="info-item">
                                <label>Duration:</label>
                                <span>${data.execution_time ? data.execution_time + 's' : 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <label>Status:</label>
                                <span class="status-badge status-${data.status}">${data.get_status_display}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${data.output_message ? `
                    <div class="detail-section">
                        <h4>Output</h4>
                        <pre class="output-content">${data.output_message}</pre>
                    </div>
                    ` : ''}
                    
                    ${data.error_message ? `
                    <div class="detail-section">
                        <h4>Error Details</h4>
                        <pre class="error-content">${data.error_message}</pre>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('logDetailsModal').style.display = 'block';
        })
        .catch(error => {
            showNotification('Error loading log details: ' + error.message, 'error');
        });
    }
    
    function closeLogDetailsModal() {
        document.getElementById('logDetailsModal').style.display = 'none';
    }
    
    function showConfirmModal(message, onConfirm) {
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmActionBtn').onclick = onConfirm;
        document.getElementById('confirmModal').style.display = 'block';
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }
    
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
    
    function showNotification(message, type) {
        // Simple notification implementation
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
