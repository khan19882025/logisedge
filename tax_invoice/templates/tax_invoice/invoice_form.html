{% extends 'tax_invoice/base.html' %}
{% load static %}

{% block title %}
    {% if object %}Edit Invoice{% else %}New Invoice{% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'tax_invoice:invoice_list' %}">Invoices</a></li>
<li class="breadcrumb-item active">{% if object %}Edit{% else %}New{% endif %}</li>
{% endblock %}

{% block tax_invoice_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                {% if object %}Edit Invoice{% else %}New Tax Invoice{% endif %}
            </h1>
            <a href="{% url 'tax_invoice:invoice_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>
</div>

<form method="post" id="invoiceForm">
    {% csrf_token %}
    
    <div class="row">
        <!-- Invoice Details -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Invoice Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.invoice_date.id_for_label }}" class="form-label">Invoice Date</label>
                                {{ form.invoice_date }}
                                {% if form.invoice_date.errors %}
                                    <div class="text-danger">{{ form.invoice_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.due_date.id_for_label }}" class="form-label">Due Date</label>
                                {{ form.due_date }}
                                {% if form.due_date.errors %}
                                    <div class="text-danger">{{ form.due_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.currency.id_for_label }}" class="form-label">Currency</label>
                                {{ form.currency }}
                                {% if form.currency.errors %}
                                    <div class="text-danger">{{ form.currency.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Company Details -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Company Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.company_name.id_for_label }}" class="form-label">Company Name</label>
                                {{ form.company_name }}
                                {% if form.company_name.errors %}
                                    <div class="text-danger">{{ form.company_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.company_trn.id_for_label }}" class="form-label">TRN/VAT Number</label>
                                {{ form.company_trn }}
                                {% if form.company_trn.errors %}
                                    <div class="text-danger">{{ form.company_trn.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.company_address.id_for_label }}" class="form-label">Company Address</label>
                        {{ form.company_address }}
                        {% if form.company_address.errors %}
                            <div class="text-danger">{{ form.company_address.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.company_phone.id_for_label }}" class="form-label">Phone</label>
                                {{ form.company_phone }}
                                {% if form.company_phone.errors %}
                                    <div class="text-danger">{{ form.company_phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.company_email.id_for_label }}" class="form-label">Email</label>
                                {{ form.company_email }}
                                {% if form.company_email.errors %}
                                    <div class="text-danger">{{ form.company_email.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.company_website.id_for_label }}" class="form-label">Website</label>
                                {{ form.company_website }}
                                {% if form.company_website.errors %}
                                    <div class="text-danger">{{ form.company_website.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Details -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Customer Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer_name.id_for_label }}" class="form-label">Customer Name</label>
                                {{ form.customer_name }}
                                {% if form.customer_name.errors %}
                                    <div class="text-danger">{{ form.customer_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer_trn.id_for_label }}" class="form-label">Customer TRN/VAT</label>
                                {{ form.customer_trn }}
                                {% if form.customer_trn.errors %}
                                    <div class="text-danger">{{ form.customer_trn.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.customer_address.id_for_label }}" class="form-label">Customer Address</label>
                        {{ form.customer_address }}
                        {% if form.customer_address.errors %}
                            <div class="text-danger">{{ form.customer_address.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer_phone.id_for_label }}" class="form-label">Phone</label>
                                {{ form.customer_phone }}
                                {% if form.customer_phone.errors %}
                                    <div class="text-danger">{{ form.customer_phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer_email.id_for_label }}" class="form-label">Email</label>
                                {{ form.customer_email }}
                                {% if form.customer_email.errors %}
                                    <div class="text-danger">{{ form.customer_email.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Items -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Invoice Items</h6>
                </div>
                <div class="card-body">
                    {{ item_formset.management_form }}
                    <div id="itemForms">
                        {% for item_form in item_formset %}
                        <div class="item-form border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-2">
                                        <label class="form-label">Description</label>
                                        {{ item_form.description }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label">Quantity</label>
                                        {{ item_form.quantity }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label">Unit Price</label>
                                        {{ item_form.unit_price }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label">VAT %</label>
                                        {{ item_form.vat_percentage }}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label">Total</label>
                                        <input type="text" class="form-control" readonly id="itemTotal_{{ forloop.counter0 }}">
                                    </div>
                                </div>
                            </div>
                            {% if item_formset.can_delete %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-check">
                                        {{ item_form.DELETE }}
                                        <label class="form-check-label" for="{{ item_form.DELETE.id_for_label }}">
                                            Delete this item
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addItem">
                        <i class="bi bi-plus-circle me-2"></i>Add Item
                    </button>
                </div>
            </div>

            <!-- Invoice Totals -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Invoice Totals</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="subtotal">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>VAT:</span>
                        <span id="totalVat">0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Grand Total:</span>
                        <span id="grandTotal">0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Additional Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.payment_instructions.id_for_label }}" class="form-label">Payment Instructions</label>
                                {{ form.payment_instructions }}
                                {% if form.payment_instructions.errors %}
                                    <div class="text-danger">{{ form.payment_instructions.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.terms_conditions.id_for_label }}" class="form-label">Terms & Conditions</label>
                        {{ form.terms_conditions }}
                        {% if form.terms_conditions.errors %}
                            <div class="text-danger">{{ form.terms_conditions.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'tax_invoice:invoice_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Cancel
                        </a>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {% if object %}Update Invoice{% else %}Create Invoice{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Calculate totals when form loads
document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
    
    // Add event listeners for item form changes
    document.addEventListener('input', function(e) {
        if (e.target.name.includes('quantity') || e.target.name.includes('unit_price') || e.target.name.includes('vat_percentage')) {
            calculateTotals();
        }
    });
});

// Add new item form
document.getElementById('addItem').addEventListener('click', function() {
    const itemForms = document.getElementById('itemForms');
    const formCount = document.getElementById('id_items-TOTAL_FORMS');
    const currentCount = parseInt(formCount.value);
    
    // Clone the first item form
    const firstForm = itemForms.querySelector('.item-form');
    const newForm = firstForm.cloneNode(true);
    
    // Update form indices
    newForm.innerHTML = newForm.innerHTML.replace(/items-\d+-/g, `items-${currentCount}-`);
    
    // Clear the new form
    newForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.value = '';
    });
    
    // Add the new form
    itemForms.appendChild(newForm);
    formCount.value = currentCount + 1;
    
    // Recalculate totals
    calculateTotals();
});

function calculateTotals() {
    let subtotal = 0;
    let totalVat = 0;
    
    // Calculate totals for each item
    document.querySelectorAll('.item-form').forEach(function(form, index) {
        const quantity = parseFloat(form.querySelector('input[name*="quantity"]').value) || 0;
        const unitPrice = parseFloat(form.querySelector('input[name*="unit_price"]').value) || 0;
        const vatPercentage = parseFloat(form.querySelector('input[name*="vat_percentage"]').value) || 0;
        
        const itemTotal = quantity * unitPrice;
        const itemVat = itemTotal * (vatPercentage / 100);
        const itemGrandTotal = itemTotal + itemVat;
        
        // Update item total display
        const totalField = form.querySelector('input[id*="itemTotal"]');
        if (totalField) {
            totalField.value = itemGrandTotal.toFixed(2);
        }
        
        subtotal += itemTotal;
        totalVat += itemVat;
    });
    
    const grandTotal = subtotal + totalVat;
    
    // Update totals display
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('totalVat').textContent = totalVat.toFixed(2);
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}
</script>
{% endblock %}
