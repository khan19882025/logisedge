{% extends 'base.html' %}
{% load static %}

{% block title %}Import Chart of Accounts{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Import Chart of Accounts from Excel</h3>
                    <div class="card-tools">
                        <a href="{% url 'chart_of_accounts:account_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Accounts
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-info">
                                <h5><i class="icon fas fa-info"></i> Instructions:</h5>
                                <ul>
                                    <li>Upload an Excel file (.xlsx or .xls) with chart of accounts data</li>
                                    <li>Maximum file size: 10MB</li>
                                    <li>The Excel file must contain the following columns:</li>
                                    <ul>
                                        <li><strong>Account Code</strong> (Required) - Unique account code</li>
                                        <li><strong>Name</strong> (Required) - Account name</li>
                                        <li><strong>Account Type</strong> (Required) - Must match existing account types</li>
                                        <li><strong>Account Nature</strong> (Required) - DEBIT or CREDIT</li>
                                        <li><strong>Description</strong> (Optional) - Account description</li>
                                        <li><strong>Parent Account</strong> (Optional) - Parent account code</li>
                                        <li><strong>Is Group</strong> (Optional) - Yes/No (default: No)</li>
                                        <li><strong>Level</strong> (Optional) - Account level (default: 1)</li>
                                        <li><strong>Current Balance</strong> (Optional) - Initial balance (default: 0)</li>
                                        <li><strong>Active</strong> (Optional) - Yes/No (default: Yes)</li>
                                    </ul>
                                </ul>
                            </div>

                            <div class="alert alert-warning">
                                <h6><i class="icon fas fa-exclamation-triangle"></i> Valid Account Natures:</h6>
                                <p><strong>DEBIT</strong> or <strong>CREDIT</strong></p>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5>Sample Excel Format</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Account Code</th>
                                                    <th>Name</th>
                                                    <th>Account Type</th>
                                                    <th>Account Nature</th>
                                                    <th>Description</th>
                                                    <th>Parent Account</th>
                                                    <th>Is Group</th>
                                                    <th>Level</th>
                                                    <th>Current Balance</th>
                                                    <th>Active</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>1000</td>
                                                    <td>Cash</td>
                                                    <td>Current Assets</td>
                                                    <td>DEBIT</td>
                                                    <td>Cash in hand</td>
                                                    <td></td>
                                                    <td>No</td>
                                                    <td>1</td>
                                                    <td>0</td>
                                                    <td>Yes</td>
                                                </tr>
                                                <tr>
                                                    <td>2000</td>
                                                    <td>Accounts Payable</td>
                                                    <td>Current Liabilities</td>
                                                    <td>CREDIT</td>
                                                    <td>Amount owed to suppliers</td>
                                                    <td></td>
                                                    <td>No</td>
                                                    <td>1</td>
                                                    <td>0</td>
                                                    <td>Yes</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <form method="post" enctype="multipart/form-data" id="importForm">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="excel_file">Select Excel File:</label>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                                        <label class="custom-file-label" for="excel_file">Choose file...</label>
                                    </div>
                                    <small class="form-text text-muted">Maximum file size: 10MB. Supported formats: .xlsx, .xls</small>
                                </div>
                                
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-upload"></i> Import Accounts
                                    </button>
                                    <a href="{% url 'chart_of_accounts:account_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Upload Progress</h5>
                                </div>
                                <div class="card-body">
                                    <div id="uploadProgress" style="display: none;">
                                        <div class="progress mb-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center">Processing file...</p>
                                    </div>
                                    <div id="uploadInstructions">
                                        <p><i class="fas fa-info-circle text-info"></i> Select an Excel file to begin import</p>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> Validate file format</li>
                                            <li><i class="fas fa-check text-success"></i> Check required columns</li>
                                            <li><i class="fas fa-check text-success"></i> Process account data</li>
                                            <li><i class="fas fa-check text-success"></i> Create new accounts</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drag and Drop Zone -->
<div id="dropZone" class="drop-zone" style="display: none;">
    <div class="drop-zone-content">
        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
        <h4>Drop Excel file here</h4>
        <p>or click to browse</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // File input change handler
    $('#excel_file').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(fileName);
        
        // Validate file size (10MB = 10 * 1024 * 1024 bytes)
        const maxSize = 10 * 1024 * 1024;
        if (this.files[0] && this.files[0].size > maxSize) {
            alert('File size exceeds 10MB limit. Please choose a smaller file.');
            $(this).val('');
            $(this).next('.custom-file-label').html('Choose file...');
            return;
        }
        
        // Validate file type
        const allowedTypes = ['.xlsx', '.xls'];
        const fileExtension = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));
        if (!allowedTypes.includes(fileExtension)) {
            alert('Please select a valid Excel file (.xlsx or .xls)');
            $(this).val('');
            $(this).next('.custom-file-label').html('Choose file...');
            return;
        }
    });
    
    // Form submit handler
    $('#importForm').on('submit', function() {
        const fileInput = $('#excel_file')[0];
        if (!fileInput.files.length) {
            alert('Please select a file to upload.');
            return false;
        }
        
        // Show progress
        $('#uploadInstructions').hide();
        $('#uploadProgress').show();
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
        
        // Simulate progress (since we can't track actual upload progress easily)
        let progress = 0;
        const progressInterval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            $('.progress-bar').css('width', progress + '%');
        }, 500);
        
        // Clear interval after form submission
        setTimeout(function() {
            clearInterval(progressInterval);
        }, 1000);
    });
    
    // Drag and drop functionality
    let dragCounter = 0;
    
    $(document).on('dragenter', function(e) {
        e.preventDefault();
        dragCounter++;
        $('#dropZone').show();
    });
    
    $(document).on('dragleave', function(e) {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) {
            $('#dropZone').hide();
        }
    });
    
    $(document).on('dragover', function(e) {
        e.preventDefault();
    });
    
    $(document).on('drop', function(e) {
        e.preventDefault();
        dragCounter = 0;
        $('#dropZone').hide();
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                $('#excel_file')[0].files = files;
                $('#excel_file').trigger('change');
            } else {
                alert('Please drop a valid Excel file (.xlsx or .xls)');
            }
        }
    });
    
    $('#dropZone').on('click', function() {
        $('#excel_file').click();
    });
});
</script>

<style>
.drop-zone {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.drop-zone-content {
    background: white;
    padding: 40px;
    border-radius: 10px;
    text-align: center;
    border: 3px dashed #007bff;
    cursor: pointer;
}

.drop-zone-content:hover {
    border-color: #0056b3;
    background: #f8f9fa;
}
</style>
{% endblock %}