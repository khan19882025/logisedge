{% extends 'charges/base.html' %}
{% load static %}

{% block title %}{{ title }} - Charge Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-plus-circle me-2"></i>{{ title }}
                </h1>
                <p class="text-muted">Create or edit charge information</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'charges:charge_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Charge Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Charge Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="charge-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label required-field">
                                    Customer
                                </label>
                                {{ form.customer }}
                                {% if form.customer.errors %}
                                    <div class="text-danger mt-1">{{ form.customer.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.item.id_for_label }}" class="form-label required-field">
                                    Item
                                </label>
                                {{ form.item }}
                                {% if form.item.errors %}
                                    <div class="text-danger mt-1">{{ form.item.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.charge_type.id_for_label }}" class="form-label required-field">
                                    Charge Type
                                </label>
                                {{ form.charge_type }}
                                {% if form.charge_type.errors %}
                                    <div class="text-danger mt-1">{{ form.charge_type.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Select the type of charge calculation</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.rate.id_for_label }}" class="form-label required-field">
                                    Rate
                                </label>
                                {{ form.rate }}
                                {% if form.rate.errors %}
                                    <div class="text-danger mt-1">{{ form.rate.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Rate per unit (will be calculated based on charge type)</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.effective_date.id_for_label }}" class="form-label required-field">
                                    Effective Date
                                </label>
                                {{ form.effective_date }}
                                {% if form.effective_date.errors %}
                                    <div class="text-danger mt-1">{{ form.effective_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label required-field">
                                    Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger mt-1">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                Remarks
                            </label>
                            {{ form.remarks }}
                            {% if form.remarks.errors %}
                                <div class="text-danger mt-1">{{ form.remarks.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Optional additional notes about this charge</div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Charge Type Information:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Per CBM/Days:</strong> Rate per cubic meter per day</li>
                                <li><strong>Per SQMTS/Days:</strong> Rate per square meters per day</li>
                                <li><strong>Per Weight/Days:</strong> Rate per weight unit per day</li>
                                <li><strong>Fixed:</strong> Fixed amount regardless of quantity or time</li>
                                <li><strong>Weekly:</strong> Rate per week</li>
                                <li><strong>Monthly:</strong> Rate per month</li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'charges:charge_list' %}" class="btn btn-secondary">
                                <i class="bi bi-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check me-1"></i>Save Charge
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Help Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-question-circle me-2"></i>Help
                    </h5>
                </div>
                <div class="card-body">
                    <h6>How to create a charge:</h6>
                    <ol class="small">
                        <li>Select the customer for this charge</li>
                        <li>Choose the specific item</li>
                        <li>Select the appropriate charge type</li>
                        <li>Enter the rate amount</li>
                        <li>Set the effective date</li>
                        <li>Choose the status (Active/Inactive/Draft)</li>
                        <li>Add any optional remarks</li>
                    </ol>
                    
                    <h6 class="mt-3">Important Notes:</h6>
                    <ul class="small">
                        <li>Each customer-item combination can have multiple charge types</li>
                        <li>Effective date determines when the charge becomes applicable</li>
                        <li>Only active charges are used in calculations</li>
                        <li>Rates are automatically calculated based on the charge type</li>
                    </ul>
                </div>
            </div>

            <!-- Existing Charges Preview -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list me-2"></i>Existing Charges
                    </h5>
                </div>
                <div class="card-body" id="existing-charges-display">
                    <p class="text-muted">Select customer and item to view existing charges</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeChargeForm();
});

function initializeChargeForm() {
    const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
    const itemSelect = document.getElementById('{{ form.item.id_for_label }}');
    const chargeTypeSelect = document.getElementById('{{ form.charge_type.id_for_label }}');
    const rateInput = document.getElementById('{{ form.rate.id_for_label }}');
    
    // Handle customer and item selection
    if (customerSelect && itemSelect) {
        [customerSelect, itemSelect].forEach(select => {
            select.addEventListener('change', function() {
                if (customerSelect.value && itemSelect.value) {
                    loadExistingCharges(customerSelect.value, itemSelect.value);
                } else {
                    clearExistingCharges();
                }
            });
        });
    }
    
    // Handle charge type changes
    if (chargeTypeSelect) {
        chargeTypeSelect.addEventListener('change', function() {
            updateRatePlaceholder(this.value);
        });
    }
    
    // Form validation
    const form = document.getElementById('charge-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateChargeForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
}

function loadExistingCharges(customerId, itemId) {
    const container = document.getElementById('existing-charges-display');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</div>';
    
    fetch(`/charges/ajax/get-charges/?customer_id=${customerId}&item_id=${itemId}`)
        .then(response => response.json())
        .then(data => {
            displayExistingCharges(data.charges);
        })
        .catch(error => {
            console.error('Error loading charges:', error);
            container.innerHTML = '<p class="text-danger">Error loading existing charges</p>';
        });
}

function displayExistingCharges(charges) {
    const container = document.getElementById('existing-charges-display');
    if (!container) return;
    
    if (charges.length === 0) {
        container.innerHTML = '<p class="text-muted">No existing charges found for this customer-item combination</p>';
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    charges.forEach(charge => {
        const chargeTypeText = getChargeTypeText(charge.charge_type);
        const effectiveDate = new Date(charge.effective_date).toLocaleDateString();
        
        html += `
            <div class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${chargeTypeText}</h6>
                        <small class="text-muted">Rate: $${charge.rate}</small>
                    </div>
                    <small class="text-muted">${effectiveDate}</small>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function clearExistingCharges() {
    const container = document.getElementById('existing-charges-display');
    if (container) {
        container.innerHTML = '<p class="text-muted">Select customer and item to view existing charges</p>';
    }
}

function getChargeTypeText(chargeType) {
    const chargeTypes = {
        'per_cbm_days': 'Per CBM/Days',
        'per_sqmts_days': 'Per SQMTS/Days',
        'per_weight_days': 'Per Weight/Days',
        'fixed': 'Fixed',
        'weekly': 'Weekly',
        'monthly': 'Monthly'
    };
    return chargeTypes[chargeType] || chargeType;
}

function updateRatePlaceholder(chargeType) {
    const rateInput = document.getElementById('{{ form.rate.id_for_label }}');
    if (!rateInput) return;
    
    const placeholders = {
        'per_cbm_days': 'Rate per cubic meter per day',
        'per_sqmts_days': 'Rate per square meters per day',
        'per_weight_days': 'Rate per weight unit per day',
        'fixed': 'Fixed amount',
        'weekly': 'Rate per week',
        'monthly': 'Rate per month'
    };
    
    rateInput.placeholder = placeholders[chargeType] || 'Enter rate';
}

function validateChargeForm() {
    let isValid = true;
    
    // Clear previous errors
    const errorElements = document.querySelectorAll('.text-danger');
    errorElements.forEach(element => element.remove());
    
    // Validate required fields
    const requiredFields = [
        '{{ form.customer.id_for_label }}',
        '{{ form.item.id_for_label }}',
        '{{ form.charge_type.id_for_label }}',
        '{{ form.rate.id_for_label }}',
        '{{ form.effective_date.id_for_label }}',
        '{{ form.status.id_for_label }}'
    ];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
            showValidationError(field, 'This field is required');
            isValid = false;
        }
    });
    
    // Validate rate
    const rateInput = document.getElementById('{{ form.rate.id_for_label }}');
    if (rateInput && rateInput.value) {
        const rate = parseFloat(rateInput.value);
        if (isNaN(rate) || rate <= 0) {
            showValidationError(rateInput, 'Rate must be a positive number');
            isValid = false;
        }
    }
    
    // Validate effective date
    const dateInput = document.getElementById('{{ form.effective_date.id_for_label }}');
    if (dateInput && dateInput.value) {
        const selectedDate = new Date(dateInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            showValidationError(dateInput, 'Effective date cannot be in the past');
            isValid = false;
        }
    }
    
    return isValid;
}

function showValidationError(input, message) {
    if (!input) return;
    
    input.classList.add('is-invalid');
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'text-danger mt-1';
    errorDiv.textContent = message;
    
    const parent = input.parentNode;
    parent.appendChild(errorDiv);
}
</script>
{% endblock %} 