{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Retention Policy{% else %}New Retention Policy{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
                    {% if form.instance.pk %}Edit Retention Policy{% else %}New Retention Policy{% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if form.instance.pk %}
                        Modify the log retention policy configuration
                    {% else %}
                        Create a new log retention policy to manage log lifecycle
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i> Policy Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="retentionPolicyForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Policy Name -->
                            <div class="col-md-6">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Policy Name <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    A descriptive name for this retention policy
                                </small>
                            </div>

                            <!-- Retention Days -->
                            <div class="col-md-6">
                                <label for="{{ form.retention_days.id_for_label }}" class="form-label">
                                    Retention Period (Days) <span class="text-danger">*</span>
                                </label>
                                {{ form.retention_days }}
                                {% if form.retention_days.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.retention_days.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Number of days to retain logs before cleanup
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Detailed description of this retention policy
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Cleanup Action -->
                            <div class="col-md-6">
                                <label for="{{ form.cleanup_action.id_for_label }}" class="form-label">
                                    Cleanup Action <span class="text-danger">*</span>
                                </label>
                                {{ form.cleanup_action }}
                                {% if form.cleanup_action.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cleanup_action.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Action to take when logs exceed retention period
                                </small>
                            </div>

                            <!-- Is Active -->
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active Policy
                                    </label>
                                    {% if form.is_active.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.is_active.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Whether this policy is currently active
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Log Types -->
                            <div class="col-md-6">
                                <label for="{{ form.log_types.id_for_label }}" class="form-label">
                                    Log Types
                                </label>
                                {{ form.log_types }}
                                {% if form.log_types.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.log_types.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Specific log types this policy applies to (leave empty for all types)
                                </small>
                            </div>

                            <!-- Severity Levels -->
                            <div class="col-md-6">
                                <label for="{{ form.severity_levels.id_for_label }}" class="form-label">
                                    Severity Levels
                                </label>
                                {{ form.severity_levels }}
                                {% if form.severity_levels.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.severity_levels.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Specific severity levels this policy applies to (leave empty for all levels)
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Modules -->
                            <div class="col-md-6">
                                <label for="{{ form.modules.id_for_label }}" class="form-label">
                                    Modules
                                </label>
                                {{ form.modules }}
                                {% if form.modules.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.modules.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Specific modules this policy applies to (leave empty for all modules)
                                </small>
                            </div>

                            <!-- Environments -->
                            <div class="col-md-6">
                                <label for="{{ form.environments.id_for_label }}" class="form-label">
                                    Environments
                                </label>
                                {{ form.environments }}
                                {% if form.environments.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.environments.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Specific environments this policy applies to (leave empty for all environments)
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Schedule -->
                            <div class="col-md-6">
                                <label for="{{ form.schedule.id_for_label }}" class="form-label">
                                    Cleanup Schedule
                                </label>
                                {{ form.schedule }}
                                {% if form.schedule.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.schedule.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    When to run cleanup operations (cron expression)
                                </small>
                            </div>

                            <!-- Batch Size -->
                            <div class="col-md-6">
                                <label for="{{ form.batch_size.id_for_label }}" class="form-label">
                                    Batch Size
                                </label>
                                {{ form.batch_size }}
                                {% if form.batch_size.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.batch_size.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Number of logs to process in each cleanup batch
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Notification Recipients -->
                            <div class="col-md-6">
                                <label for="{{ form.notification_recipients.id_for_label }}" class="form-label">
                                    Notification Recipients
                                </label>
                                {{ form.notification_recipients }}
                                {% if form.notification_recipients.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.notification_recipients.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Users to notify when cleanup operations complete
                                </small>
                            </div>

                            <!-- Tags -->
                            <div class="col-md-6">
                                <label for="{{ form.tags.id_for_label }}" class="form-label">
                                    Tags
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tags.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Tags to categorize and organize this policy
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Notes -->
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    Notes
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.notes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Additional notes or special considerations for this policy
                                </small>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-{% if form.instance.pk %}save{% else %}plus{% endif %}"></i>
                                    {% if form.instance.pk %}Update Policy{% else %}Create Policy{% endif %}
                                </button>
                                <a href="{% url 'system_logs:log_retention_policy_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                {% if form.instance.pk %}
                                <a href="{% url 'system_logs:log_retention_policy_list' %}" class="btn btn-info">
                                    <i class="fas fa-eye"></i> View All Policies
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Policy Preview -->
    {% if form.instance.pk %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Policy Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">{{ form.instance.retention_days|default:0 }}</h4>
                                <p class="text-muted">Retention Days</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ form.instance.cleanup_action|default:"Not Set" }}</h4>
                                <p class="text-muted">Cleanup Action</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">{{ form.instance.last_cleanup|date:"M d, Y"|default:"Never" }}</h4>
                                <p class="text-muted">Last Cleanup</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">{{ form.instance.log_types.count|default:0 }}</h4>
                                <p class="text-muted">Log Types</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Form validation
document.getElementById('retentionPolicyForm').addEventListener('submit', function(e) {
    const name = document.getElementById('{{ form.name.id_for_label }}').value.trim();
    const retentionDays = document.getElementById('{{ form.retention_days.id_for_label }}').value;
    const cleanupAction = document.getElementById('{{ form.cleanup_action.id_for_label }}').value;
    
    if (!name) {
        e.preventDefault();
        alert('Please enter a policy name.');
        return;
    }
    
    if (!retentionDays || retentionDays < 1) {
        e.preventDefault();
        alert('Please enter a valid retention period (minimum 1 day).');
        return;
    }
    
    if (!cleanupAction) {
        e.preventDefault();
        alert('Please select a cleanup action.');
        return;
    }
    
    // Confirm deletion action
    if (cleanupAction === 'DELETE') {
        if (!confirm('You have selected DELETE as the cleanup action. This will permanently remove logs. Are you sure?')) {
            e.preventDefault();
            return;
        }
    }
});

// Auto-fill description based on name
document.getElementById('{{ form.name.id_for_label }}').addEventListener('input', function() {
    const name = this.value.trim();
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    
    if (name && !descriptionField.value) {
        descriptionField.value = `Retention policy for ${name.toLowerCase()}`;
    }
});

// Set default values
document.addEventListener('DOMContentLoaded', function() {
    // Set default retention days if not set
    const retentionDaysField = document.getElementById('{{ form.retention_days.id_for_label }}');
    if (!retentionDaysField.value) {
        retentionDaysField.value = '30';
    }
    
    // Set default batch size if not set
    const batchSizeField = document.getElementById('{{ form.batch_size.id_for_label }}');
    if (!batchSizeField.value) {
        batchSizeField.value = '1000';
    }
    
    // Set default schedule if not set
    const scheduleField = document.getElementById('{{ form.schedule.id_for_label }}');
    if (!scheduleField.value) {
        scheduleField.value = '0 2 * * *'; // Daily at 2 AM
    }
});

// Show/hide fields based on cleanup action
document.getElementById('{{ form.cleanup_action.id_for_label }}').addEventListener('change', function() {
    const cleanupAction = this.value;
    const batchSizeField = document.getElementById('{{ form.batch_size.id_for_label }}').parentElement;
    
    if (cleanupAction === 'DELETE') {
        batchSizeField.style.display = 'block';
    } else {
        batchSizeField.style.display = 'none';
    }
});
</script>

<style>
/* Form styling */
.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #d1d5db;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-text {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-check-input:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

/* Card styling */
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

/* Button styling */
.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.btn-primary {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.btn-primary:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
</style>
{% endblock %}
