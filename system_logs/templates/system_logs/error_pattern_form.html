{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Error Pattern{% else %}New Error Pattern{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
                    {% if form.instance.pk %}Edit Error Pattern{% else %}New Error Pattern{% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if form.instance.pk %}
                        Modify the error pattern configuration
                    {% else %}
                        Create a new error pattern to track recurring issues
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i> Pattern Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="errorPatternForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Pattern Name -->
                            <div class="col-md-6">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Pattern Name <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    A descriptive name for this error pattern
                                </small>
                            </div>

                            <!-- Error Type -->
                            <div class="col-md-6">
                                <label for="{{ form.error_type.id_for_label }}" class="form-label">
                                    Error Type <span class="text-danger">*</span>
                                </label>
                                {{ form.error_type }}
                                {% if form.error_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.error_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    The type of error this pattern represents
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Severity -->
                            <div class="col-md-6">
                                <label for="{{ form.severity.id_for_label }}" class="form-label">
                                    Severity <span class="text-danger">*</span>
                                </label>
                                {{ form.severity }}
                                {% if form.severity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.severity.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    The severity level of this error pattern
                                </small>
                            </div>

                            <!-- Status -->
                            <div class="col-md-6">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    Status <span class="text-danger">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.status.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Current status of this error pattern
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Detailed description of the error pattern and its impact
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Pattern Expression -->
                            <div class="col-md-6">
                                <label for="{{ form.pattern_expression.id_for_label }}" class="form-label">
                                    Pattern Expression
                                </label>
                                {{ form.pattern_expression }}
                                {% if form.pattern_expression.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.pattern_expression.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Regular expression or pattern to match similar errors
                                </small>
                            </div>

                            <!-- Threshold -->
                            <div class="col-md-6">
                                <label for="{{ form.threshold.id_for_label }}" class="form-label">
                                    Occurrence Threshold
                                </label>
                                {{ form.threshold }}
                                {% if form.threshold.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.threshold.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Minimum number of occurrences to trigger this pattern
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Auto Resolution -->
                            <div class="col-md-6">
                                <label for="{{ form.auto_resolution.id_for_label }}" class="form-label">
                                    Auto Resolution
                                </label>
                                {{ form.auto_resolution }}
                                {% if form.auto_resolution.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.auto_resolution.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Whether to automatically resolve logs matching this pattern
                                </small>
                            </div>

                            <!-- Notification Level -->
                            <div class="col-md-6">
                                <label for="{{ form.notification_level.id_for_label }}" class="form-label">
                                    Notification Level
                                </label>
                                {{ form.notification_level }}
                                {% if form.notification_level.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.notification_level.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    When to send notifications for this pattern
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Tags -->
                            <div class="col-md-6">
                                <label for="{{ form.tags.id_for_label }}" class="form-label">
                                    Tags
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tags.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Tags to categorize and organize this pattern
                                </small>
                            </div>

                            <!-- Priority -->
                            <div class="col-md-6">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                    Priority
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.priority.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Priority level for addressing this pattern
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Notes -->
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    Notes
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.notes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Additional notes, investigation results, or resolution steps
                                </small>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-{% if form.instance.pk %}save{% else %}plus{% endif %}"></i>
                                    {% if form.instance.pk %}Update Pattern{% else %}Create Pattern{% endif %}
                                </button>
                                <a href="{% url 'system_logs:error_pattern_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                {% if form.instance.pk %}
                                <a href="{% url 'system_logs:error_pattern_detail' form.instance.pk %}" class="btn btn-info">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Pattern Preview -->
    {% if form.instance.pk %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i> Pattern Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">{{ form.instance.occurrence_count|default:0 }}</h4>
                                <p class="text-muted">Total Occurrences</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ form.instance.first_occurrence|date:"M d, Y"|default:"Never" }}</h4>
                                <p class="text-muted">First Seen</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">{{ form.instance.last_occurrence|date:"M d, Y"|default:"Never" }}</h4>
                                <p class="text-muted">Last Seen</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">{{ form.instance.resolution_date|date:"M d, Y"|default:"Not Resolved" }}</h4>
                                <p class="text-muted">Resolution Date</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Form validation
document.getElementById('errorPatternForm').addEventListener('submit', function(e) {
    const name = document.getElementById('{{ form.name.id_for_label }}').value.trim();
    const errorType = document.getElementById('{{ form.error_type.id_for_label }}').value;
    const severity = document.getElementById('{{ form.severity.id_for_label }}').value;
    const status = document.getElementById('{{ form.status.id_for_label }}').value;
    
    if (!name) {
        e.preventDefault();
        alert('Please enter a pattern name.');
        return;
    }
    
    if (!errorType) {
        e.preventDefault();
        alert('Please select an error type.');
        return;
    }
    
    if (!severity) {
        e.preventDefault();
        alert('Please select a severity level.');
        return;
    }
    
    if (!status) {
        e.preventDefault();
        alert('Please select a status.');
        return;
    }
});

// Auto-fill description based on name and error type
document.getElementById('{{ form.name.id_for_label }}').addEventListener('input', function() {
    const name = this.value.trim();
    const errorType = document.getElementById('{{ form.error_type.id_for_label }}').value;
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    
    if (name && errorType && !descriptionField.value) {
        descriptionField.value = `Pattern for ${name.toLowerCase()} errors of type ${errorType}`;
    }
});

// Update severity based on error type
document.getElementById('{{ form.error_type.id_for_label }}').addEventListener('change', function() {
    const errorType = this.value;
    const severityField = document.getElementById('{{ form.severity.id_for_label }}');
    
    if (errorType === 'ERROR' && !severityField.value) {
        severityField.value = 'HIGH';
    } else if (errorType === 'WARNING' && !severityField.value) {
        severityField.value = 'MEDIUM';
    } else if (errorType === 'INFO' && !severityField.value) {
        severityField.value = 'LOW';
    }
});
</script>

<style>
/* Form styling */
.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #d1d5db;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-text {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

/* Card styling */
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

/* Button styling */
.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.btn-primary {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.btn-primary:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
</style>
{% endblock %}
