{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Debug Session{% else %}New Debug Session{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
                    {% if form.instance.pk %}Edit Debug Session{% else %}New Debug Session{% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if form.instance.pk %}
                        Modify the debug session configuration
                    {% else %}
                        Create a new debug session to investigate system issues
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i> Session Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="debugSessionForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Session Name -->
                            <div class="col-md-6">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Session Name <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    A descriptive name for this debug session
                                </small>
                            </div>

                            <!-- Priority -->
                            <div class="col-md-6">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                    Priority <span class="text-danger">*</span>
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.priority.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Priority level for this debug session
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Detailed description of the issue being investigated
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Related Logs -->
                            <div class="col-md-6">
                                <label for="{{ form.related_logs.id_for_label }}" class="form-label">
                                    Related Logs
                                </label>
                                {{ form.related_logs }}
                                {% if form.related_logs.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.related_logs.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    System logs related to this debug session
                                </small>
                            </div>

                            <!-- Environment -->
                            <div class="col-md-6">
                                <label for="{{ form.environment.id_for_label }}" class="form-label">
                                    Environment
                                </label>
                                {{ form.environment }}
                                {% if form.environment.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.environment.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Environment where the issue occurs
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Tags -->
                            <div class="col-md-6">
                                <label for="{{ form.tags.id_for_label }}" class="form-label">
                                    Tags
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tags.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Tags to categorize this debug session
                                </small>
                            </div>

                            <!-- Is Active -->
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active Session
                                    </label>
                                    {% if form.is_active.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.is_active.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Whether this debug session is currently active
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Investigation Notes -->
                            <div class="col-12">
                                <label for="{{ form.investigation_notes.id_for_label }}" class="form-label">
                                    Investigation Notes
                                </label>
                                {{ form.investigation_notes }}
                                {% if form.investigation_notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.investigation_notes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Notes, findings, and progress during investigation
                                </small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <!-- Resolution Steps -->
                            <div class="col-12">
                                <label for="{{ form.resolution_steps.id_for_label }}" class="form-label">
                                    Resolution Steps
                                </label>
                                {{ form.resolution_steps }}
                                {% if form.resolution_steps.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.resolution_steps.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Steps taken or planned to resolve the issue
                                </small>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-{% if form.instance.pk %}save{% else %}plus{% endif %}"></i>
                                    {% if form.instance.pk %}Update Session{% else %}Create Session{% endif %}
                                </button>
                                <a href="{% url 'system_logs:debug_session_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                {% if form.instance.pk %}
                                <a href="{% url 'system_logs:debug_session_detail' form.instance.pk %}" class="btn btn-info">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Preview -->
    {% if form.instance.pk %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bug"></i> Session Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">{{ form.instance.started_by.username|default:"Unknown" }}</h4>
                                <p class="text-muted">Started By</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ form.instance.started_at|date:"M d, Y H:i"|default:"Unknown" }}</h4>
                                <p class="text-muted">Started At</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">{{ form.instance.duration|default:"Active" }}</h4>
                                <p class="text-muted">Duration</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">{{ form.instance.related_logs.count|default:0 }}</h4>
                                <p class="text-muted">Related Logs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Form validation
document.getElementById('debugSessionForm').addEventListener('submit', function(e) {
    const name = document.getElementById('{{ form.name.id_for_label }}').value.trim();
    const priority = document.getElementById('{{ form.priority.id_for_label }}').value;
    
    if (!name) {
        e.preventDefault();
        alert('Please enter a session name.');
        return;
    }
    
    if (!priority) {
        e.preventDefault();
        alert('Please select a priority level.');
        return;
    }
});

// Auto-fill description based on name
document.getElementById('{{ form.name.id_for_label }}').addEventListener('input', function() {
    const name = this.value.trim();
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    
    if (name && !descriptionField.value) {
        descriptionField.value = `Debug session for investigating ${name.toLowerCase()}`;
    }
});

// Set default values
document.addEventListener('DOMContentLoaded', function() {
    // Set default priority if not set
    const priorityField = document.getElementById('{{ form.priority.id_for_label }}');
    if (!priorityField.value) {
        priorityField.value = 'MEDIUM';
    }
    
    // Set default environment if not set
    const environmentField = document.getElementById('{{ form.environment.id_for_label }}');
    if (!environmentField.value) {
        environmentField.value = 'development';
    }
});
</script>

<style>
/* Form styling */
.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #d1d5db;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-text {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-check-input:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

/* Card styling */
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

/* Button styling */
.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.btn-primary {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.btn-primary:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
</style>
{% endblock %}
