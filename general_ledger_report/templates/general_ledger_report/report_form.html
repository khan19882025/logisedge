{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'general_ledger_report/css/report.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
.compact-form {
    font-size: 0.9rem;
}
.compact-form .form-group {
    margin-bottom: 0.75rem;
}
.compact-form .section-title {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #dee2e6;
}
.compact-form .card-body {
    padding: 1rem;
}
.page-header-compact {
    margin-bottom: 1rem;
}
.page-header-compact h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}
.breadcrumb {
    margin-bottom: 0;
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Compact Page Header -->
    <div class="row page-header-compact">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-primary mb-1">
                        <i class="fas fa-cog me-2"></i>{{ title }}
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'general_ledger_report:report_list' %}">Reports</a></li>
                            <li class="breadcrumb-item active">{{ title }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="header-actions">
                    <a href="{% url 'general_ledger_report:report_quick' %}" class="btn btn-sm btn-outline-warning me-2">
                        <i class="fas fa-bolt me-1"></i>Quick
                    </a>
                    <a href="{% url 'general_ledger_report:template_list' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-layer-group me-1"></i>Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Report Form -->
    <div class="row">
        <div class="col-12">
            <div class="card compact-form">
                <div class="card-header py-2">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>Report Configuration
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="reportForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information & Date Range -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="section-title">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information & Date Range
                                </h6>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Report Name
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.report_type.id_for_label }}" class="form-label">
                                        <i class="fas fa-chart-bar me-1"></i>Report Type
                                    </label>
                                    {{ form.report_type }}
                                    {% if form.report_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.report_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.from_date.id_for_label }}" class="form-label">
                                        <i class="fas fa-calendar-day me-1"></i>From Date
                                    </label>
                                    {{ form.from_date }}
                                    {% if form.from_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.from_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.to_date.id_for_label }}" class="form-label">
                                        <i class="fas fa-calendar-day me-1"></i>To Date
                                    </label>
                                    {{ form.to_date }}
                                    {% if form.to_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.to_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Account & Amount Filters -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="section-title">
                                    <i class="fas fa-filter me-2"></i>Account & Amount Filters
                                </h6>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.account.id_for_label }}" class="form-label">
                                        <i class="fas fa-book me-1"></i>Account
                                    </label>
                                    {{ form.account }}
                                    <small class="form-text text-muted">Leave empty for all accounts</small>
                                    {% if form.account.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.account.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="{{ form.min_amount.id_for_label }}" class="form-label">
                                        <i class="fas fa-arrow-up me-1"></i>Min Amount
                                    </label>
                                    {{ form.min_amount }}
                                    {% if form.min_amount.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.min_amount.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="{{ form.max_amount.id_for_label }}" class="form-label">
                                        <i class="fas fa-arrow-down me-1"></i>Max Amount
                                    </label>
                                    {{ form.max_amount }}
                                    {% if form.max_amount.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.max_amount.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="{{ form.export_format.id_for_label }}" class="form-label">
                                        <i class="fas fa-file me-1"></i>Export Format
                                    </label>
                                    {{ form.export_format }}
                                    {% if form.export_format.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.export_format.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="form-check">
                                        {{ form.include_sub_accounts }}
                                        <label class="form-check-label" for="{{ form.include_sub_accounts.id_for_label }}">
                                            <i class="fas fa-sitemap me-1"></i>Sub-Accounts
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Options -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="section-title">
                                    <i class="fas fa-cogs me-2"></i>Additional Options
                                </h6>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    {{ form.include_reconciled_only }}
                                    <label class="form-check-label" for="{{ form.include_reconciled_only.id_for_label }}">
                                        <i class="fas fa-check me-1"></i>Reconciled Only
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    {{ form.include_unreconciled_only }}
                                    <label class="form-check-label" for="{{ form.include_unreconciled_only.id_for_label }}">
                                        <i class="fas fa-clock me-1"></i>Unreconciled Only
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.include_opening_balance }}
                                    <label class="form-check-label" for="{{ form.include_opening_balance.id_for_label }}">
                                        <i class="fas fa-arrow-up me-1"></i>Opening Balance
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    {{ form.include_closing_balance }}
                                    <label class="form-check-label" for="{{ form.include_closing_balance.id_for_label }}">
                                        <i class="fas fa-arrow-down me-1"></i>Closing Balance
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <!-- Empty space for alignment -->
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{% url 'general_ledger_report:report_list' %}" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-arrow-left me-1"></i>Back to Reports
                                    </a>
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="resetForm()">
                                            <i class="fas fa-undo me-1"></i>Reset Form
                                        </button>
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-chart-line me-1"></i>Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'general_ledger_report/js/report.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form validation
    const form = document.getElementById('reportForm');
    
    form.addEventListener('submit', function(e) {
        // Clear previous error states
        const errorElements = form.querySelectorAll('.is-invalid');
        errorElements.forEach(element => {
            element.classList.remove('is-invalid');
        });
        
        // Basic validation
        let isValid = true;
        
        // Check required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Check date range
        const fromDate = document.getElementById('{{ form.from_date.id_for_label }}');
        const toDate = document.getElementById('{{ form.to_date.id_for_label }}');
        
        if (fromDate.value && toDate.value) {
            if (new Date(fromDate.value) > new Date(toDate.value)) {
                fromDate.classList.add('is-invalid');
                toDate.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        // Check amount range
        const minAmount = document.getElementById('{{ form.min_amount.id_for_label }}');
        const maxAmount = document.getElementById('{{ form.max_amount.id_for_label }}');
        
        if (minAmount.value && maxAmount.value) {
            if (parseFloat(minAmount.value) > parseFloat(maxAmount.value)) {
                minAmount.classList.add('is-invalid');
                maxAmount.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        // Check reconciliation filters
        const reconciledOnly = document.getElementById('{{ form.include_reconciled_only.id_for_label }}');
        const unreconciledOnly = document.getElementById('{{ form.include_unreconciled_only.id_for_label }}');
        
        if (reconciledOnly.checked && unreconciledOnly.checked) {
            reconciledOnly.classList.add('is-invalid');
            unreconciledOnly.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            showNotification('Please correct the errors in the form.', 'danger');
        }
    });
    
    // Initialize account search
    initializeAccountSearch();
});
</script>
{% endblock %}