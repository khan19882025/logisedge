{% extends 'putaways/base.html' %}
{% load static %}

{% block putaway_title %}{{ page_title }}{% endblock %}

{% block putaway_content %}
<div class="putaway-form-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="page-title">
                <i class="bi bi-plus-circle me-2"></i>
                {{ page_title }}
            </h1>
            <div class="page-actions">
                <a href="{% url 'putaways:putaway_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Putaway Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-boxes me-2"></i>
                Putaway Information
            </h5>
        </div>
        <div class="card-body">
            <form method="post" class="putaway-form">
                {% csrf_token %}
                
                <div class="row">
                    <!-- GRN Selection -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.grn.id_for_label }}" class="form-label">
                                <i class="bi bi-file-text me-1"></i>GRN No *
                            </label>
                            {{ form.grn }}
                            {% if form.grn.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.grn.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Pallet ID Selection -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.pallet_id.id_for_label }}" class="form-label">
                                <i class="bi bi-tag me-1"></i>Pallet ID *
                            </label>
                            {{ form.pallet_id }}
                            {% if form.pallet_id.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.pallet_id.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Item (Auto-filled) -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.item.id_for_label }}" class="form-label">
                                <i class="bi bi-box me-1"></i>Items *
                            </label>
                            {{ form.item }}
                            {% if form.item.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.item.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quantity (Auto-filled) -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.quantity.id_for_label }}" class="form-label">
                                <i class="bi bi-123 me-1"></i>Qty *
                            </label>
                            {{ form.quantity }}
                            {% if form.quantity.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.quantity.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Location -->
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">
                                <i class="bi bi-geo-alt me-1"></i>Location *
                            </label>
                            {{ form.location }}
                            {% if form.location.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.location.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Notes -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                <i class="bi bi-sticky me-1"></i>Notes
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.notes.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Remarks -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                <i class="bi bi-chat-text me-1"></i>Remarks
                            </label>
                            {{ form.remarks }}
                            {% if form.remarks.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.remarks.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions mt-4">
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'putaways:putaway_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </a>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i> {{ submit_text }}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.page-header {
    padding: 1rem 0;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #dee2e6;
}

.page-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: #495057;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 0.5rem;
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control[readonly] {
    background-color: #f8f9fa;
    color: #6c757d;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.form-actions {
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

.btn {
    border-radius: 0.375rem;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.btn-primary {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    color: #fff;
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-outline-secondary {
    color: #6c757d;
    border-color: #6c757d;
}

.btn-outline-secondary:hover {
    color: #fff;
    background-color: #6c757d;
    border-color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const grnSelect = document.getElementById('id_grn');
    const palletSelect = document.getElementById('id_pallet_id');
    const itemSelect = document.getElementById('id_item');
    const quantityInput = document.getElementById('id_quantity');
    
    // Function to clear dependent fields
    function clearDependentFields() {
        // Clear pallet dropdown
        palletSelect.innerHTML = '<option value="">Select Pallet ID</option>';
        
        // Clear item dropdown
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        
        // Clear quantity
        quantityInput.value = '';
        quantityInput.readOnly = false;
    }
    
    // Function to populate pallet dropdown
    function loadPallets(grnId) {
        if (!grnId) {
            clearDependentFields();
            return;
        }
        
        fetch(`/putaways/get-grn-pallets/${grnId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    palletSelect.innerHTML = '<option value="">Select Pallet ID</option>';
                    data.pallets.forEach(pallet => {
                        const option = document.createElement('option');
                        option.value = pallet.id;
                        option.textContent = pallet.name; // This will be just the pallet ID
                        palletSelect.appendChild(option);
                    });
                } else {
                    console.error('Error loading pallets:', data.error);
                    clearDependentFields();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                clearDependentFields();
            });
    }
    
    // Function to load pallet details
    function loadPalletDetails(grnId, palletId) {
        if (!grnId || !palletId) {
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            quantityInput.value = '';
            quantityInput.readOnly = false;
            return;
        }
        
        fetch(`/putaways/get-pallet-details/${grnId}/${palletId}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Pallet details response:', data); // Debug log
                
                if (data.success) {
                    const pallet = data.pallet;
                    
                    // First, load all GRN items to populate the dropdown
                    fetch(`/putaways/get-grn-items/${grnId}/`)
                        .then(response => response.json())
                        .then(itemsData => {
                            if (itemsData.success) {
                                // Populate item dropdown with all GRN items
                                itemSelect.innerHTML = '<option value="">Select Item</option>';
                                itemsData.items.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item.id;
                                    option.textContent = `${item.name} (${item.code}) - Available: ${item.available_qty}`;
                                    itemSelect.appendChild(option);
                                });
                                
                                // If pallet has an associated item, select it
                                if (pallet.item_id && pallet.item_name) {
                                    console.log('Pallet has associated item:', pallet.item_id);
                                    itemSelect.value = pallet.item_id;
                                    console.log('Item select value after setting:', itemSelect.value);
                                } else {
                                    console.log('Pallet has no associated item, user must select manually');
                                    // If no associated item, user must select manually
                                    itemSelect.value = '';
                                }
                                
                                // Set quantity and make it read-only
                                quantityInput.value = pallet.quantity || '';
                                quantityInput.readOnly = true;
                            } else {
                                console.error('Error loading GRN items:', itemsData.error);
                                itemSelect.innerHTML = '<option value="">Error loading items</option>';
                                quantityInput.value = '';
                                quantityInput.readOnly = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading GRN items:', error);
                            itemSelect.innerHTML = '<option value="">Error loading items</option>';
                            quantityInput.value = '';
                            quantityInput.readOnly = false;
                        });
                } else {
                    console.error('Error loading pallet details:', data.error);
                    itemSelect.innerHTML = '<option value="">Select Item</option>';
                    quantityInput.value = '';
                    quantityInput.readOnly = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                quantityInput.value = '';
                quantityInput.readOnly = false;
            });
    }
    
    // Event listeners
    grnSelect.addEventListener('change', function() {
        const grnId = this.value;
        loadPallets(grnId);
        // Clear dependent fields when GRN changes
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        quantityInput.value = '';
        quantityInput.readOnly = false;
    });
    
    palletSelect.addEventListener('change', function() {
        const grnId = grnSelect.value;
        const palletId = this.value;
        loadPalletDetails(grnId, palletId);
    });
    
    // Form submission validation - only check if fields are actually empty
    document.querySelector('.putaway-form').addEventListener('submit', function(e) {
        const itemValue = itemSelect.value;
        const quantityValue = quantityInput.value;
        const locationValue = document.getElementById('id_location').value;
        
        // Debug logging
        console.log('=== FORM SUBMISSION DEBUG ===');
        console.log('Item value:', itemValue);
        console.log('Item value type:', typeof itemValue);
        console.log('Item value length:', itemValue ? itemValue.length : 0);
        console.log('Quantity value:', quantityValue);
        console.log('Location value:', locationValue);
        console.log('Item select element:', itemSelect);
        console.log('Item select options:', itemSelect.options);
        console.log('Item select selectedIndex:', itemSelect.selectedIndex);
        console.log('Item select options length:', itemSelect.options.length);
        
        // Check if item is selected - be more lenient
        const isItemSelected = itemValue && itemValue !== '' && itemValue !== 'Select Item';
        
        console.log('Is item selected?', isItemSelected);
        
        if (!isItemSelected) {
            e.preventDefault();
            alert('Please select an item.');
            itemSelect.focus();
            return false;
        }
        
        if (!quantityValue || quantityValue === '') {
            e.preventDefault();
            alert('Please ensure quantity is filled.');
            quantityInput.focus();
            return false;
        }
        
        if (!locationValue || locationValue === '') {
            e.preventDefault();
            alert('Please select a location.');
            document.getElementById('id_location').focus();
            return false;
        }
        
        // If all validations pass, allow form submission
        console.log('Form validation passed - proceeding with submission');
        return true;
    });
});
</script>
{% endblock %} 