{% extends 'base.html' %}
{% load static %}

{% block title %}Trial Balance Report - {{ report.report_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'trial_balance/css/trial_balance.css' %}">
{% endblock %}

{% block content %}
<div class="trial-balance-container">
    <!-- Header Section -->
    <div class="trial-balance-header">
        <div class="container">
            <h1>
                <i class="bi bi-file-earmark-text me-3"></i>
                {{ report.report_title }}
            </h1>
            <p>Report Number: {{ report.report_number }}</p>
        </div>
    </div>

    <div class="container">
        <!-- Report Summary -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Report Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">From Date:</small>
                                <p class="mb-1"><strong>{{ report.from_date|date:"M d, Y" }}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">To Date:</small>
                                <p class="mb-1"><strong>{{ report.to_date|date:"M d, Y" }}</strong></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Company:</small>
                                <p class="mb-1"><strong>{{ report.company.name }}</strong></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Status:</small>
                                <p class="mb-1">
                                    <span class="badge {% if report.status == 'final' %}bg-success{% elif report.status == 'draft' %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ report.get_status_display }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Created:</small>
                                <p class="mb-1"><strong>{{ report.created_at|date:"M d, Y H:i" }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Financial Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Total Debit:</small>
                                <p class="mb-1"><strong class="debit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_debit|floatformat:2 }}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Total Credit:</small>
                                <p class="mb-1"><strong class="credit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_credit|floatformat:2 }}</strong></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Difference:</small>
                                <p class="mb-1">
                                    <strong class="{% if report.difference >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                        {{ report.difference|floatformat:2 }}
                                    </strong>
                                </p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Balance Status:</small>
                                <p class="mb-1">
                                    <span class="badge {% if report.is_balanced %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if report.is_balanced %}Balanced{% else %}Unbalanced{% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-0">Report Entries</h3>
                <small class="text-muted">{{ entries|length }} accounts</small>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'trial_balance:trial_balance_edit' report.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil me-2"></i>
                    Edit Report
                </a>
                <button class="btn btn-success" onclick="exportReport()">
                    <i class="bi bi-download me-2"></i>
                    Export
                </button>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>
                    Print
                </button>
                <a href="{% url 'trial_balance:trial_balance_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    Back to List
                </a>
            </div>
        </div>

        <!-- Entries Table -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Account Code</th>
                                <th>Account Name</th>
                                <th>Account Type</th>
                                <th class="text-end">Opening Debit</th>
                                <th class="text-end">Opening Credit</th>
                                <th class="text-end">Period Debit</th>
                                <th class="text-end">Period Credit</th>
                                <th class="text-end">Closing Debit</th>
                                <th class="text-end">Closing Credit</th>
                                <th class="text-end">Running Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr>
                                <td><strong>{{ entry.account_code }}</strong></td>
                                <td>{{ entry.account_name }}</td>
                                <td><span class="badge bg-secondary">{{ entry.account_type }}</span></td>
                                <td class="text-end debit-amount">{{ entry.opening_debit|floatformat:2 }}</td>
                                <td class="text-end credit-amount">{{ entry.opening_credit|floatformat:2 }}</td>
                                <td class="text-end debit-amount">{{ entry.period_debit|floatformat:2 }}</td>
                                <td class="text-end credit-amount">{{ entry.period_credit|floatformat:2 }}</td>
                                <td class="text-end debit-amount">{{ entry.closing_debit|floatformat:2 }}</td>
                                <td class="text-end credit-amount">{{ entry.closing_credit|floatformat:2 }}</td>
                                <td class="text-end {% if entry.running_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                    <strong>{{ entry.running_balance|floatformat:2 }}</strong>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox display-4"></i>
                                        <p class="mt-3 mb-0">No entries found for this report.</p>
                                        <small>The report may not have been generated yet.</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3"><strong>TOTAL</strong></td>
                                <td class="text-end"><strong class="debit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_debit|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong class="credit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_credit|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong class="debit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_debit|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong class="credit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_credit|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong class="debit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_debit|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong class="credit-amount">{% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.total_credit|floatformat:2 }}</strong></td>
                                <td class="text-end">
                                    <strong class="{% if report.difference >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                        {% if default_currency %}{{ default_currency.symbol }} {% endif %}{{ report.difference|floatformat:2 }}
                                    </strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        {% if report.notes %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-sticky me-2"></i>
                    Notes
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ report.notes|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Audit Information -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Audit Information
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">Created By:</small>
                        <p class="mb-1"><strong>{{ report.created_by.get_full_name|default:report.created_by.username }}</strong></p>
                        <small class="text-muted">Created At:</small>
                        <p class="mb-1"><strong>{{ report.created_at|date:"M d, Y H:i:s" }}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Updated By:</small>
                        <p class="mb-1"><strong>{{ report.updated_by.get_full_name|default:report.updated_by.username|default:"Not updated" }}</strong></p>
                        <small class="text-muted">Updated At:</small>
                        <p class="mb-1"><strong>{{ report.updated_at|date:"M d, Y H:i:s" }}</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportReport() {
    // Create export form data
    const formData = new FormData();
    formData.append('export_format', 'excel');
    formData.append('include_headers', 'on');
    formData.append('include_totals', 'on');
    formData.append('include_running_balance', 'on');
    formData.append('from_date', '{{ report.from_date|date:"Y-m-d" }}');
    formData.append('to_date', '{{ report.to_date|date:"Y-m-d" }}');
    {% if report.company %}{% endif %}
    formData.append('company', '{{ report.company.id }}');
    
    // Submit export request
    fetch('{% url "trial_balance:export_trial_balance" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `trial_balance_{{ report.report_number }}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Export failed. Please try again.');
    });
}
</script>
{% endblock %}