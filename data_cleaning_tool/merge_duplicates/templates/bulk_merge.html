{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Merge - Merge Duplicates{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="h3 mb-0">
                    <i class="fas fa-object-group text-primary me-2"></i>
                    Bulk Merge Operations
                </h1>
                <p class="text-muted">Perform bulk merge operations on duplicate records with advanced configuration</p>
            </div>
        </div>
    </div>

    <!-- Actions Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{% url 'data_cleaning_tool:merge_duplicates_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
                <div>
                    <button type="button" class="btn btn-success" id="startBulkMerge">
                        <i class="fas fa-play me-2"></i>Start Bulk Merge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Bulk Merge Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="bulkMergeForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetModel" class="form-label">
                                        Target Model <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="targetModel" required>
                                        <option value="">Select Model</option>
                                        <option value="customer">Customer</option>
                                        <option value="supplier">Supplier</option>
                                        <option value="item">Item</option>
                                        <option value="employee">Employee</option>
                                        <option value="asset">Asset</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="similarityThreshold" class="form-label">
                                        Similarity Threshold <span class="text-danger">*</span>
                                    </label>
                                    <input type="range" class="form-range" id="similarityThreshold" 
                                           min="50" max="100" value="80" step="5">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">50%</small>
                                        <small class="text-muted">80%</small>
                                        <small class="text-muted">100%</small>
                                    </div>
                                    <div class="text-center mt-1">
                                        <span class="badge bg-primary" id="thresholdValue">80%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxGroupSize" class="form-label">
                                        Max Group Size <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="maxGroupSize" 
                                           min="2" max="100" value="10" required>
                                    <small class="form-text text-muted">
                                        Maximum number of records in a duplicate group
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mergeStrategy" class="form-label">
                                        Merge Strategy <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="mergeStrategy" required>
                                        <option value="keep_most_recent">Keep Most Recent</option>
                                        <option value="keep_most_complete">Keep Most Complete</option>
                                        <option value="manual_review">Manual Review Required</option>
                                        <option value="custom_rules">Custom Rules</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="fieldsToCompare" class="form-label">
                                Fields to Compare <span class="text-danger">*</span>
                            </label>
                            <div id="fieldsContainer">
                                <!-- Dynamic fields will be loaded here -->
                            </div>
                            <small class="form-text text-muted">
                                Select the fields to use for duplicate detection
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoMerge" checked>
                                        <label class="form-check-label" for="autoMerge">
                                            Enable Auto-merge for High Confidence
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="createBackup">
                                        <label class="form-check-label" for="createBackup">
                                            Create Backup Before Merging
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notificationEmail" class="form-label">
                                Notification Email
                            </label>
                            <input type="email" class="form-control" id="notificationEmail" 
                                   placeholder="email@example.com">
                            <small class="form-text text-muted">
                                Email to notify when bulk merge completes
                            </small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Progress Panel -->
            <div class="card shadow mt-4" id="progressPanel" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Merge Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="mergeProgress">
                            0%
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6 class="text-muted">Records Processed</h6>
                            <h4 id="recordsProcessed">0</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Duplicates Found</h6>
                            <h4 id="duplicatesFound">0</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Records Merged</h6>
                            <h4 id="recordsMerged">0</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Errors</h6>
                            <h4 id="errorCount">0</h4>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-danger" id="stopMerge">
                            <i class="fas fa-stop me-2"></i>Stop Merge
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Merge Statistics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Current Status</h6>
                        <p class="mb-0" id="currentStatus">Ready to start bulk merge operation</p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h6>
                        <ul class="mb-0 small">
                            <li>Bulk merge operations cannot be undone</li>
                            <li>Ensure data backup before proceeding</li>
                            <li>Monitor system resources during operation</li>
                            <li>Review results after completion</li>
                        </ul>
                    </div>

                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Best Practices</h6>
                        <ul class="mb-0 small">
                            <li>Start with high similarity thresholds</li>
                            <li>Test on small datasets first</li>
                            <li>Use appropriate merge strategies</li>
                            <li>Monitor progress and logs</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmBulkMergeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Bulk Merge Operation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This operation will permanently merge duplicate records and cannot be undone.
                </div>
                
                <h6>Merge Configuration Summary:</h6>
                <ul>
                    <li><strong>Target Model:</strong> <span id="confirmModel"></span></li>
                    <li><strong>Similarity Threshold:</strong> <span id="confirmThreshold"></span></li>
                    <li><strong>Max Group Size:</strong> <span id="confirmGroupSize"></span></li>
                    <li><strong>Merge Strategy:</strong> <span id="confirmStrategy"></span></li>
                    <li><strong>Auto-merge:</strong> <span id="confirmAutoMerge"></span></li>
                    <li><strong>Backup:</strong> <span id="confirmBackup"></span></li>
                </ul>
                
                <p class="text-muted">
                    Estimated processing time: <strong id="estimatedTime">Calculating...</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmMerge">Start Bulk Merge</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Update threshold display
    $('#similarityThreshold').on('input', function() {
        $('#thresholdValue').text($(this).val() + '%');
    });
    
    // Load fields when model changes
    $('#targetModel').on('change', function() {
        loadFieldsForModel($(this).val());
    });
    
    // Start bulk merge
    $('#startBulkMerge').on('click', function() {
        if (validateForm()) {
            showConfirmationModal();
        }
    });
    
    // Confirm merge
    $('#confirmMerge').on('click', function() {
        $('#confirmBulkMergeModal').modal('hide');
        startBulkMerge();
    });
    
    // Stop merge
    $('#stopMerge').on('click', function() {
        if (confirm('Are you sure you want to stop the merge operation?')) {
            stopBulkMerge();
        }
    });
});

function loadFieldsForModel(model) {
    const fieldsContainer = $('#fieldsContainer');
    fieldsContainer.empty();
    
    if (!model) return;
    
    const fields = getFieldsForModel(model);
    fields.forEach(field => {
        const fieldHtml = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${field.value}" 
                       id="field_${field.value}" ${field.required ? 'checked disabled' : ''}>
                <label class="form-check-label" for="field_${field.value}">
                    ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                </label>
            </div>
        `;
        fieldsContainer.append(fieldHtml);
    });
}

function getFieldsForModel(model) {
    const fieldMappings = {
        'customer': [
            { value: 'name', label: 'Customer Name', required: true },
            { value: 'email', label: 'Email Address', required: false },
            { value: 'phone', label: 'Phone Number', required: false },
            { value: 'address', label: 'Address', required: false },
            { value: 'company', label: 'Company', required: false }
        ],
        'supplier': [
            { value: 'name', label: 'Supplier Name', required: true },
            { value: 'email', label: 'Email Address', required: false },
            { value: 'phone', label: 'Phone Number', required: false },
            { value: 'address', label: 'Address', required: false },
            { value: 'company', label: 'Company', required: false }
        ],
        'item': [
            { value: 'name', label: 'Item Name', required: true },
            { value: 'code', label: 'Item Code', required: false },
            { value: 'description', label: 'Description', required: false },
            { value: 'category', label: 'Category', required: false }
        ],
        'employee': [
            { value: 'name', label: 'Employee Name', required: true },
            { value: 'email', label: 'Email Address', required: false },
            { value: 'employee_id', label: 'Employee ID', required: false },
            { value: 'department', label: 'Department', required: false }
        ],
        'asset': [
            { value: 'name', label: 'Asset Name', required: true },
            { value: 'asset_tag', label: 'Asset Tag', required: false },
            { value: 'serial_number', label: 'Serial Number', required: false },
            { value: 'category', label: 'Category', required: false }
        ]
    };
    
    return fieldMappings[model] || [];
}

function validateForm() {
    const targetModel = $('#targetModel').val();
    const maxGroupSize = $('#maxGroupSize').val();
    
    if (!targetModel) {
        alert('Please select a target model.');
        return false;
    }
    
    if (!maxGroupSize || maxGroupSize < 2) {
        alert('Please enter a valid maximum group size (minimum 2).');
        return false;
    }
    
    // Check if at least one field is selected
    const selectedFields = $('input[name="fields"]:checked').length;
    if (selectedFields === 0) {
        alert('Please select at least one field to compare.');
        return false;
    }
    
    return true;
}

function showConfirmationModal() {
    $('#confirmModel').text($('#targetModel option:selected').text());
    $('#confirmThreshold').text($('#similarityThreshold').val() + '%');
    $('#confirmGroupSize').text($('#maxGroupSize').val());
    $('#confirmStrategy').text($('#mergeStrategy option:selected').text());
    $('#confirmAutoMerge').text($('#autoMerge').is(':checked') ? 'Enabled' : 'Disabled');
    $('#confirmBackup').text($('#createBackup').is(':checked') ? 'Yes' : 'No');
    
    // Calculate estimated time
    const estimatedTime = calculateEstimatedTime();
    $('#estimatedTime').text(estimatedTime);
    
    $('#confirmBulkMergeModal').modal('show');
}

function calculateEstimatedTime() {
    // This would typically make an API call to get record count
    // For now, return a placeholder
    return '5-15 minutes (estimated)';
}

function startBulkMerge() {
    // Show progress panel
    $('#progressPanel').show();
    $('#currentStatus').text('Starting bulk merge operation...');
    
    // Simulate progress (in real implementation, this would be AJAX calls)
    simulateProgress();
}

function simulateProgress() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            completeBulkMerge();
        }
        
        updateProgress(progress);
    }, 1000);
}

function updateProgress(progress) {
    $('#mergeProgress').css('width', progress + '%').text(Math.round(progress) + '%');
    
    // Update statistics
    const recordsProcessed = Math.floor(progress * 1000 / 100);
    const duplicatesFound = Math.floor(recordsProcessed * 0.1);
    const recordsMerged = Math.floor(duplicatesFound * 0.8);
    const errors = Math.floor(duplicatesFound * 0.02);
    
    $('#recordsProcessed').text(recordsProcessed);
    $('#duplicatesFound').text(duplicatesFound);
    $('#recordsMerged').text(recordsMerged);
    $('#errorCount').text(errors);
    
    if (progress < 100) {
        $('#currentStatus').text(`Processing records... ${Math.round(progress)}% complete`);
    }
}

function completeBulkMerge() {
    $('#currentStatus').text('Bulk merge operation completed successfully!');
    $('#stopMerge').hide();
    
    // Show completion message
    setTimeout(() => {
        alert('Bulk merge operation completed successfully!');
        $('#progressPanel').hide();
    }, 2000);
}

function stopBulkMerge() {
    $('#currentStatus').text('Bulk merge operation stopped by user.');
    $('#stopMerge').hide();
    
    setTimeout(() => {
        $('#progressPanel').hide();
    }, 2000);
}
</script>
{% endblock %}
