{% extends 'base.html' %}
{% load static %}

{% block title %}Test SMS Gateway - {{ gateway.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sms_gateway/css/dashboard.css' %}">
<style>
    .test-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .test-section h5 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .test-result {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border-left: 4px solid;
    }
    
    .test-result.success {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
    }
    
    .test-result.failed {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }
    
    .test-result.pending {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }
    
    .test-result.in-progress {
        background-color: #d1ecf1;
        border-color: #17a2b8;
        color: #0c5460;
    }
    
    .progress-bar {
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .test-checkbox {
        margin-bottom: 15px;
    }
    
    .test-checkbox .form-check-input:checked + .form-check-label {
        color: #007bff;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-vial fa-fw"></i> Test SMS Gateway: {{ gateway.name }}
        </h1>
        <div class="btn-group" role="group">
            <a href="{% url 'sms_gateway:gateway_detail' pk=gateway.pk %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left fa-fw"></i> Back to Gateway
            </a>
            <a href="{% url 'sms_gateway:gateway_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-list fa-fw"></i> All Gateways
            </a>
        </div>
    </div>

    <!-- Gateway Info -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Gateway Information</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Type:</strong> {{ gateway.get_gateway_type_display }}</p>
                    <p><strong>API URL:</strong> {{ gateway.api_url }}</p>
                    <p><strong>Sender ID:</strong> {{ gateway.sender_id }}</p>
                    <p><strong>Status:</strong> 
                        {% if gateway.is_active %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-secondary">Inactive</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Last Test:</strong> 
                        {% if gateway.last_tested %}
                            {{ gateway.last_tested|date:"M d, Y H:i" }}
                        {% else %}
                            <span class="text-muted">Never tested</span>
                        {% endif %}
                    </p>
                    <p><strong>Test Status:</strong> 
                        {% if gateway.last_test_status == 'success' %}
                            <span class="badge badge-success">Healthy</span>
                        {% elif gateway.last_test_status == 'failed' %}
                            <span class="badge badge-danger">Unhealthy</span>
                        {% else %}
                            <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    </p>
                    <p><strong>Support Unicode:</strong> 
                        {% if gateway.support_unicode %}
                            <span class="badge badge-success">Yes</span>
                        {% else %}
                            <span class="badge badge-warning">No</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Configuration -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Test Configuration</h6>
        </div>
        <div class="card-body">
            <form method="post" id="testForm">
                {% csrf_token %}
                
                <!-- Test Selection -->
                <div class="test-section">
                    <h5><i class="fas fa-check-square"></i> Select Tests to Run</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_connection" name="test_connection" checked>
                                    <label class="form-check-label" for="test_connection">
                                        <strong>Connection Test</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Test API connection and endpoint accessibility
                                    </small>
                                </div>
                            </div>
                            
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_authentication" name="test_authentication" checked>
                                    <label class="form-check-label" for="test_authentication">
                                        <strong>Authentication Test</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Test API credentials and authentication
                                    </small>
                                </div>
                            </div>
                            
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_message_send" name="test_message_send">
                                    <label class="form-check-label" for="test_message_send">
                                        <strong>Message Send Test</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Send a test message to verify delivery
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_unicode" name="test_unicode">
                                    <label class="form-check-label" for="test_unicode">
                                        <strong>Unicode Test</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Test Unicode character support
                                    </small>
                                </div>
                            </div>
                            
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_rate_limits" name="test_rate_limits">
                                    <label class="form-check-label" for="test_rate_limits">
                                        <strong>Rate Limit Test</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Test rate limiting behavior
                                    </small>
                                </div>
                            </div>
                            
                            <div class="test-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_performance_metrics" name="include_performance_metrics" checked>
                                    <label class="form-check-label" for="include_performance_metrics">
                                        <strong>Performance Metrics</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Include performance metrics in results
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Parameters -->
                <div class="test-section">
                    <h5><i class="fas fa-cogs"></i> Test Parameters</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="test_recipient" class="form-label">
                                    Test Recipient Number
                                </label>
                                <input type="text" class="form-control" id="test_recipient" name="test_recipient" 
                                       placeholder="+971501234567" value="+971501234567">
                                <small class="form-text text-muted">
                                    Phone number for message tests (required if message tests are selected)
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="test_environment" class="form-label">
                                    Test Environment
                                </label>
                                <select class="form-control" id="test_environment" name="test_environment">
                                    <option value="production">Production</option>
                                    <option value="staging">Staging</option>
                                    <option value="development">Development</option>
                                </select>
                                <small class="form-text text-muted">
                                    Environment for testing
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="test_message" class="form-label">
                                    Test Message Content
                                </label>
                                <textarea class="form-control" id="test_message" name="test_message" rows="3" 
                                          placeholder="Enter test message content...">Test message from {{ gateway.name }} - {{ gateway.sender_id }}</textarea>
                                <small class="form-text text-muted">
                                    Message content for send tests
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unicode_test_message" class="form-label">
                                    Unicode Test Message
                                </label>
                                <textarea class="form-control" id="unicode_test_message" name="unicode_test_message" rows="3" 
                                          placeholder="مرحبا بالعالم! 🌍 Hello World! 你好世界！">مرحبا بالعالم! 🌍 Hello World! 你好世界！</textarea>
                                <small class="form-text text-muted">
                                    Message with Arabic, emojis, and other characters
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Actions -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'sms_gateway:gateway_detail' pk=gateway.pk %}" class="btn btn-secondary">
                        <i class="fas fa-times fa-fw"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="runTestsBtn">
                        <i class="fas fa-play fa-fw"></i> Run Tests
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Results -->
    <div class="card shadow" id="testResultsCard" style="display: none;">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Test Results</h6>
        </div>
        <div class="card-body">
            <!-- Progress Bar -->
            <div class="mb-4">
                <h6>Test Progress</h6>
                <div class="progress progress-bar">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="testProgress">
                        0%
                    </div>
                </div>
            </div>

            <!-- Test Results Container -->
            <div id="testResultsContainer">
                <!-- Results will be populated here -->
            </div>

            <!-- Test Summary -->
            <div class="mt-4" id="testSummary" style="display: none;">
                <h6>Test Summary</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success" id="successCount">0</h4>
                            <p class="text-muted">Successful</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger" id="failedCount">0</h4>
                            <p class="text-muted">Failed</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info" id="totalCount">0</h4>
                            <p class="text-muted">Total Tests</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning" id="avgResponseTime">0s</h4>
                            <p class="text-muted">Avg Response</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4" id="testActions" style="display: none;">
                <button class="btn btn-success" onclick="exportTestResults()">
                    <i class="fas fa-download fa-fw"></i> Export Results
                </button>
                <button class="btn btn-info" onclick="viewDetailedResults()">
                    <i class="fas fa-eye fa-fw"></i> View Detailed Results
                </button>
                <button class="btn btn-primary" onclick="runTestsAgain()">
                    <i class="fas fa-redo fa-fw"></i> Run Tests Again
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'sms_gateway/js/dashboard.js' %}"></script>
<script>
let testResults = [];
let currentTestIndex = 0;
let totalTests = 0;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('testForm');
    const runTestsBtn = document.getElementById('runTestsBtn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        runTests();
    });
    
    // Update test message when gateway name changes
    const testMessageInput = document.getElementById('test_message');
    testMessageInput.value = `Test message from {{ gateway.name }} - {{ gateway.sender_id }}`;
});

function runTests() {
    const form = document.getElementById('testForm');
    const formData = new FormData(form);
    
    // Get selected tests
    const selectedTests = [];
    const testCheckboxes = ['test_connection', 'test_authentication', 'test_message_send', 'test_unicode', 'test_rate_limits'];
    
    testCheckboxes.forEach(test => {
        if (formData.get(test)) {
            selectedTests.push(test);
        }
    });
    
    if (selectedTests.length === 0) {
        alert('Please select at least one test to run.');
        return;
    }
    
    // Validate recipient number for message tests
    if ((formData.get('test_message_send') || formData.get('test_unicode')) && !formData.get('test_recipient')) {
        alert('Recipient number is required for message tests.');
        return;
    }
    
    // Show test results section
    document.getElementById('testResultsCard').style.display = 'block';
    
    // Initialize test progress
    totalTests = selectedTests.length;
    currentTestIndex = 0;
    testResults = [];
    
    // Clear previous results
    document.getElementById('testResultsContainer').innerHTML = '';
    document.getElementById('testSummary').style.display = 'none';
    document.getElementById('testActions').style.display = 'none';
    
    // Disable form
    document.getElementById('runTestsBtn').disabled = true;
    document.getElementById('runTestsBtn').innerHTML = '<i class="fas fa-spinner fa-spin fa-fw"></i> Running Tests...';
    
    // Run tests sequentially
    runTestSequence(selectedTests, formData);
}

function runTestSequence(tests, formData) {
    if (currentTestIndex >= tests.length) {
        // All tests completed
        showTestSummary();
        return;
    }
    
    const currentTest = tests[currentTestIndex];
    const testName = getTestDisplayName(currentTest);
    
    // Add test result placeholder
    addTestResult(currentTest, 'in-progress', `Running ${testName}...`);
    
    // Update progress
    updateProgress();
    
    // Simulate test execution (replace with actual API call)
    setTimeout(() => {
        // Simulate test result
        const success = Math.random() > 0.3; // 70% success rate for demo
        const responseTime = (Math.random() * 2 + 0.5).toFixed(3);
        
        const result = {
            test: currentTest,
            name: testName,
            success: success,
            status: success ? 'success' : 'failed',
            responseTime: responseTime,
            message: success ? `${testName} completed successfully` : `${testName} failed`,
            details: success ? `Response time: ${responseTime}s` : 'Check gateway configuration'
        };
        
        testResults.push(result);
        updateTestResult(currentTest, result);
        
        currentTestIndex++;
        runTestSequence(tests, formData);
    }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
}

function getTestDisplayName(testType) {
    const names = {
        'test_connection': 'Connection Test',
        'test_authentication': 'Authentication Test',
        'test_message_send': 'Message Send Test',
        'test_unicode': 'Unicode Test',
        'test_rate_limits': 'Rate Limit Test'
    };
    return names[testType] || testType;
}

function addTestResult(testType, status, message) {
    const container = document.getElementById('testResultsContainer');
    const resultDiv = document.createElement('div');
    resultDiv.className = `test-result ${status}`;
    resultDiv.id = `result-${testType}`;
    resultDiv.innerHTML = `
        <h6><i class="fas fa-vial"></i> ${getTestDisplayName(testType)}</h6>
        <p class="mb-0">${message}</p>
    `;
    container.appendChild(resultDiv);
}

function updateTestResult(testType, result) {
    const resultDiv = document.getElementById(`result-${testType}`);
    if (resultDiv) {
        resultDiv.className = `test-result ${result.status}`;
        resultDiv.innerHTML = `
            <h6><i class="fas fa-vial"></i> ${result.name}</h6>
            <p class="mb-0">${result.message}</p>
            <small class="d-block mt-2">${result.details}</small>
        `;
    }
}

function updateProgress() {
    const progress = ((currentTestIndex + 1) / totalTests) * 100;
    const progressBar = document.getElementById('testProgress');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${Math.round(progress)}%`;
}

function showTestSummary() {
    const successCount = testResults.filter(r => r.success).length;
    const failedCount = testResults.filter(r => !r.success).length;
    const avgResponseTime = testResults.reduce((sum, r) => sum + parseFloat(r.responseTime), 0) / testResults.length;
    
    document.getElementById('successCount').textContent = successCount;
    document.getElementById('failedCount').textContent = failedCount;
    document.getElementById('totalCount').textContent = totalTests;
    document.getElementById('avgResponseTime').textContent = avgResponseTime.toFixed(3) + 's';
    
    document.getElementById('testSummary').style.display = 'block';
    document.getElementById('testActions').style.display = 'block';
    
    // Re-enable form
    document.getElementById('runTestsBtn').disabled = false;
    document.getElementById('runTestsBtn').innerHTML = '<i class="fas fa-play fa-fw"></i> Run Tests';
}

function exportTestResults() {
    const data = {
        gateway: '{{ gateway.name }}',
        timestamp: new Date().toISOString(),
        results: testResults,
        summary: {
            total: totalTests,
            success: testResults.filter(r => r.success).length,
            failed: testResults.filter(r => !r.success).length
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sms_gateway_test_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function viewDetailedResults() {
    // Navigate to test results list
    window.location.href = "{% url 'sms_gateway:test_results_list' %}";
}

function runTestsAgain() {
    // Reset and run tests again
    document.getElementById('testResultsCard').style.display = 'none';
    document.getElementById('testForm').reset();
}
</script>
{% endblock %}
