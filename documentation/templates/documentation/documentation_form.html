{% extends 'documentation/base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Documentation{% else %}Create New Documentation{% endif %}
{% endblock %}

{% block documentation_content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-text me-2"></i>
                    {% if form.instance.pk %}
                        Edit Documentation
                    {% else %}
                        Create New Documentation
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" class="documentation-form">
                    {% csrf_token %}
                    
                    <!-- Two Column Layout -->
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-info-circle me-2"></i>Document Information
                            </h6>
                            <!-- Document No and Document Type on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.document_no.id_for_label }}" class="form-label">
                                        Document No 
                                        <small class="text-muted">(Auto-generated)</small>
                                    </label>
                                    {{ form.document_no }}
                                    {% if form.document_no.errors %}
                                        <div class="text-danger">
                                            {% for error in form.document_no.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.document_type.id_for_label }}" class="form-label">Document Type</label>
                                    {{ form.document_type }}
                                    {% if form.document_type.errors %}
                                        <div class="text-danger">
                                            {% for error in form.document_type.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Customer -->
                            <div class="mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label">Customer</label>
                                {{ form.customer }}
                                {% if form.customer.errors %}
                                    <div class="text-danger">
                                        {% for error in form.customer.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Bill To -->
                            <div class="mb-3">
                                <label for="{{ form.bill_to.id_for_label }}" class="form-label">Bill To</label>
                                {{ form.bill_to }}
                                {% if form.bill_to.errors %}
                                    <div class="text-danger">
                                        {% for error in form.bill_to.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Bill to Address -->
                            <div class="mb-3">
                                <label for="{{ form.bill_to_address.id_for_label }}" class="form-label">Bill to Address</label>
                                {{ form.bill_to_address }}
                                {% if form.bill_to_address.errors %}
                                    <div class="text-danger">
                                        {% for error in form.bill_to_address.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Deliver to -->
                            <div class="mb-3">
                                <label for="{{ form.deliver_to.id_for_label }}" class="form-label">Deliver to</label>
                                {{ form.deliver_to }}
                                {% if form.deliver_to.errors %}
                                    <div class="text-danger">
                                        {% for error in form.deliver_to.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Deliver to Address -->
                            <div class="mb-3">
                                <label for="{{ form.deliver_to_address.id_for_label }}" class="form-label">Deliver to Address</label>
                                {{ form.deliver_to_address }}
                                {% if form.deliver_to_address.errors %}
                                    <div class="text-danger">
                                        {% for error in form.deliver_to_address.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                        </div>
                        
                        <!-- Right Column -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-calendar-event me-2"></i>Shipping Details
                            </h6>
                            
                            <!-- Date and Payment Mode on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
                                    {{ form.date }}
                                    {% if form.date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.date.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.payment_mode.id_for_label }}" class="form-label">Payment Mode</label>
                                    {{ form.payment_mode }}
                                    {% if form.payment_mode.errors %}
                                        <div class="text-danger">
                                            {% for error in form.payment_mode.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Container, BL Number and BOE on same line -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.container.id_for_label }}" class="form-label">Container</label>
                                    {{ form.container }}
                                    {% if form.container.errors %}
                                        <div class="text-danger">
                                            {% for error in form.container.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.bl_number.id_for_label }}" class="form-label">BL Number</label>
                                    {{ form.bl_number }}
                                    {% if form.bl_number.errors %}
                                        <div class="text-danger">
                                            {% for error in form.bl_number.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.boe.id_for_label }}" class="form-label">BOE</label>
                                    {{ form.boe }}
                                    {% if form.boe.errors %}
                                        <div class="text-danger">
                                            {% for error in form.boe.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Exit Point and Destination on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.exit_point.id_for_label }}" class="form-label">Exit Point</label>
                                    {{ form.exit_point }}
                                    {% if form.exit_point.errors %}
                                        <div class="text-danger">
                                            {% for error in form.exit_point.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.destination.id_for_label }}" class="form-label">Destination</label>
                                    {{ form.destination }}
                                    {% if form.destination.errors %}
                                        <div class="text-danger">
                                            {% for error in form.destination.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Ship Mode and Ship Date on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.ship_mode.id_for_label }}" class="form-label">Ship Mode</label>
                                    {{ form.ship_mode }}
                                    {% if form.ship_mode.errors %}
                                        <div class="text-danger">
                                            {% for error in form.ship_mode.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.ship_date.id_for_label }}" class="form-label">Ship Date</label>
                                    {{ form.ship_date }}
                                    {% if form.ship_date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.ship_date.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Vessel and Voyage on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.vessel.id_for_label }}" class="form-label">Vessel</label>
                                    {{ form.vessel }}
                                    {% if form.vessel.errors %}
                                        <div class="text-danger">
                                            {% for error in form.vessel.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.voyage.id_for_label }}" class="form-label">Voyage</label>
                                    {{ form.voyage }}
                                    {% if form.voyage.errors %}
                                        <div class="text-danger">
                                            {% for error in form.voyage.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Delivery Terms (full width) -->
                            <div class="mb-3">
                                <label for="{{ form.delivery_terms.id_for_label }}" class="form-label">Delivery Terms</label>
                                {{ form.delivery_terms }}
                                {% if form.delivery_terms.errors %}
                                    <div class="text-danger">
                                        {% for error in form.delivery_terms.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Port of Loading and Discharge Port on same line -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.port_of_loading.id_for_label }}" class="form-label">Port of Loading</label>
                                    {{ form.port_of_loading }}
                                    {% if form.port_of_loading.errors %}
                                        <div class="text-danger">
                                            {% for error in form.port_of_loading.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.discharge_port.id_for_label }}" class="form-label">Discharge Port</label>
                                    {{ form.discharge_port }}
                                    {% if form.discharge_port.errors %}
                                        <div class="text-danger">
                                            {% for error in form.discharge_port.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cargo Selection Section - Below Main Form -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-box-seam me-2"></i>Available Cargo Items
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="cargo-selection">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>
                                                            <input type="checkbox" id="select-all-cargo" class="form-check-input">
                                                        </th>
                                                        <th>Job No</th>
                                                        <th>Item Code</th>
                                                        <th>Item</th>
                                                        <th>HS Code</th>
                                                        <th>Unit</th>
                                                        <th>QTY</th>
                                                        <th>COO</th>
                                                        <th>N-weight</th>
                                                        <th>G-weight</th>
                                                        <th>Rate</th>
                                                        <th>Amount</th>
                                                        <th>ED</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cargo-items-tbody">
                                                    <tr>
                                                        <td colspan="13" class="text-center text-muted">
                                                            Select a customer to view available cargo items
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" id="add-selected-cargo" class="btn btn-primary btn-sm" disabled>
                                                <i class="bi bi-plus-circle me-1"></i>Add Selected Cargo
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Cargo Summary -->
                                    <div id="selected-cargo-summary" class="mt-3" style="display: none;">
                                        <h6 class="text-primary">Selected Cargo Items</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Job No</th>
                                                        <th>Item Code</th>
                                                        <th>Item</th>
                                                        <th>HS Code</th>
                                                        <th>Unit</th>
                                                        <th>QTY</th>
                                                        <th>COO</th>
                                                        <th>N-weight</th>
                                                        <th>G-weight</th>
                                                        <th>Rate</th>
                                                        <th>Amount</th>
                                                        <th>ED</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="selected-cargo-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field to store selected cargo items -->
                    <input type="hidden" name="selected_cargo_items" id="selected_cargo_items_data" value="">
                    
                    <!-- Hidden div to store existing cargo items data for editing -->
                    {% if form.instance.pk and form.instance.cargo_items.exists %}
                        <div id="existing-cargo-data" 
                             data-cargo-items='[
                                 {% for cargo in form.instance.cargo_items.all %}
                                 {
                                     "id": "{{ cargo.job_cargo.id }}",
                                     "job_id": "{{ cargo.job_cargo.job.id }}",
                                     "job_code": "{{ cargo.job_cargo.job.job_code }}",
                                     "item_code": "{{ cargo.item_code|default:"" }}",
                                     "item_name": "{{ cargo.item_name|default:"" }}",
                                     "hs_code": "{{ cargo.hs_code|default:"" }}",
                                     "unit": "{{ cargo.unit|default:"" }}",
                                     "quantity": "{{ cargo.quantity|default:0 }}",
                                     "coo": "{{ cargo.coo|default:"" }}",
                                     "n_weight": "{{ cargo.net_weight|default:"" }}",
                                     "g_weight": "{{ cargo.gross_weight|default:"" }}",
                                     "rate": "{{ cargo.rate|default:0 }}",
                                     "amount": "{{ cargo.amount|default:"" }}",
                                     "ed": "{{ cargo.job_cargo.job.containers.first.ed_number|default:"" }}"
                                 }{% if not forloop.last %},{% endif %}
                                 {% endfor %}
                             ]' style="display: none;"></div>
                    {% endif %}
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.pk %}
                                <i class="bi bi-check-circle me-1"></i>Update Documentation
                            {% else %}
                                <i class="bi bi-plus-circle me-1"></i>Create Documentation
                            {% endif %}
                        </button>
                        <a href="{% url 'documentation:documentation_list' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JSON data for existing cargo items -->
{% if form.instance.pk and form.instance.cargo_items.exists %}
<script type="application/json" id="existing-cargo-json">
[
    {% for cargo in form.instance.cargo_items.all %}
    {
        "id": "{{ cargo.job_cargo.id }}",
        "job_id": "{{ cargo.job_cargo.job.id }}",
        "job_code": "{{ cargo.job_cargo.job.job_code }}",
        "item_code": "{{ cargo.item_code|default:"" }}",
        "item_name": "{{ cargo.item_name|default:"" }}",
        "hs_code": "{{ cargo.hs_code|default:"" }}",
        "unit": "{{ cargo.unit|default:"" }}",
        "quantity": "{{ cargo.quantity|default:0 }}",
        "coo": "{{ cargo.coo|default:"" }}",
        "n_weight": "{{ cargo.net_weight|default:"" }}",
        "g_weight": "{{ cargo.gross_weight|default:"" }}",
        "rate": "{{ cargo.rate|default:0 }}",
        "amount": "{{ cargo.amount|default:"" }}",
        "ed": "{{ cargo.job_cargo.job.containers.first.ed_number|default:"" }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
{% endif %}

<!-- JavaScript for Cargo Selection -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
    const cargoSelection = document.getElementById('cargo-selection');
    const cargoItemsTbody = document.getElementById('cargo-items-tbody');
    const selectAllCargo = document.getElementById('select-all-cargo');
    const addSelectedCargoBtn = document.getElementById('add-selected-cargo');
    const selectedCargoSummary = document.getElementById('selected-cargo-summary');
    const selectedCargoTbody = document.getElementById('selected-cargo-tbody');
    
    let selectedCargoItems = [];
    
    // Load existing cargo items if editing
    const existingCargoJson = document.getElementById('existing-cargo-json');
    if (existingCargoJson) {
        try {
            const existingCargoData = JSON.parse(existingCargoJson.textContent);
            if (existingCargoData && existingCargoData.length > 0) {
                selectedCargoItems = existingCargoData;
                
                // Display existing cargo items
                selectedCargoTbody.innerHTML = '';
                selectedCargoItems.forEach(cargo => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cargo.job_code}</td>
                        <td>${cargo.item_code}</td>
                        <td>${cargo.item_name}</td>
                        <td>${cargo.hs_code}</td>
                        <td>${cargo.unit}</td>
                        <td>${cargo.quantity}</td>
                        <td>${cargo.coo}</td>
                        <td>${cargo.n_weight}</td>
                        <td>${cargo.g_weight}</td>
                        <td>${cargo.rate}</td>
                        <td>${cargo.amount}</td>
                        <td>${cargo.ed || '-'}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCargoItem('${cargo.id}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    `;
                    selectedCargoTbody.appendChild(row);
                });
                selectedCargoSummary.style.display = 'block';
            }
        } catch (e) {
            console.error('Error parsing existing cargo data:', e);
        }
    }
    
    // Handle form submission to save cargo items
    const form = document.querySelector('.documentation-form');
    form.addEventListener('submit', function(e) {
        // Update the hidden field with selected cargo items data
        const hiddenField = document.getElementById('selected_cargo_items_data');
        hiddenField.value = JSON.stringify(selectedCargoItems);
        console.log('Saving cargo items:', selectedCargoItems); // Debug
        
        // Ensure form data is properly set before submission
        console.log('Form data before submission:', new FormData(form));
        
        // Allow form to submit normally
        return true;
    });
    
    // Handle customer selection change
    customerSelect.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
            loadCustomerCargo(customerId);
        } else {
            hideCargoSelection();
        }
    });
    
    // Event delegation for checkbox changes
    cargoItemsTbody.addEventListener('change', function(e) {
        if (e.target.classList.contains('cargo-checkbox')) {
            updateAddButton();
        }
    });
    
    // Select all functionality
    selectAllCargo.addEventListener('change', function() {
        const checkboxes = cargoItemsTbody.querySelectorAll('.cargo-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateAddButton();
    });
    
    // Handle add selected cargo button
    addSelectedCargoBtn.addEventListener('click', function() {
        addSelectedCargo();
    });
    
    function loadCustomerCargo(customerId) {
        // Show loading state
        cargoItemsTbody.innerHTML = '<tr><td colspan="14" class="text-center">Loading cargo items...</td></tr>';
        
        // Fetch cargo items via AJAX
        fetch(`/documentation/get-customer-cargo/${customerId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.cargo_items.length > 0) {
                    displayCargoItems(data.cargo_items);
                } else {
                    cargoItemsTbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">No cargo items found for this customer</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading cargo items:', error);
                cargoItemsTbody.innerHTML = '<tr><td colspan="14" class="text-center text-danger">Error loading cargo items</td></tr>';
            });
    }
    
    function displayCargoItems(cargoItems) {
        if (cargoItems.length === 0) {
            cargoItemsTbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">No cargo items found for this customer</td></tr>';
            return;
        }
        
        cargoItemsTbody.innerHTML = '';
        cargoItems.forEach(cargo => {
            // Create balance info text
            let balanceInfo = '';
            if (cargo.used_quantity && parseFloat(cargo.used_quantity) > 0) {
                balanceInfo = `<br><small class="text-muted">Balance: ${cargo.quantity} / ${cargo.original_quantity} (Used: ${cargo.used_quantity})</small>`;
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input cargo-checkbox" data-cargo-id="${cargo.id}" data-job-id="${cargo.job_id}">
                </td>
                <td>${cargo.job_code}</td>
                <td>${cargo.item_code || '-'}</td>
                <td>${cargo.item_name || '-'}</td>
                <td>${cargo.hs_code || '-'}</td>
                <td>${cargo.unit || '-'}</td>
                <td>
                    <input type="number" class="form-control form-control-sm cargo-qty" 
                           value="${cargo.quantity || 0}" 
                           min="0" 
                           max="${cargo.quantity || 0}"
                           step="0.01"
                           data-original-qty="${cargo.quantity || 0}"
                           data-original-n-weight="${cargo.n_weight || 0}"
                           data-original-g-weight="${cargo.g_weight || 0}"
                           onchange="calculateCargoValues(this)">
                    ${balanceInfo}
                </td>
                <td>${cargo.coo || '-'}</td>
                <td>
                    <span class="cargo-n-weight">${cargo.n_weight || '-'}</span>
                </td>
                <td>
                    <span class="cargo-g-weight">${cargo.g_weight || '-'}</span>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm cargo-rate" 
                           value="${cargo.rate || 0}" 
                           min="${cargo.rate || 0}"
                           step="0.01"
                           data-original-rate="${cargo.rate || 0}"
                           onchange="validateAndCalculateRate(this)">
                </td>
                <td>
                    <span class="cargo-amount">${cargo.amount || '-'}</span>
                </td>
                <td>${cargo.ed || '-'}</td>
            `;
            cargoItemsTbody.appendChild(row);
        });
        
        // Add event listeners to checkboxes
        const checkboxes = cargoItemsTbody.querySelectorAll('.cargo-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateAddButton);
        });
    }
    
    function updateAddButton() {
        const checkedBoxes = document.querySelectorAll('.cargo-checkbox:checked');
        addSelectedCargoBtn.disabled = checkedBoxes.length === 0;
    }
    
    function addSelectedCargo() {
        selectedCargoItems = getSelectedCargoItems();
        
        if (selectedCargoItems.length === 0) {
            alert('Please select at least one cargo item.');
            return;
        }
        
        selectedCargoTbody.innerHTML = '';
        selectedCargoItems.forEach(cargo => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${cargo.job_code}</td>
                <td>${cargo.item_code}</td>
                <td>${cargo.item_name}</td>
                <td>${cargo.hs_code}</td>
                <td>${cargo.unit}</td>
                <td>${cargo.quantity}</td>
                <td>${cargo.coo}</td>
                <td>${cargo.n_weight}</td>
                <td>${cargo.g_weight}</td>
                <td>${cargo.rate}</td>
                <td>${cargo.amount}</td>
                <td>${cargo.ed || 'NO ED DATA'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCargoItem('${cargo.id}')">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            `;
            selectedCargoTbody.appendChild(row);
        });
        
        selectedCargoSummary.style.display = 'block';
        addSelectedCargoBtn.disabled = true;
        
        // Uncheck all checkboxes after adding
        document.querySelectorAll('.cargo-checkbox:checked').forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    function removeCargoItem(cargoId) {
        selectedCargoItems = selectedCargoItems.filter(cargo => cargo.id !== cargoId);
        
        if (selectedCargoItems.length === 0) {
            selectedCargoSummary.style.display = 'none';
        } else {
            // Refresh the display
            selectedCargoTbody.innerHTML = '';
            selectedCargoItems.forEach(cargo => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cargo.job_code}</td>
                    <td>${cargo.item_code}</td>
                    <td>${cargo.item_name}</td>
                    <td>${cargo.hs_code}</td>
                    <td>${cargo.unit}</td>
                    <td>${cargo.quantity}</td>
                    <td>${cargo.coo}</td>
                    <td>${cargo.n_weight}</td>
                    <td>${cargo.g_weight}</td>
                    <td>${cargo.rate}</td>
                    <td>${cargo.amount}</td>
                    <td>${cargo.ed || 'NO ED DATA'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCargoItem('${cargo.id}')">
                            <i class="bi bi-x"></i>
                        </button>
                    </td>
                `;
                selectedCargoTbody.appendChild(row);
            });
        }
    }
    
    function hideCargoSelection() {
        cargoItemsTbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">Select a customer to view available cargo items</td></tr>';
        selectedCargoSummary.style.display = 'none';
        selectedCargoItems = [];
    }
    
    // Make functions globally available
    window.removeCargoItem = removeCargoItem;
    window.calculateCargoValues = calculateCargoValues;
    window.calculateCargoAmount = calculateCargoAmount;
    window.validateAndCalculateRate = validateAndCalculateRate;

    function getSelectedCargoItems() {
        const selectedCargo = [];
        const checkedBoxes = document.querySelectorAll('.cargo-checkbox:checked');
        
        checkedBoxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const cells = row.cells;
            
            // Get the editable values
            const qtyInput = row.querySelector('.cargo-qty');
            const rateInput = row.querySelector('.cargo-rate');
            const nWeightSpan = row.querySelector('.cargo-n-weight');
            const gWeightSpan = row.querySelector('.cargo-g-weight');
            const amountSpan = row.querySelector('.cargo-amount');
            
            const cargoItem = {
                id: checkbox.dataset.cargoId,
                job_id: checkbox.dataset.jobId,
                job_code: cells[1].textContent,
                item_code: cells[2].textContent,
                item_name: cells[3].textContent,
                hs_code: cells[4].textContent,
                unit: cells[5].textContent,
                quantity: qtyInput ? qtyInput.value : '0',
                coo: cells[7].textContent,
                n_weight: nWeightSpan ? nWeightSpan.textContent : '-',
                g_weight: gWeightSpan ? gWeightSpan.textContent : '-',
                rate: rateInput ? rateInput.value : '0',
                amount: amountSpan ? amountSpan.textContent : '-',
                ed: cells[12] ? cells[12].textContent : '-'
            };
            
            selectedCargo.push(cargoItem);
        });
        
        return selectedCargo;
    }
    
    function calculateCargoValues(qtyInput) {
        const row = qtyInput.closest('tr');
        const originalQty = parseFloat(qtyInput.dataset.originalQty) || 0;
        const originalNWeight = parseFloat(qtyInput.dataset.originalNWeight) || 0;
        const originalGWeight = parseFloat(qtyInput.dataset.originalGWeight) || 0;
        const newQty = parseFloat(qtyInput.value) || 0;
        
        // Validate quantity - cannot exceed original quantity
        if (newQty > originalQty) {
            qtyInput.value = originalQty;
            alert(`Quantity cannot exceed the original quantity of ${originalQty}`);
            return;
        }
        
        // Calculate proportional weights
        let newNWeight = 0;
        let newGWeight = 0;
        
        if (originalQty > 0) {
            const ratio = newQty / originalQty;
            newNWeight = (originalNWeight * ratio).toFixed(2);
            newGWeight = (originalGWeight * ratio).toFixed(2);
        }
        
        // Update weight displays
        const nWeightSpan = row.querySelector('.cargo-n-weight');
        const gWeightSpan = row.querySelector('.cargo-g-weight');
        
        if (nWeightSpan) nWeightSpan.textContent = newNWeight > 0 ? newNWeight : '-';
        if (gWeightSpan) gWeightSpan.textContent = newGWeight > 0 ? newGWeight : '-';
        
        // Recalculate amount
        calculateCargoAmount(row.querySelector('.cargo-rate'));
    }
    
    function validateAndCalculateRate(rateInput) {
        const originalRate = parseFloat(rateInput.dataset.originalRate) || 0;
        const newRate = parseFloat(rateInput.value) || 0;
        
        // Validate rate - cannot be less than original rate
        if (newRate < originalRate) {
            rateInput.value = originalRate;
            alert(`Rate cannot be less than the original rate of ${originalRate}`);
            return;
        }
        
        // If validation passes, calculate amount
        calculateCargoAmount(rateInput);
    }
    
    function calculateCargoAmount(rateInput) {
        const row = rateInput.closest('tr');
        const qtyInput = row.querySelector('.cargo-qty');
        const newRate = parseFloat(rateInput.value) || 0;
        const newQty = parseFloat(qtyInput.value) || 0;
        
        const newAmount = (newQty * newRate).toFixed(2);
        
        // Update amount display
        const amountSpan = row.querySelector('.cargo-amount');
        if (amountSpan) amountSpan.textContent = newAmount > 0 ? newAmount : '-';
    }
});
</script>
{% endblock %} 