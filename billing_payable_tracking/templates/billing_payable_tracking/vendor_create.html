{% extends 'base.html' %}
{% load static %}

{% block title %}Add New Vendor{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    .form-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .form-body {
        padding: 30px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    .form-control.is-valid {
        border-color: #28a745;
    }
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
    }
    .required-field::after {
        content: ' *';
        color: #dc3545;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .success-message {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 20px;
        display: none;
    }
    .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 20px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'billing_payable_tracking:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'billing_payable_tracking:vendor_list' %}">Vendors</a></li>
            <li class="breadcrumb-item active" aria-current="page">Add New Vendor</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="form-container">
                <div class="form-header">
                    <h2 class="mb-0"><i class="bi bi-building me-2"></i>Add New Vendor</h2>
                    <p class="mb-0 mt-2 opacity-75">Enter vendor information to add them to your system</p>
                </div>
                
                <div class="form-body">
                    <!-- Success/Error Messages -->
                    <div id="success-message" class="success-message">
                        <i class="bi bi-check-circle me-2"></i>
                        <span id="success-text"></span>
                    </div>
                    
                    <div id="error-message" class="error-message">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="error-text"></span>
                    </div>

                    <form id="vendor-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name" class="form-label required-field">Vendor Name</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                    <div class="invalid-feedback" id="name-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                    <div class="invalid-feedback" id="email-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                    <div class="invalid-feedback" id="phone-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="contact_person" class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" id="contact_person" name="contact_person">
                                    <div class="invalid-feedback" id="contact_person-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3" placeholder="Enter complete address..."></textarea>
                            <div class="invalid-feedback" id="address-error"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="tax_id" class="form-label">Tax ID / VAT Number</label>
                                    <input type="text" class="form-control" id="tax_id" name="tax_id">
                                    <div class="invalid-feedback" id="tax_id-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="payment_terms" class="form-label">Default Payment Terms (Days)</label>
                                    <input type="number" class="form-control" id="payment_terms" name="payment_terms" min="1" max="365" value="30">
                                    <div class="invalid-feedback" id="payment_terms-error"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes about this vendor..."></textarea>
                            <div class="invalid-feedback" id="notes-error"></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% url 'billing_payable_tracking:vendor_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Vendors
                            </a>
                            <div>
                                <button type="button" id="reset-form" class="btn btn-outline-secondary me-2">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                                </button>
                                <button type="submit" id="submit-btn" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-2"></i>Create Vendor
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="text-center text-white">
        <div class="loading-spinner"></div>
        <p class="mt-3">Creating vendor...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vendor Create Form Handler
class VendorCreateForm {
    constructor() {
        this.apiBaseUrl = '/accounting/billing-payable-tracking/api';
        this.form = document.getElementById('vendor-form');
        this.submitBtn = document.getElementById('submit-btn');
        this.loadingOverlay = document.getElementById('loading-overlay');
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupValidation();
    }

    setupEventListeners() {
        // Form submission
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit();
        });

        // Reset form
        document.getElementById('reset-form').addEventListener('click', () => {
            this.resetForm();
        });

        // Real-time validation
        const inputs = this.form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', () => this.validateField(input));
            input.addEventListener('input', () => this.clearFieldError(input));
        });
    }

    setupValidation() {
        // Email validation
        const emailInput = document.getElementById('email');
        emailInput.addEventListener('input', () => {
            if (emailInput.value && !this.isValidEmail(emailInput.value)) {
                this.showFieldError('email', 'Please enter a valid email address');
            }
        });

        // Phone validation
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', () => {
            if (phoneInput.value && !this.isValidPhone(phoneInput.value)) {
                this.showFieldError('phone', 'Please enter a valid phone number');
            }
        });

        // Payment terms validation
        const paymentTermsInput = document.getElementById('payment_terms');
        paymentTermsInput.addEventListener('input', () => {
            const value = parseInt(paymentTermsInput.value);
            if (value && (value < 1 || value > 365)) {
                this.showFieldError('payment_terms', 'Payment terms must be between 1 and 365 days');
            }
        });
    }

    async handleSubmit() {
        if (!this.validateForm()) {
            return;
        }

        this.showLoading(true);
        
        try {
            const formData = new FormData(this.form);
            const vendorData = Object.fromEntries(formData.entries());
            
            // Remove empty fields
            Object.keys(vendorData).forEach(key => {
                if (!vendorData[key] || vendorData[key].trim() === '') {
                    delete vendorData[key];
                }
            });

            const response = await fetch(`${this.apiBaseUrl}/vendors/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(vendorData)
            });

            const result = await response.json();

            if (response.ok) {
                this.showSuccess('Vendor created successfully!');
                setTimeout(() => {
                    window.location.href = `{% url 'billing_payable_tracking:vendor_list' %}`;
                }, 1500);
            } else {
                this.handleServerErrors(result);
            }
        } catch (error) {
            console.error('Error creating vendor:', error);
            this.showError('Failed to create vendor. Please try again.');
        } finally {
            this.showLoading(false);
        }
    }

    validateForm() {
        let isValid = true;
        
        // Clear previous errors
        this.clearAllErrors();
        
        // Required field validation
        const nameInput = document.getElementById('name');
        if (!nameInput.value.trim()) {
            this.showFieldError('name', 'Vendor name is required');
            isValid = false;
        }
        
        // Email validation
        const emailInput = document.getElementById('email');
        if (emailInput.value && !this.isValidEmail(emailInput.value)) {
            this.showFieldError('email', 'Please enter a valid email address');
            isValid = false;
        }
        
        // Phone validation
        const phoneInput = document.getElementById('phone');
        if (phoneInput.value && !this.isValidPhone(phoneInput.value)) {
            this.showFieldError('phone', 'Please enter a valid phone number');
            isValid = false;
        }
        
        // Payment terms validation
        const paymentTermsInput = document.getElementById('payment_terms');
        const paymentTerms = parseInt(paymentTermsInput.value);
        if (paymentTerms && (paymentTerms < 1 || paymentTerms > 365)) {
            this.showFieldError('payment_terms', 'Payment terms must be between 1 and 365 days');
            isValid = false;
        }
        
        return isValid;
    }

    validateField(input) {
        const fieldName = input.name;
        const value = input.value.trim();
        
        switch (fieldName) {
            case 'name':
                if (!value) {
                    this.showFieldError('name', 'Vendor name is required');
                    return false;
                }
                break;
            case 'email':
                if (value && !this.isValidEmail(value)) {
                    this.showFieldError('email', 'Please enter a valid email address');
                    return false;
                }
                break;
            case 'phone':
                if (value && !this.isValidPhone(value)) {
                    this.showFieldError('phone', 'Please enter a valid phone number');
                    return false;
                }
                break;
            case 'payment_terms':
                const terms = parseInt(value);
                if (value && (terms < 1 || terms > 365)) {
                    this.showFieldError('payment_terms', 'Payment terms must be between 1 and 365 days');
                    return false;
                }
                break;
        }
        
        this.clearFieldError(input);
        return true;
    }

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    isValidPhone(phone) {
        const phoneRegex = /^[\+]?[1-9][\d\s\-\(\)]{7,}$/;
        return phoneRegex.test(phone.replace(/\s/g, ''));
    }

    showFieldError(fieldName, message) {
        const input = document.getElementById(fieldName);
        const errorDiv = document.getElementById(`${fieldName}-error`);
        
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        errorDiv.textContent = message;
    }

    clearFieldError(input) {
        const fieldName = input.name;
        const errorDiv = document.getElementById(`${fieldName}-error`);
        
        input.classList.remove('is-invalid');
        if (input.value.trim()) {
            input.classList.add('is-valid');
        } else {
            input.classList.remove('is-valid');
        }
        errorDiv.textContent = '';
    }

    clearAllErrors() {
        const inputs = this.form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        const errorDivs = this.form.querySelectorAll('.invalid-feedback');
        errorDivs.forEach(div => {
            div.textContent = '';
        });
    }

    handleServerErrors(errors) {
        if (typeof errors === 'object') {
            Object.keys(errors).forEach(field => {
                if (document.getElementById(field)) {
                    this.showFieldError(field, errors[field][0] || errors[field]);
                }
            });
        }
        this.showError('Please correct the errors below and try again.');
    }

    resetForm() {
        this.form.reset();
        this.clearAllErrors();
        this.hideMessages();
        
        // Reset payment terms to default
        document.getElementById('payment_terms').value = '30';
    }

    showLoading(show) {
        this.loadingOverlay.style.display = show ? 'flex' : 'none';
        this.submitBtn.disabled = show;
    }

    showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        
        successText.textContent = message;
        successDiv.style.display = 'block';
        
        // Hide error message
        document.getElementById('error-message').style.display = 'none';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        
        // Hide success message
        document.getElementById('success-message').style.display = 'none';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    hideMessages() {
        document.getElementById('success-message').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
}

// Initialize form handler when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.vendorCreateForm = new VendorCreateForm();
    console.log('Vendor Create Form loaded');
});
</script>
{% endblock %}