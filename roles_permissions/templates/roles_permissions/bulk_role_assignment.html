{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Role Assignment - Roles & Permissions{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'roles_permissions/css/dashboard.css' %}">
<style>
    .bulk-assignment-form {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.5rem;
        color: #007bff;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .user-selection {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .role-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .role-info h6 {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .role-info p {
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
    }
    
    .preview-section {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .preview-section h6 {
        color: #1976d2;
        margin-bottom: 0.5rem;
    }
    
    .user-count {
        background: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-users-cog me-2"></i>
                Bulk Role Assignment
            </h1>
            <p class="text-muted">Assign roles to multiple users simultaneously</p>
        </div>
        <div>
            <a href="{% url 'roles_permissions:user_role_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to User Roles
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Bulk Assignment Form -->
    <div class="bulk-assignment-form">
        <form method="post" id="bulkAssignmentForm">
            {% csrf_token %}
            
            <!-- User Selection Section -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-users"></i>
                    Select Users
                </h5>
                <div class="row">
                    <div class="col-md-8">
                        <label for="{{ form.users.id_for_label }}" class="form-label">
                            Users to Assign Role <span class="text-danger">*</span>
                        </label>
                        <div class="user-selection">
                            {{ form.users }}
                        </div>
                        {% if form.users.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.users.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="help-text">
                            Hold Ctrl (or Cmd on Mac) to select multiple users. You can also use the search box to filter users.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="preview-section">
                            <h6><i class="fas fa-info-circle me-1"></i>Selection Preview</h6>
                            <div id="userPreview">
                                <p class="text-muted">No users selected</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Selection Section -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-user-tag"></i>
                    Select Role
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <label for="{{ form.role.id_for_label }}" class="form-label">
                            Role to Assign <span class="text-danger">*</span>
                        </label>
                        {{ form.role }}
                        {% if form.role.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.role.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="role-info" id="roleInfo">
                            <h6><i class="fas fa-info-circle me-1"></i>Role Information</h6>
                            <p class="text-muted">Select a role to view its details</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Options Section -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-cog"></i>
                    Assignment Options
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-3">
                            {{ form.is_primary }}
                            <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                Set as Primary Role
                            </label>
                            <div class="help-text">
                                If checked, this role will be marked as the user's primary role
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.expires_at.id_for_label }}" class="form-label">
                            Expiration Date
                        </label>
                        {{ form.expires_at }}
                        {% if form.expires_at.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.expires_at.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="help-text">
                            Leave empty for no expiration
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-sticky-note"></i>
                    Assignment Notes
                </h5>
                <label for="{{ form.notes.id_for_label }}" class="form-label">
                    Notes
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.notes.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="help-text">
                    Optional notes about this bulk assignment
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        <i class="fas fa-times me-1"></i>
                        Cancel
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-info me-2" id="previewBtn">
                        <i class="fas fa-eye me-1"></i>
                        Preview Assignment
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Assign Roles
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-1"></i>
                        Assignment Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('bulkAssignmentForm').submit()">
                        <i class="fas fa-save me-1"></i>
                        Confirm Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const usersSelect = document.getElementById('{{ form.users.id_for_label }}');
    const roleSelect = document.getElementById('{{ form.role.id_for_label }}');
    const userPreview = document.getElementById('userPreview');
    const roleInfo = document.getElementById('roleInfo');
    const previewBtn = document.getElementById('previewBtn');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));

    // Update user preview when selection changes
    usersSelect.addEventListener('change', updateUserPreview);
    
    // Update role info when selection changes
    roleSelect.addEventListener('change', updateRoleInfo);
    
    // Preview button click handler
    previewBtn.addEventListener('click', showPreview);

    function updateUserPreview() {
        const selectedOptions = Array.from(usersSelect.selectedOptions);
        if (selectedOptions.length === 0) {
            userPreview.innerHTML = '<p class="text-muted">No users selected</p>';
        } else {
            const userList = selectedOptions.map(option => 
                `<div class="d-flex align-items-center mb-1">
                    <i class="fas fa-user me-2 text-primary"></i>
                    <span>${option.text}</span>
                </div>`
            ).join('');
            
            userPreview.innerHTML = `
                <div class="mb-2">
                    <span class="user-count">${selectedOptions.length} user(s) selected</span>
                </div>
                <div class="max-height-200 overflow-auto">
                    ${userList}
                </div>
            `;
        }
    }

    function updateRoleInfo() {
        const selectedOption = roleSelect.selectedOptions[0];
        if (!selectedOption) {
            roleInfo.innerHTML = `
                <h6><i class="fas fa-info-circle me-1"></i>Role Information</h6>
                <p class="text-muted">Select a role to view its details</p>
            `;
            return;
        }

        // You can enhance this to fetch role details via AJAX
        roleInfo.innerHTML = `
            <h6><i class="fas fa-info-circle me-1"></i>Role Information</h6>
            <p><strong>Name:</strong> ${selectedOption.text}</p>
            <p><strong>Type:</strong> <span class="badge bg-primary">Standard</span></p>
            <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
        `;
    }

    function showPreview() {
        const selectedUsers = Array.from(usersSelect.selectedOptions);
        const selectedRole = roleSelect.selectedOptions[0];
        const isPrimary = document.getElementById('{{ form.is_primary.id_for_label }}').checked;
        const expiresAt = document.getElementById('{{ form.expires_at.id_for_label }}').value;
        const notes = document.getElementById('{{ form.notes.id_for_label }}').value;

        if (selectedUsers.length === 0) {
            alert('Please select at least one user.');
            return;
        }

        if (!selectedRole) {
            alert('Please select a role.');
            return;
        }

        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-1"></i>Assignment Summary</h6>
                <p>You are about to assign the role <strong>"${selectedRole.text}"</strong> to <strong>${selectedUsers.length} user(s)</strong>.</p>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-users me-1"></i>Selected Users (${selectedUsers.length})</h6>
                    <div class="max-height-200 overflow-auto border rounded p-2">
                        ${selectedUsers.map(option => 
                            `<div class="d-flex align-items-center mb-1">
                                <i class="fas fa-user me-2 text-primary"></i>
                                <span>${option.text}</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-user-tag me-1"></i>Role Details</h6>
                    <div class="border rounded p-2">
                        <p><strong>Role:</strong> ${selectedRole.text}</p>
                        <p><strong>Primary Role:</strong> ${isPrimary ? 'Yes' : 'No'}</p>
                        <p><strong>Expires:</strong> ${expiresAt || 'No expiration'}</p>
                        ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ''}
                    </div>
                </div>
            </div>
        `;

        previewModal.show();
    }

    // Initialize previews
    updateUserPreview();
    updateRoleInfo();
});
</script>
{% endblock %}
