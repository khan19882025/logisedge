{% extends 'base.html' %}
{% load static %}

{% block title %}Transaction Dashboard - LogisEdge ERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'all_transactions/css/all_transactions.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.dashboard-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 0;
    margin-bottom: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.dashboard-content {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.dashboard-section {
    padding: 25px;
    border-bottom: 1px solid #e9ecef;
}

.dashboard-section:last-child {
    border-bottom: none;
}

.dashboard-section h4 {
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
    transition: transform 0.3s ease;
    border-left: 4px solid #667eea;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card .stat-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    color: #667eea;
}

.stat-card .stat-title {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 10px;
    font-weight: 600;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
}

.stat-card .stat-subtitle {
    font-size: 0.8rem;
    color: #28a745;
}

.chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    text-align: center;
}

.chart-wrapper {
    position: relative;
    height: 300px;
}

.table-responsive {
    border-radius: 8px;
    overflow: hidden;
}

.table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    border: none;
}

.table td {
    vertical-align: middle;
}

.progress-bar-custom {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.date-filter {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.date-filter h5 {
    margin-bottom: 15px;
    color: #333;
    font-weight: 600;
}

.quick-date-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.quick-date-btn {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    color: #6c757d;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
}

.quick-date-btn:hover,
.quick-date-btn.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .chart-wrapper {
        height: 250px;
    }
    
    .quick-date-buttons {
        flex-direction: column;
    }
    
    .quick-date-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-bar"></i> Transaction Dashboard</h1>
                    <p class="subtitle">
                        Analytics and insights for all accounting transactions
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'all_transactions:transaction_list' %}" class="btn btn-light">
                        <i class="fas fa-list"></i> View All Transactions
                    </a>
                </div>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="date-filter">
            <h5><i class="fas fa-calendar"></i> Date Range</h5>
            <form method="get" class="row align-items-end">
                <div class="col-md-3">
                    <label for="date_from" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="date_from" name="date_from" 
                           value="{{ start_date|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3">
                    <label for="date_to" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="date_to" name="date_to" 
                           value="{{ end_date|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Apply Filter
                    </button>
                </div>
                <div class="col-md-3">
                    <div class="quick-date-buttons">
                        <button type="button" class="quick-date-btn" data-days="7">Last 7 Days</button>
                        <button type="button" class="quick-date-btn" data-days="30">Last 30 Days</button>
                        <button type="button" class="quick-date-btn" data-days="90">Last 90 Days</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stat-title">Total Transactions</div>
                <div class="stat-value">{{ total_transactions|default:"0" }}</div>
                <div class="stat-subtitle">Records in period</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-title">Total Amount</div>
                <div class="stat-value">{{ total_amount|floatformat:0|default:"0" }}</div>
                <div class="stat-subtitle">AED</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stat-title">Transaction Types</div>
                <div class="stat-value">{{ type_stats|length|default:"0" }}</div>
                <div class="stat-subtitle">Different types</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-title">Active Users</div>
                <div class="stat-value">{{ status_stats|length|default:"0" }}</div>
                <div class="stat-subtitle">Posted transactions</div>
            </div>
        </div>

        <div class="row">
            <!-- Transaction Type Chart -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-title">Transactions by Type</div>
                    <div class="chart-wrapper">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Status Chart -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-title">Transactions by Status</div>
                    <div class="chart-wrapper">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Daily Trend Chart -->
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="chart-title">Daily Transaction Trend</div>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Top Accounts -->
            <div class="col-lg-4">
                <div class="chart-container">
                    <div class="chart-title">Top Debit Accounts</div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in top_debit_accounts %}
                                <tr>
                                    <td>
                                        <div class="account-name">{{ account.debit_account__account_name|default:"Unknown" }}</div>
                                    </td>
                                    <td>{{ account.total_amount|floatformat:0 }}</td>
                                                                <td>
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" data-width="{{ account.percent|floatformat:1 }}"></div>
                                </div>
                                <small>{{ account.percent|floatformat:1 }}%</small>
                            </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Type Details -->
        <div class="dashboard-section">
            <h4><i class="fas fa-table"></i> Transaction Type Breakdown</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Transaction Type</th>
                            <th>Count</th>
                            <th>Total Amount</th>
                            <th>Average Amount</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for type_stat in type_stats %}
                        <tr>
                            <td>
                                <span class="transaction-type-badge badge-{{ type_stat.transaction_type }}">
                                    {{ type_stat.transaction_type|title|replace:"_"," " }}
                                </span>
                            </td>
                            <td>{{ type_stat.count }}</td>
                            <td class="amount-positive">{{ type_stat.total_amount|floatformat:2 }}</td>
                            <td>{{ type_stat.average|floatformat:2 }}</td>
                            <td>
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" data-width="{{ type_stat.percent|floatformat:1 }}"></div>
                                </div>
                                <small>{{ type_stat.percent|floatformat:1 }}%</small>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No transaction data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="application/json" id="chart-data">
{
    "typeStats": {{ type_stats_json|safe }},
    "statusStats": {{ status_stats_json|safe }},
    "dailyTrend": {{ daily_trend_json|safe }}
}
</script>
<script>
// Get chart data from JSON script tag
const chartData = JSON.parse(document.getElementById('chart-data').textContent);
const typeStats = chartData.typeStats;
const statusStats = chartData.statusStats;
const dailyTrend = chartData.dailyTrend;

$(document).ready(function() {
    // Quick date buttons
    $('.quick-date-btn').on('click', function() {
        const days = $(this).data('days');
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);
        
        $('#date_from').val(startDate.toISOString().split('T')[0]);
        $('#date_to').val(endDate.toISOString().split('T')[0]);
        
        $('.quick-date-btn').removeClass('active');
        $(this).addClass('active');
    });

    // Set progress bar widths
    $('.progress-fill').each(function() {
        const width = $(this).data('width');
        if (width) {
            $(this).css('width', width + '%');
        }
    });

    // Initialize charts
    initializeCharts();
});

function initializeCharts() {
    
    // Transaction Type Chart
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    const typeLabels = typeStats.map(stat => stat.transaction_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
    const typeData = {
        labels: typeLabels,
        datasets: [{
            data: typeStats.map(stat => parseFloat(stat.total_amount)),
            backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
    
    new Chart(typeCtx, {
        type: 'doughnut',
        data: typeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusLabels = statusStats.map(stat => stat.status.charAt(0).toUpperCase() + stat.status.slice(1));
    const statusData = {
        labels: statusLabels,
        datasets: [{
            data: statusStats.map(stat => stat.count),
            backgroundColor: [
                '#28a745', '#ffc107', '#dc3545'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
    
    new Chart(statusCtx, {
        type: 'pie',
        data: statusData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Daily Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendLabels = dailyTrend.map(trend => {
        const date = new Date(trend.transaction_date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    const trendData = {
        labels: trendLabels,
        datasets: [{
            label: 'Transaction Count',
            data: dailyTrend.map(trend => trend.count),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }, {
            label: 'Total Amount (AED)',
            data: dailyTrend.map(trend => parseFloat(trend.total_amount)),
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
        }]
    };
    
    new Chart(trendCtx, {
        type: 'line',
        data: trendData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Transaction Count'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Amount (AED)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}
</script>
{% endblock %} 