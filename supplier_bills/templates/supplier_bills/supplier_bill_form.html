{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-plus-circle me-2"></i>
                            {% if is_update %}Update{% else %}Create{% endif %} Supplier Bill
                        </h4>
                        <a href="{% url 'supplier_bills:list' %}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 row">
                                    <label for="{{ form.number.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Bill Number</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.number }}
                                        <div class="form-text">Auto-generated after saving</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3 row">
                                    <label for="{{ form.supplier.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Supplier *</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.supplier }}
                                        {% if form.supplier.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.supplier.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3 row">
                                    <label for="{{ form.bill_date.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Bill Date *</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.bill_date }}
                                        {% if form.bill_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.bill_date.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3 row">
                                    <label for="{{ form.due_date.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Due Date *</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.due_date }}
                                        {% if form.due_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.due_date.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3 row">
                                    <label for="{{ form.amount.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Amount *</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            {{ form.amount }}
                                            <span class="input-group-text">AED</span>
                                        </div>
                                        {% if form.amount.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.amount.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 row">
                                    <label for="{{ form.status.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Status</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.status.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3 row">
                                    <label for="{{ form.reference_number.id_for_label }}" class="col-sm-4 col-form-label">
                                        <strong>Reference</strong>
                                    </label>
                                    <div class="col-sm-8">
                                        {{ form.reference_number }}
                                        {% if form.reference_number.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.reference_number.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3 row">
                                    <label for="{{ form.notes.id_for_label }}" class="col-sm-2 col-form-label">
                                        <strong>Notes</strong>
                                    </label>
                                    <div class="col-sm-10">
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.notes.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Product Details Table -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-list-ul me-2"></i>Product Details
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover" id="product-table">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th width="5%">Sr No</th>
                                                        <th width="30%">Product Description</th>
                                                        <th width="10%">Qty</th>
                                                        <th width="12%">Rate (AED)</th>
                                                        <th width="12%">Amount (AED)</th>
                                                        <th width="8%">VAT %</th>
                                                        <th width="12%">VAT Amount (AED)</th>
                                                        <th width="12%">Net Amount (AED)</th>
                                                        <th width="5%">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="product-tbody">
                                                    <!-- Product rows will be added here dynamically -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <button type="button" class="btn btn-success" id="add-product-btn">
                                                    <i class="bi bi-plus-circle me-1"></i>Add Product
                                                </button>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>Subtotal:</strong>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <span id="subtotal">AED 0.00</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>Total VAT:</strong>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <span id="total-vat">AED 0.00</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>Grand Total:</strong>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <span id="grand-total" class="fs-5 fw-bold">AED 0.00</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'supplier_bills:list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>
                                {% if is_update %}Update{% else %}Save{% endif %} Bill
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const billDateField = document.getElementById('{{ form.bill_date.id_for_label }}');
    const dueDateField = document.getElementById('{{ form.due_date.id_for_label }}');
    const amountField = document.getElementById('{{ form.amount.id_for_label }}');
    const addProductBtn = document.getElementById('add-product-btn');
    const productTbody = document.getElementById('product-tbody');
    
    let productCounter = 1;
    
    // Set default due date when bill date changes
    billDateField.addEventListener('change', function() {
        if (this.value && !dueDateField.value) {
            const billDate = new Date(this.value);
            const dueDate = new Date(billDate);
            dueDate.setDate(dueDate.getDate() + 30); // 30 days from bill date
            
            const dueDateString = dueDate.toISOString().split('T')[0];
            dueDateField.value = dueDateString;
        }
    });
    
    // Add product row
    addProductBtn.addEventListener('click', function() {
        addProductRow();
    });
    
    function addProductRow() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${productCounter}</td>
            <td>
                <input type="text" class="form-control form-control-sm product-description" 
                       placeholder="Enter product description" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-qty" 
                       placeholder="Qty" min="1" step="1" value="1" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-rate" 
                       placeholder="Rate" min="0" step="0.01" value="0.00" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-amount" 
                       placeholder="Amount" readonly>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-vat" 
                       placeholder="VAT %" min="0" max="100" step="0.01" value="5.00" required>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-vat-amount" 
                       placeholder="VAT Amount" readonly>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm product-net-amount" 
                       placeholder="Net Amount" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm remove-product">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        productTbody.appendChild(row);
        
        // Add event listeners to the new row
        const qtyInput = row.querySelector('.product-qty');
        const rateInput = row.querySelector('.product-rate');
        const vatInput = row.querySelector('.product-vat');
        const netAmountInput = row.querySelector('.product-net-amount');
        const removeBtn = row.querySelector('.remove-product');
        
        qtyInput.addEventListener('input', () => calculateRowAmount(row));
        rateInput.addEventListener('input', () => calculateRowAmount(row));
        vatInput.addEventListener('input', () => calculateRowAmount(row));
        removeBtn.addEventListener('click', () => removeProductRow(row));
        
        // Add tab event listener to net amount field
        netAmountInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' && !e.shiftKey) {
                e.preventDefault();
                addProductRow();
                // Focus on the first input of the new row
                setTimeout(() => {
                    const newRow = productTbody.lastElementChild;
                    const newDescriptionInput = newRow.querySelector('.product-description');
                    newDescriptionInput.focus();
                }, 100);
            }
        });
        
        productCounter++;
        calculateTotals();
    }
    
    function calculateRowAmount(row) {
        const qty = parseFloat(row.querySelector('.product-qty').value) || 0;
        const rate = parseFloat(row.querySelector('.product-rate').value) || 0;
        const vatPercent = parseFloat(row.querySelector('.product-vat').value) || 0;
        
        const amount = qty * rate;
        const vatAmount = amount * (vatPercent / 100);
        const netAmount = amount + vatAmount;
        
        row.querySelector('.product-amount').value = amount.toFixed(2);
        row.querySelector('.product-vat-amount').value = vatAmount.toFixed(2);
        row.querySelector('.product-net-amount').value = netAmount.toFixed(2);
        
        calculateTotals();
    }
    
    function calculateTotals() {
        let subtotal = 0;
        let totalVat = 0;
        let grandTotal = 0;
        
        const rows = productTbody.querySelectorAll('tr');
        rows.forEach(row => {
            subtotal += parseFloat(row.querySelector('.product-amount').value) || 0;
            totalVat += parseFloat(row.querySelector('.product-vat-amount').value) || 0;
            grandTotal += parseFloat(row.querySelector('.product-net-amount').value) || 0;
        });
        
        document.getElementById('subtotal').textContent = `AED ${subtotal.toFixed(2)}`;
        document.getElementById('total-vat').textContent = `AED ${totalVat.toFixed(2)}`;
        document.getElementById('grand-total').textContent = `AED ${grandTotal.toFixed(2)}`;
        
        // Update the main amount field
        amountField.value = grandTotal.toFixed(2);
    }
    
    function removeProductRow(row) {
        row.remove();
        renumberRows();
        calculateTotals();
    }
    
    function renumberRows() {
        const rows = productTbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.querySelector('td:first-child').textContent = index + 1;
        });
        productCounter = rows.length + 1;
    }
    
    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
    
    // Add initial row
    addProductRow();
});
</script>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
    }
    
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
        border-bottom: none;
    }
    
    .btn {
        border-radius: 0.375rem;
        font-weight: 500;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-text {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .invalid-feedback {
        font-size: 0.75rem;
    }
</style>
{% endblock %} 