{% extends 'base.html' %}
{% load static %}

{% block title %}Budget Variance Report - Budget Planning{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/budget_planning/style.css' %}">
<style>
    .report-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .report-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
    }
    
    .variance-positive {
        color: #28a745;
        font-weight: bold;
    }
    
    .variance-negative {
        color: #dc3545;
        font-weight: bold;
    }
    
    .variance-neutral {
        color: #6c757d;
        font-weight: bold;
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
    }
    
    .report-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .report-summary h3 {
        color: white;
        margin-bottom: 1rem;
    }
    
    .summary-stat {
        text-align: center;
        padding: 1rem;
    }
    
    .summary-stat .number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }
    
    .summary-stat .label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-line mr-2"></i>Budget Variance Report
        </h1>
        <div>
            <a href="{% url 'budget_planning:budget_list' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left mr-1"></i>Back to Budgets
            </a>
        </div>
    </div>

    <!-- Report Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-cog mr-2"></i>Report Parameters
            </h6>
        </div>
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <div class="row">
                    <!-- Report Type -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.report_type.id_for_label }}">
                                {{ form.report_type.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.report_type }}
                            {% if form.report_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.report_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Period -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.period.id_for_label }}">
                                {{ form.period.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.period }}
                            {% if form.period.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.period.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fiscal Year -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.fiscal_year.id_for_label }}">
                                {{ form.fiscal_year.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.fiscal_year }}
                            {% if form.fiscal_year.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.fiscal_year.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Include Zero Budgets -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="d-block">{{ form.include_zero_budgets.label }}</label>
                            <div class="custom-control custom-checkbox">
                                {{ form.include_zero_budgets }}
                                <label class="custom-control-label" for="{{ form.include_zero_budgets.id_for_label }}">
                                    Include budgets with zero amounts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Start Date -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.start_date.id_for_label }}">
                                {{ form.start_date.label }}
                            </label>
                            {{ form.start_date }}
                            {% if form.start_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.start_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- End Date -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.end_date.id_for_label }}">
                                {{ form.end_date.label }}
                            </label>
                            {{ form.end_date }}
                            {% if form.end_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.end_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Department -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.department.id_for_label }}">
                                {{ form.department.label }}
                            </label>
                            {{ form.department }}
                            {% if form.department.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.department.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Cost Center -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.cost_center.id_for_label }}">
                                {{ form.cost_center.label }}
                            </label>
                            {{ form.cost_center }}
                            {% if form.cost_center.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cost_center.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Submit button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-chart-bar mr-2"></i>Generate Report
                    </button>
                    <a href="{% url 'budget_planning:budget_list' %}" class="btn btn-secondary btn-lg ml-2">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Preview/Results -->
    {% if form.is_bound and form.is_valid %}
    <div class="report-summary">
        <h3><i class="fas fa-chart-pie mr-2"></i>Report Summary</h3>
        <div class="row">
            <div class="col-md-3">
                <div class="summary-stat">
                    <span class="number">0</span>
                    <span class="label">Total Budgets</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Budget Amount</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Actual Amount</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Variance</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-table mr-2"></i>Budget Variance Details
            </h6>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                    <i class="fas fa-download mr-1"></i>Export Excel
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf mr-1"></i>Export PDF
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead class="thead-light">
                        <tr>
                            <th>Budget Code</th>
                            <th>Budget Name</th>
                            <th>Department</th>
                            <th>Cost Center</th>
                            <th>Budget Amount</th>
                            <th>Actual Amount</th>
                            <th>Variance</th>
                            <th>Variance %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                <i class="fas fa-info-circle mr-2"></i>No budget variance data found for the selected criteria
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row">
        <!-- Variance Chart -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar mr-2"></i>Budget vs Actual Comparison
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="varianceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Variance Distribution -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie mr-2"></i>Variance Distribution
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="distributionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Initialize form validation
    $('.needs-validation').on('submit', function(event) {
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });

    // Initialize charts if report data is available
    {% if form.is_bound and form.is_valid %}
    initializeCharts();
    {% endif %}
});

function initializeCharts() {
    // Variance Chart
    const varianceCtx = document.getElementById('varianceChart').getContext('2d');
    new Chart(varianceCtx, {
        type: 'bar',
        data: {
            labels: ['Budget', 'Actual'],
            datasets: [{
                label: 'Amount (AED)',
                data: [0, 0],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'AED ' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });

    // Distribution Chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Under Budget', 'Over Budget', 'On Target'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

function exportToExcel() {
    // Implementation for Excel export
    alert('Excel export functionality would be implemented here.');
}

function exportToPDF() {
    // Implementation for PDF export
    alert('PDF export functionality would be implemented here.');
}

// Dynamic form interactions
$(document).on('change', '#id_department', function() {
    const departmentId = $(this).val();
    const costCenterSelect = $('#id_cost_center');
    
    if (departmentId) {
        // Load cost centers for the selected department
        $.get(`{% url 'budget_planning:get_cost_centers_by_department' %}?department_id=${departmentId}`)
            .done(function(data) {
                costCenterSelect.empty();
                costCenterSelect.append('<option value="">All Cost Centers</option>');
                
                data.cost_centers.forEach(function(costCenter) {
                    costCenterSelect.append(
                        `<option value="${costCenter.id}">${costCenter.code} - ${costCenter.name}</option>`
                    );
                });
            });
    } else {
        // Reset cost center options
        costCenterSelect.empty();
        costCenterSelect.append('<option value="">All Cost Centers</option>');
    }
});
</script>
{% endblock %}
