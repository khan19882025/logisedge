{% extends 'base.html' %}
{% load static %}

{% block title %}Generate Budget vs Actual Report - Budget Planning{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/budget_planning/style.css' %}">
<style>
    .report-form-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .report-form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
        color: #495057;
        margin-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
    }
    
    .preview-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .preview-section h3 {
        color: white;
        margin-bottom: 1rem;
    }
    
    .preview-stat {
        text-align: center;
        padding: 1rem;
    }
    
    .preview-stat .number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }
    
    .preview-stat .label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-bar mr-2"></i>Generate Budget vs Actual Report
        </h1>
        <div>
            <a href="{% url 'budget_planning:budget_vs_actual_dashboard' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Report Form -->
    <div class="card shadow mb-4 report-form-card">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-cog mr-2"></i>Report Parameters
            </h6>
        </div>
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle mr-2"></i>Basic Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.report_name.id_for_label }}">
                                    {{ form.report_name.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.report_name }}
                                {% if form.report_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.report_name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.report_type.id_for_label }}">
                                    {{ form.report_type.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.report_type }}
                                {% if form.report_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.report_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Period -->
                <div class="form-section">
                    <h5><i class="fas fa-calendar mr-2"></i>Time Period</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.fiscal_year.id_for_label }}">
                                    {{ form.fiscal_year.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.fiscal_year }}
                                {% if form.fiscal_year.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.fiscal_year.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.period.id_for_label }}">
                                    {{ form.period.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.period }}
                                {% if form.period.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.period.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.start_date.id_for_label }}">
                                    {{ form.start_date.label }}
                                </label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.start_date.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form.end_date.id_for_label }}">
                                    {{ form.end_date.label }}
                                </label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.end_date.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="form-section">
                    <h5><i class="fas fa-filter mr-2"></i>Filters</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.department.id_for_label }}">
                                    {{ form.department.label }}
                                </label>
                                {{ form.department }}
                                {% if form.department.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.department.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.cost_center.id_for_label }}">
                                    {{ form.cost_center.label }}
                                </label>
                                {{ form.cost_center }}
                                {% if form.cost_center.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cost_center.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="d-block">Options</label>
                                <div class="custom-control custom-checkbox">
                                    {{ form.include_zero_budgets }}
                                    <label class="custom-control-label" for="{{ form.include_zero_budgets.id_for_label }}">
                                        Include budgets with zero amounts
                                    </label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    {{ form.include_inactive }}
                                    <label class="custom-control-label" for="{{ form.include_inactive.id_for_label }}">
                                        Include inactive cost centers
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-chart-bar mr-2"></i>Generate Report
                    </button>
                    <a href="{% url 'budget_planning:budget_vs_actual_dashboard' %}" class="btn btn-secondary btn-lg ml-2">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Preview -->
    {% if form.is_bound and form.is_valid %}
    <div class="preview-section">
        <h3><i class="fas fa-eye mr-2"></i>Report Preview</h3>
        <div class="row">
            <div class="col-md-3">
                <div class="preview-stat">
                    <span class="number">0</span>
                    <span class="label">Total Budgets</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Budget Amount</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Actual Amount</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-stat">
                    <span class="number">AED 0.00</span>
                    <span class="label">Total Variance</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Templates -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-magic mr-2"></i>Quick Templates
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="card border-left-primary shadow h-100">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Monthly Summary
                                    </div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800">Current Month</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary mt-2" onclick="loadTemplate('monthly')">
                                Use Template
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-success shadow h-100">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Quarterly Report
                                    </div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800">Current Quarter</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chart-pie fa-2x text-gray-300"></i>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success mt-2" onclick="loadTemplate('quarterly')">
                                Use Template
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-info shadow h-100">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Annual Report
                                    </div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800">Current Year</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-info mt-2" onclick="loadTemplate('annual')">
                                Use Template
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-warning shadow h-100">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Variance Report
                                    </div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800">Variance Analysis</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-warning mt-2" onclick="loadTemplate('variance')">
                                Use Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize form validation
    $('.needs-validation').on('submit', function(event) {
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });

    // Dynamic form interactions
    $('#id_department').change(function() {
        const departmentId = $(this).val();
        const costCenterSelect = $('#id_cost_center');
        
        if (departmentId) {
            // Load cost centers for the selected department
            $.get(`{% url 'budget_planning:get_cost_centers_by_department' %}?department_id=${departmentId}`)
                .done(function(data) {
                    costCenterSelect.empty();
                    costCenterSelect.append('<option value="">All Cost Centers</option>');
                    
                    data.cost_centers.forEach(function(costCenter) {
                        costCenterSelect.append(
                            `<option value="${costCenter.id}">${costCenter.code} - ${costCenter.name}</option>`
                        );
                    });
                });
        } else {
            // Reset cost center options
            costCenterSelect.empty();
            costCenterSelect.append('<option value="">All Cost Centers</option>');
        }
    });

    // Period change handler
    $('#id_period').change(function() {
        const period = $(this).val();
        const startDateField = $('#id_start_date');
        const endDateField = $('#id_end_date');
        
        if (period === 'custom') {
            startDateField.prop('required', true);
            endDateField.prop('required', true);
        } else {
            startDateField.prop('required', false);
            endDateField.prop('required', false);
        }
    });
});

function loadTemplate(template) {
    const today = new Date();
    const currentYear = today.getFullYear();
    let startDate, endDate, reportName, reportType, period;
    
    switch(template) {
        case 'monthly':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            reportName = `Monthly Budget vs Actual Report - ${startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            reportType = 'summary';
            period = 'monthly';
            break;
        case 'quarterly':
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
            reportName = `Quarterly Budget vs Actual Report - Q${quarter + 1} ${today.getFullYear()}`;
            reportType = 'summary';
            period = 'quarterly';
            break;
        case 'annual':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            reportName = `Annual Budget vs Actual Report - ${today.getFullYear()}`;
            reportType = 'summary';
            period = 'yearly';
            break;
        case 'variance':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = today;
            reportName = `Variance Analysis Report - ${startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            reportType = 'variance';
            period = 'monthly';
            break;
    }
    
    // Populate form fields
    $('#id_report_name').val(reportName);
    $('#id_report_type').val(reportType);
    $('#id_fiscal_year').val(currentYear);
    $('#id_period').val(period);
    $('#id_start_date').val(startDate.toISOString().split('T')[0]);
    $('#id_end_date').val(endDate.toISOString().split('T')[0]);
    
    // Show success message
    $('<div class="alert alert-success alert-dismissible fade show" role="alert">')
        .html('<i class="fas fa-check-circle mr-2"></i>Template loaded successfully!')
        .append('<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>')
        .insertAfter('.card-header')
        .delay(3000)
        .fadeOut();
}
</script>
{% endblock %}
