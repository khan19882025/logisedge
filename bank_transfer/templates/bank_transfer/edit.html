{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Edit Bank Transfer - {{ transfer.transfer_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bank_transfer/css/bank_transfer.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="page-header">
                <div class="header-content">
                    <h1 class="page-title">
                        <i class="fas fa-edit"></i>
                        Edit Bank Transfer
                    </h1>
                    <div class="header-actions">
                        <a href="{% url 'bank_transfer:detail' transfer.pk %}" class="btn btn-secondary">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                        <a href="{% url 'bank_transfer:list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-list"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row">
                <!-- Transfer Form -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-edit"></i>
                                Edit Transfer Details
                            </h5>
                            <div class="transfer-info">
                                <span class="transfer-number">{{ transfer.transfer_number }}</span>
                                <span class="status-badge status-{{ transfer.status }}">
                                    {{ transfer.get_status_display }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <form method="post" id="bankTransferForm">
                                {% csrf_token %}
                                
                                <!-- Basic Information -->
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-info-circle"></i>
                                        Basic Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.transfer_date.id_for_label }}">
                                                    <i class="fas fa-calendar"></i>
                                                    Transfer Date *
                                                </label>
                                                {{ form.transfer_date }}
                                                {% if form.transfer_date.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.transfer_date.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.transfer_type.id_for_label }}">
                                                    <i class="fas fa-tag"></i>
                                                    Transfer Type *
                                                </label>
                                                {{ form.transfer_type }}
                                                {% if form.transfer_type.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.transfer_type.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account Information -->
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-university"></i>
                                        Account Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.from_account.id_for_label }}">
                                                    <i class="fas fa-arrow-down"></i>
                                                    From Bank Account *
                                                </label>
                                                {{ form.from_account }}
                                                {% if form.from_account.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.from_account.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <small class="form-text text-muted">
                                                    Current Balance: <span id="fromAccountBalance">-</span>
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.to_account.id_for_label }}">
                                                    <i class="fas fa-arrow-up"></i>
                                                    To Bank Account *
                                                </label>
                                                {{ form.to_account }}
                                                {% if form.to_account.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.to_account.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <small class="form-text text-muted">
                                                    Current Balance: <span id="toAccountBalance">-</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Information -->
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Financial Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="{{ form.amount.id_for_label }}">
                                                    <i class="fas fa-dollar-sign"></i>
                                                    Transfer Amount *
                                                </label>
                                                {{ form.amount }}
                                                {% if form.amount.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.amount.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="{{ form.currency.id_for_label }}">
                                                    <i class="fas fa-coins"></i>
                                                    Currency *
                                                </label>
                                                {{ form.currency }}
                                                {% if form.currency.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.currency.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group" id="exchangeRateGroup" style="display: none;">
                                                <label for="{{ form.exchange_rate.id_for_label }}">
                                                    <i class="fas fa-exchange-alt"></i>
                                                    Exchange Rate
                                                </label>
                                                {{ form.exchange_rate }}
                                                {% if form.exchange_rate.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.exchange_rate.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <small class="form-text text-muted">
                                                    Required for multi-currency transfers
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Information -->
                                <div class="form-section">
                                    <h6 class="section-title">
                                        <i class="fas fa-sticky-note"></i>
                                        Additional Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.reference_number.id_for_label }}">
                                                    <i class="fas fa-hashtag"></i>
                                                    Reference Number
                                                </label>
                                                {{ form.reference_number }}
                                                {% if form.reference_number.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.reference_number.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.narration.id_for_label }}">
                                                    <i class="fas fa-comment"></i>
                                                    Narration / Notes
                                                </label>
                                                {{ form.narration }}
                                                {% if form.narration.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.narration.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Update Transfer
                                    </button>
                                    <a href="{% url 'bank_transfer:detail' transfer.pk %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i>
                                        Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Summary Sidebar -->
                <div class="col-lg-4">
                    <!-- Account Balances -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-balance-scale"></i>
                                Account Balances
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="balance-item">
                                <div class="balance-label">From Account Balance:</div>
                                <div class="balance-value" id="summaryFromBalance">-</div>
                            </div>
                            <div class="balance-item">
                                <div class="balance-label">To Account Balance:</div>
                                <div class="balance-value" id="summaryToBalance">-</div>
                            </div>
                            <hr>
                            <div class="balance-item">
                                <div class="balance-label">Transfer Amount:</div>
                                <div class="balance-value" id="summaryTransferAmount">-</div>
                            </div>
                            <div class="balance-item" id="summaryConvertedAmount" style="display: none;">
                                <div class="balance-label">Converted Amount:</div>
                                <div class="balance-value" id="summaryConvertedValue">-</div>
                            </div>
                            <div class="balance-item" id="summaryFXGainLoss" style="display: none;">
                                <div class="balance-label">FX Gain/Loss:</div>
                                <div class="balance-value" id="summaryFXValue">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-info"></i>
                                Transfer Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="info-item">
                                <label>Transfer Number:</label>
                                <span class="info-value">{{ transfer.transfer_number }}</span>
                            </div>
                            <div class="info-item">
                                <label>Status:</label>
                                <span class="status-badge status-{{ transfer.status }}">
                                    {{ transfer.get_status_display }}
                                </span>
                            </div>
                            <div class="info-item">
                                <label>Created By:</label>
                                <span class="info-value">{{ transfer.created_by.get_full_name|default:transfer.created_by.username }}</span>
                            </div>
                            <div class="info-item">
                                <label>Created At:</label>
                                <span class="info-value">{{ transfer.created_at|date:"M d, Y H:i" }}</span>
                            </div>
                            {% if transfer.updated_at %}
                            <div class="info-item">
                                <label>Last Updated:</label>
                                <span class="info-value">{{ transfer.updated_at|date:"M d, Y H:i" }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Help -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-question-circle"></i>
                                Help
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="help-list">
                                <li>You can only edit transfers in Draft status</li>
                                <li>Changing accounts will update currency information</li>
                                <li>Exchange rate is required for multi-currency transfers</li>
                                <li>Reference numbers must be unique</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'bank_transfer/js/bank_transfer.js' %}"></script>
<script>
// Initialize with current values
$(document).ready(function() {
    // Load initial account balances
    updateAccountBalances();
    updateCurrencyInfo();
    updateSummaryCalculations();
});
</script>
{% endblock %} 