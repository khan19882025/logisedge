{% extends 'base.html' %}
{% load static %}
{% load hr_letters_filters %}

{% block title %}{% if is_edit %}Edit Letter{% else %}Generate New Letter{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'hr_letters_documents/css/dashboard.css' %}">
<style>
    .form-section {
        background: #f8f9fc;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e3e6f0;
    }
    
    .form-section h5 {
        color: #4e73df;
        margin-bottom: 1rem;
        border-bottom: 2px solid #4e73df;
        padding-bottom: 0.5rem;
    }
    
    .preview-section {
        background: white;
        border: 2px solid #e3e6f0;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .preview-content {
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 5px;
        padding: 1rem;
        min-height: 200px;
        white-space: pre-wrap;
        font-family: 'Times New Roman', serif;
        line-height: 1.6;
    }
    
    .language-tabs {
        border-bottom: 1px solid #e3e6f0;
        margin-bottom: 1rem;
    }
    
    .language-tab {
        background: none;
        border: none;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
    }
    
    .language-tab.active {
        background: #4e73df;
        color: white;
    }
    
    .language-content {
        display: none;
    }
    
    .language-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-file-alt me-2"></i>
                    {% if is_edit %}Edit Letter{% else %}Generate New Letter{% endif %}
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'hr_letters_documents:dashboard' %}">HR Letters & Documents</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'hr_letters_documents:letter_list' %}">Letters</a></li>
                        <li class="breadcrumb-item active">{% if is_edit %}Edit{% else %}Generate{% endif %}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <form method="post" id="letterForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Main Form -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.employee.id_for_label }}" class="form-label">Employee *</label>
                            {{ form.employee }}
                            {% if form.employee.errors %}
                                <div class="text-danger">{{ form.employee.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.letter_type.id_for_label }}" class="form-label">Letter Type *</label>
                            {{ form.letter_type }}
                            {% if form.letter_type.errors %}
                                <div class="text-danger">{{ form.letter_type.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.template.id_for_label }}" class="form-label">Template *</label>
                            {{ form.template }}
                            {% if form.template.errors %}
                                <div class="text-danger">{{ form.template.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.language.id_for_label }}" class="form-label">Language</label>
                            {{ form.language }}
                            {% if form.language.errors %}
                                <div class="text-danger">{{ form.language.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Letter Content -->
                <div class="form-section">
                    <h5><i class="fas fa-edit me-2"></i>Letter Content</h5>
                    <div class="mb-3">
                        <label for="{{ form.subject.id_for_label }}" class="form-label">Subject *</label>
                        {{ form.subject }}
                        {% if form.subject.errors %}
                            <div class="text-danger">{{ form.subject.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Language Tabs -->
                    <div class="language-tabs">
                        <button type="button" class="language-tab active" data-language="en">English</button>
                        <button type="button" class="language-tab" data-language="ar">Arabic</button>
                    </div>
                    
                    <div class="language-content active" id="content-en">
                        <label for="{{ form.content.id_for_label }}" class="form-label">Content (English) *</label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="text-danger">{{ form.content.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="language-content" id="content-ar">
                        <label for="{{ form.arabic_content.id_for_label }}" class="form-label">Content (Arabic)</label>
                        {{ form.arabic_content }}
                        {% if form.arabic_content.errors %}
                            <div class="text-danger">{{ form.arabic_content.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Dates and Notes -->
                <div class="form-section">
                    <h5><i class="fas fa-calendar me-2"></i>Dates & Additional Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.issue_date.id_for_label }}" class="form-label">Issue Date *</label>
                            {{ form.issue_date }}
                            {% if form.issue_date.errors %}
                                <div class="text-danger">{{ form.issue_date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.effective_date.id_for_label }}" class="form-label">Effective Date</label>
                            {{ form.effective_date }}
                            {% if form.effective_date.errors %}
                                <div class="text-danger">{{ form.effective_date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_confidential }}
                            <label class="form-check-label" for="{{ form.is_confidential.id_for_label }}">
                                Mark as Confidential
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Employee Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Employee Information</h6>
                    </div>
                    <div class="card-body" id="employeeInfo">
                        <div class="text-center text-muted">
                            <i class="fas fa-user fa-3x mb-3"></i>
                            <p>Select an employee to view details</p>
                        </div>
                    </div>
                </div>

                <!-- Template Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Template Information</h6>
                    </div>
                    <div class="card-body" id="templateInfo">
                        <div class="text-center text-muted">
                            <i class="fas fa-file-medical fa-3x mb-3"></i>
                            <p>Select a template to view details</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Actions</h6>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-info btn-block mb-2" id="previewBtn">
                            <i class="fas fa-eye me-2"></i>Preview Letter
                        </button>
                        <button type="submit" class="btn btn-primary btn-block mb-2">
                            <i class="fas fa-save me-2"></i>{% if is_edit %}Update Letter{% else %}Generate Letter{% endif %}
                        </button>
                        <a href="{% url 'hr_letters_documents:letter_list' %}" class="btn btn-secondary btn-block">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Letter Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-section">
                        <div class="language-tabs">
                            <button type="button" class="language-tab active" data-preview-language="en">English</button>
                            <button type="button" class="language-tab" data-preview-language="ar">Arabic</button>
                        </div>
                        <div class="language-content active" id="preview-en">
                            <div class="preview-content" id="previewContentEn"></div>
                        </div>
                        <div class="language-content" id="preview-ar">
                            <div class="preview-content" id="previewContentAr"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadPdfBtn">
                        <i class="fas fa-download me-2"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'hr_letters_documents/js/letter_form.js' %}"></script>
{% endblock %} 