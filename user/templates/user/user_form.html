{% extends 'user/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }} - logisEdge{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-plus me-2"></i>{{ title }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please correct the errors below.
                            </div>
                        {% endif %}

                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-4" id="userFormTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                    <i class="bi bi-person me-1"></i>Basic Information
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button" role="tab">
                                    <i class="bi bi-briefcase me-1"></i>Work Information
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="role-tab" data-bs-toggle="tab" data-bs-target="#role" type="button" role="tab">
                                    <i class="bi bi-shield me-1"></i>Role & Permissions
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="userFormTabContent">
                            <!-- Basic Information Tab -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.username.id_for_label }}" class="form-label">Username *</label>
                                        {{ form.username }}
                                        {% if form.username.errors %}
                                            <div class="invalid-feedback d-block">{{ form.username.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.employee_id.id_for_label }}" class="form-label">Employee ID *</label>
                                        {{ form.employee_id }}
                                        {% if form.employee_id.errors %}
                                            <div class="invalid-feedback d-block">{{ form.employee_id.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name *</label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.first_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name *</label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.last_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                                        {{ form.email }}
                                        {% if form.email.errors %}
                                            <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.phone.id_for_label }}" class="form-label">Phone *</label>
                                        {{ form.phone }}
                                        {% if form.phone.errors %}
                                            <div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth</label>
                                        {{ form.date_of_birth }}
                                        {% if form.date_of_birth.errors %}
                                            <div class="invalid-feedback d-block">{{ form.date_of_birth.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.gender.id_for_label }}" class="form-label">Gender</label>
                                        {{ form.gender }}
                                        {% if form.gender.errors %}
                                            <div class="invalid-feedback d-block">{{ form.gender.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                        <div class="invalid-feedback d-block">{{ form.address.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.profile_picture.id_for_label }}" class="form-label">Profile Picture</label>
                                    {{ form.profile_picture }}
                                    {% if form.profile_picture.errors %}
                                        <div class="invalid-feedback d-block">{{ form.profile_picture.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                {% if not form.instance.pk %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.password1.id_for_label }}" class="form-label">Password *</label>
                                        {{ form.password1 }}
                                        {% if form.password1.errors %}
                                            <div class="invalid-feedback d-block">{{ form.password1.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm Password *</label>
                                        {{ form.password2 }}
                                        {% if form.password2.errors %}
                                            <div class="invalid-feedback d-block">{{ form.password2.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Password Management for Existing Users -->
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="card border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">
                                                    <i class="bi bi-shield-lock me-2"></i>Password Management
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Current Password Status</label>
                                                            <div class="d-flex align-items-center">
                                                                <span class="badge bg-success me-2">Set</span>
                                                                <small class="text-muted">Password is configured for this user</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Last Password Change</label>
                                                            <div class="text-muted">
                                                                <small>{{ user.date_joined|date:"M d, Y H:i" }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <hr>
                                                
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                                            <i class="bi bi-key me-1"></i>Change Password
                                                        </button>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                                                            <i class="bi bi-arrow-clockwise me-1"></i>Reset Password
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Work Information Tab -->
                            <div class="tab-pane fade" id="work" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.department.id_for_label }}" class="form-label">Department</label>
                                        {{ form.department }}
                                        {% if form.department.errors %}
                                            <div class="invalid-feedback d-block">{{ form.department.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.position.id_for_label }}" class="form-label">Position</label>
                                        {{ form.position }}
                                        {% if form.position.errors %}
                                            <div class="invalid-feedback d-block">{{ form.position.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.hire_date.id_for_label }}" class="form-label">Hire Date</label>
                                        {{ form.hire_date }}
                                        {% if form.hire_date.errors %}
                                            <div class="invalid-feedback d-block">{{ form.hire_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.salary.id_for_label }}" class="form-label">Salary</label>
                                        {{ form.salary }}
                                        {% if form.salary.errors %}
                                            <div class="invalid-feedback d-block">{{ form.salary.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Role & Permissions Tab -->
                            <div class="tab-pane fade" id="role" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.role.id_for_label }}" class="form-label">Role</label>
                                        {{ form.role }}
                                        {% if form.role.errors %}
                                            <div class="invalid-feedback d-block">{{ form.role.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Permissions</label>
                                    <div class="permissions-container">
                                        <div class="row" id="permissionsList">
                                            <!-- Permissions will be loaded dynamically via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'user:user_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back to List
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>{{ action }} User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
{% if form.instance.pk %}
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="bi bi-key me-2"></i>Change Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="changePasswordForm" method="post" action="{% url 'user:change_password' user.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                        <div class="form-text">Enter the user's current password to verify identity.</div>
                    </div>
                    <div class="mb-3">
                        <label for="new_password1" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password1" name="new_password1" required>
                        <div class="form-text">Enter a strong new password.</div>
                    </div>
                    <div class="mb-3">
                        <label for="new_password2" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="new_password2" name="new_password2" required>
                        <div class="form-text">Confirm the new password.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="resetPasswordForm" method="post" action="{% url 'user:reset_password' user.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will reset the user's password to a temporary password. The user will need to change it on their next login.
                    </div>
                    <div class="mb-3">
                        <label for="admin_password" class="form-label">Your Admin Password</label>
                        <input type="password" class="form-control" id="admin_password" name="admin_password" required>
                        <div class="form-text">Enter your admin password to confirm this action.</div>
                    </div>
                    <div class="mb-3">
                        <label for="temporary_password" class="form-label">Temporary Password</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="temporary_password" name="temporary_password" readonly>
                            <button type="button" class="btn btn-outline-secondary" id="generatePassword">
                                <i class="bi bi-arrow-clockwise"></i> Generate
                            </button>
                        </div>
                        <div class="form-text">This will be the temporary password for the user.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %} 